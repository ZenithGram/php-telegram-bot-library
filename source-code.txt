===
File: src/Utils/LocalFile.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Utils;

class LocalFile
{
    public function __construct(
        private string $path,
    ) {}

    public function getPath(): string
    {
        return $this->path;
    }
}

===
File: src/Utils/AttributesLoader.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Utils;

use ReflectionClass;
use ReflectionMethod;
use Psr\Container\ContainerInterface;
use Psr\SimpleCache\CacheInterface;
use ZenithGram\ZenithGram\Bot;
use ZenithGram\ZenithGram\Exceptions\RouteException;

use ZenithGram\ZenithGram\Attributes\{
    OnCommand, OnBotCommand, OnStart, OnReferral, OnText, OnTextPreg,
    Btn, OnCallback, OnCallbackPreg, OnInline, OnPhoto, OnVideo,
    OnAudio, OnVoice, OnVideoNote, OnDocument, OnSticker,
    OnNewChatMember, OnLeftChatMember, OnEditedMessage, OnMessage,
    OnDefault, OnState
};

class AttributesLoader
{
    private const ATTRIBUTE_MAP = [
        OnStart::class          => 'onStart',
        OnBotCommand::class     => 'onBotCommand',
        OnCommand::class        => 'onCommand',
        OnReferral::class       => 'onReferral',
        OnText::class           => 'onText',
        OnTextPreg::class       => 'onTextPreg',
        Btn::class              => 'btn',
        OnCallback::class       => 'onCallback',
        OnCallbackPreg::class   => 'onCallbackPreg',
        OnInline::class         => 'onInline',
        OnPhoto::class          => 'onPhoto',
        OnVideo::class          => 'onVideo',
        OnAudio::class          => 'onAudio',
        OnVoice::class          => 'onVoice',
        OnVideoNote::class      => 'onVideoNote',
        OnDocument::class       => 'onDocument',
        OnSticker::class        => 'onSticker',
        OnNewChatMember::class  => 'onNewChatMember',
        OnLeftChatMember::class => 'onLeftChatMember',
        OnEditedMessage::class  => 'onEditedMessage',
        OnMessage::class        => 'onMessage',
        OnDefault::class        => 'onDefault',
        OnState::class          => 'onState',
    ];


    private const CACHE_KEY_PREFIX = 'zg_attr_map_v1_';
    private ?CacheInterface $cache;
    private ?ContainerInterface $container;

    public function __construct(private Bot $bot)
    {
        $this->container = $bot->getContainer();
        $this->cache = $bot->getCache();
    }

    public function registerControllers(array $controllers): void
    {
        foreach ($controllers as $controllerClass) {
            $this->processController($controllerClass);
        }
    }

    private function processController(string $className): void
    {
        if (!class_exists($className)) {
            throw new RouteException("–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä '$className' –Ω–µ –Ω–∞–π–¥–µ–Ω.");
        }

        $cacheKey = self::CACHE_KEY_PREFIX . md5($className);
        $routeMap = $this->cache?->get($cacheKey);

        if ($routeMap === null) {
            $routeMap = $this->parseAttributes($className);
            $this->cache?->set($cacheKey, $routeMap, 3600 * 24);
        }

        $instance = $this->resolveController($className);

        foreach ($routeMap as $methodName => $routes) {
            $handler = [$instance, $methodName];
            $routeId = $className . '::' . $methodName;

            foreach ($routes as $route) {
                $botMethod = $route['botMethod'];
                $value = $route['value'];

                $this->bot->$botMethod($routeId, $value)->func($handler);
            }
        }
    }

    private function parseAttributes(string $className): array
    {
        $routeMap = [];
        $reflection = new ReflectionClass($className);

        foreach ($reflection->getMethods(ReflectionMethod::IS_PUBLIC) as $method) {
            $methodName = $method->getName();

            foreach ($method->getAttributes() as $attribute) {
                $attrName = $attribute->getName();

                if (isset(self::ATTRIBUTE_MAP[$attrName])) {
                    $attrInstance = $attribute->newInstance();

                    $routeMap[$methodName][] = [
                        'botMethod' => self::ATTRIBUTE_MAP[$attrName],
                        'value'     => $this->getAttributeValue($attrInstance)
                    ];
                }
            }
        }
        return $routeMap;
    }

    private function resolveController(string $className): object
    {
        if ($this->container && $this->container->has($className)) {
            return $this->container->get($className);
        }
        return new $className();
    }

    private function getAttributeValue(object $attrInstance): mixed
    {
        $vars = get_object_vars($attrInstance);
        return reset($vars);
    }
}

===
File: src/Utils/DependencyResolver.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Utils;

use Psr\Container\ContainerInterface;
use Psr\SimpleCache\CacheInterface;
use ReflectionFunction;
use ReflectionFunctionAbstract;
use ReflectionMethod;
use ReflectionNamedType;
use ZenithGram\ZenithGram\Dto\ChatDto;
use ZenithGram\ZenithGram\Dto\MessageDto;
use ZenithGram\ZenithGram\Dto\UserDto;
use ZenithGram\ZenithGram\UpdateContext;
use ZenithGram\ZenithGram\ZG;

class DependencyResolver
{
    private array $runtimeCache = [];

    public function __construct(
        private ?ContainerInterface $container = null,
        private ?CacheInterface $cache = null
    ) {}

    public function setContainer(ContainerInterface $container): void
    {
        $this->container = $container;
    }

    public function setCache(CacheInterface $cache): void
    {
        $this->cache = $cache;
    }

    public function resolve(callable $handler, ZG $zg, array $routeArgs = []): array
    {
        $parametersMeta = $this->getParametersMetadata($handler);

        $dependencies = [];

        $positionalArgs = array_filter($routeArgs, fn($k) => is_int($k), ARRAY_FILTER_USE_KEY);
        $positionalArgs = array_values($positionalArgs);

        foreach ($parametersMeta as $meta) {
            $name = $meta['name'];
            $typeName = $meta['type'];
            $isBuiltin = $meta['is_builtin'];

            if (array_key_exists($name, $routeArgs)) {
                $dependencies[] = $routeArgs[$name];
                continue;
            }

            if ($typeName) {
                $resolvedSystem = match ($typeName) {
                    ZG::class => $zg,
                    UpdateContext::class => $zg->getContext(),
                    ChatDto::class => $zg->getChat(),
                    UserDto::class => $zg->getUser(),
                    MessageDto::class => $zg->getMessage(),
                    default => null
                };

                if ($resolvedSystem !== null) {
                    $dependencies[] = $resolvedSystem;
                    continue;
                }
            }

            if ($typeName && !$isBuiltin && $this->container && $this->container->has($typeName)) {
                try {
                    $dependencies[] = $this->container->get($typeName);
                    continue;
                } catch (\Throwable $e) {
                }
            }

            if (!empty($positionalArgs)) {
                $dependencies[] = array_shift($positionalArgs);
                continue;
            }

            if ($meta['has_default']) {
                $dependencies[] = $meta['default_value'];
                continue;
            }

            if ($meta['allows_null']) {
                $dependencies[] = null;
                continue;
            }

            $handlerName = is_array($handler) ? get_class($handler[0]) . '::' . $handler[1] : 'Closure';
            throw new \RuntimeException("DependencyResolver: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –∞—Ä–≥—É–º–µ–Ω—Ç–∞ $$name (—Ç–∏–ø: $typeName) –≤ $handlerName");
        }

        return $dependencies;
    }

    private function getParametersMetadata(callable $handler): array
    {
        $key = $this->generateCacheKey($handler);

        if (isset($this->runtimeCache[$key])) {
            return $this->runtimeCache[$key];
        }

        if ($this->cache && $this->cache->has($key)) {
            $meta = $this->cache->get($key);
            $this->runtimeCache[$key] = $meta;
            return $meta;
        }

        $ref = $this->getReflection($handler);
        $params = $ref->getParameters();
        $meta = [];

        foreach ($params as $param) {
            $type = $param->getType();
            $meta[] = [
                'name' => $param->getName(),
                'type' => ($type instanceof ReflectionNamedType) ? $type->getName() : null,
                'is_builtin' => ($type instanceof ReflectionNamedType) && $type->isBuiltin(),
                'allows_null' => $param->allowsNull(),
                'has_default' => $param->isDefaultValueAvailable(),
                'default_value' => $param->isDefaultValueAvailable() ? $param->getDefaultValue() : null,
            ];
        }

        $this->runtimeCache[$key] = $meta;
        if ($this->cache) {
            $this->cache->set($key, $meta, 86400);
        }

        return $meta;
    }

    private function getReflection(callable $handler): ReflectionFunctionAbstract
    {
        if (is_array($handler)) {
            return new ReflectionMethod($handler[0], $handler[1]);
        }
        if (is_object($handler) && !$handler instanceof \Closure) {
            return new ReflectionMethod($handler, '__invoke');
        }
        return new ReflectionFunction($handler);
    }

    private function generateCacheKey(callable $handler): string
    {
        if (is_array($handler)) {
            return 'zg_refl_' . md5(get_class($handler[0]) . '::' . $handler[1]);
        }
        if (is_string($handler)) {
            return 'zg_refl_' . md5($handler);
        }
        if ($handler instanceof \Closure) {
            $ref = new ReflectionFunction($handler);
            return 'zg_refl_' . md5($ref->getFileName() . '::' . $ref->getStartLine());
        }
        return 'zg_refl_' . md5(serialize($handler));
    }

    /** @internal */
    public function getContainer(): ?ContainerInterface
    {
        return $this->container;
    }

    /** @internal  */
    public function getCache(): ?CacheInterface
    {
        return $this->cache;
    }
}

===
File: src/Utils/SimpleFileCache.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Utils;

use Psr\SimpleCache\CacheInterface;

use function Amp\File\write;
use function Amp\File\createDirectoryRecursively;
use function Amp\File\deleteFile;
use function Amp\File\exists;
use function Amp\File\isDirectory;
use function Amp\File\listFiles;
use function Amp\File\read;

class SimpleFileCache implements CacheInterface
{
    private string $cacheDir;

    public function __construct(string $path = 'storage/cache')
    {
        $this->cacheDir = rtrim($path, '/\\');
        if (!isDirectory($this->cacheDir)) {
            createDirectoryRecursively($this->cacheDir, 0775);
        }
    }

    public function get(string $key, mixed $default = null): mixed
    {
        $file = $this->getFilePath($key);
        if (!exists($file)) {
            return $default;
        }

        try {
            $content = read($file);
            if (empty($content)) {
                return $default;
            }

            $data = unserialize($content, ['allowed_classes' => true]);

            if (!is_array($data) || !isset($data['expires'])) {
                $this->delete($key);

                return $default;
            }

            if ($data['expires'] !== null && $data['expires'] < time()) {
                $this->delete($key);

                return $default;
            }

            return $data['data'];

        } catch (\Throwable) {
            return $default;
        }
    }

    public function set(string $key, mixed $value,
        null|int|\DateInterval $ttl = null,
    ): bool {
        $file = $this->getFilePath($key);
        $ttl = is_int($ttl) ? $ttl : 3600;

        $data = [
            'expires' => time() + $ttl,
            'data'    => $value,
        ];

        try {
            $content = serialize($data);
            write($file, $content);

            return true;
        } catch (\Throwable) {
            return false;
        }
    }

    public function delete(string $key): bool
    {
        $file = $this->getFilePath($key);
        if (file_exists($file)) {
            return unlink($file);
        }

        return true;
    }

    public function clear(): bool
    {
        try {
            $files = listFiles($this->cacheDir);
            foreach ($files as $file) {
                $fullPath = $this->cacheDir . DIRECTORY_SEPARATOR . $file;
                if (str_ends_with($file, '.cache')) {
                    deleteFile($fullPath);
                }
            }
            return true;
        } catch (\Throwable) {
            return false;
        }
    }

    public function has(string $key): bool
    {
        return $this->get($key, $this) !== $this;
    }


    public function getMultiple(iterable $keys, mixed $default = null): iterable
    {
        $result = [];
        foreach ($keys as $key) {
            $result[$key] = $this->get($key, $default);
        }

        return $result;
    }

    public function setMultiple(iterable $values,
        null|int|\DateInterval $ttl = null,
    ): bool {
        $success = true;
        foreach ($values as $key => $value) {
            $success = $this->set($key, $value, $ttl) && $success;
        }

        return $success;
    }

    public function deleteMultiple(iterable $keys): bool
    {
        $success = true;
        foreach ($keys as $key) {
            $success = $this->delete($key) && $success;
        }

        return $success;
    }

    private function getFilePath(string $key): string
    {
        return $this->cacheDir . DIRECTORY_SEPARATOR . md5($key) . '.cache';
    }
}

===
File: src/Utils/EnvironmentDetector.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Utils;

/**
 * –ö–ª–∞—Å—Å-—Ö–µ–ª–ø–µ—Ä –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ä–µ–¥—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è PHP.
 *
 * –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± —Ä–∞–∑–ª–∏—á–∞—Ç—å –≤–µ–±-–æ–∫—Ä—É–∂–µ–Ω–∏–µ (–≤–∫–ª—é—á–∞—è FrankenPHP),
 * –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∫–æ–Ω—Å–æ–ª—å (CLI) –∏ –Ω–µ–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Å–æ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ (cron, –¥–µ–º–æ–Ω, embed).
 */
final class EnvironmentDetector
{
    /** @var string –°—Ä–µ–¥–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (Apache, Nginx, FPM, Caddy, FrankenPHP). */
    public const ENV_WEB = 'web';

    /** @var string –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞. */
    public const ENV_CLI_INTERACTIVE = 'cli_interactive';

    /** @var string –ù–µ–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (cron, –¥–µ–º–æ–Ω, –≤—ã–≤–æ–¥ –≤ —Ñ–∞–π–ª, embed –±–µ–∑ –≤–µ–±-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞). */
    public const ENV_CLI_NON_INTERACTIVE = 'cli_non_interactive';

    /**
     * @var string|null –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ä–µ–¥—ã.
     */
    private static ?string $detectedEnvironment = null;

    /**
     * –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∫–ª–∞—Å—Å–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ.
     */
    private function __construct()
    {
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Å—Ä–µ–¥—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
     *
     * @return string –û–¥–Ω–∞ –∏–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç: self::ENV_WEB, self::ENV_CLI_INTERACTIVE, self::ENV_CLI_NON_INTERACTIVE.
     */
    public static function getEnvironment(): string
    {
        if (self::$detectedEnvironment !== null) {
            return self::$detectedEnvironment;
        }

        // –≠—Ç–æ –≤–µ–±-–∫–æ–Ω—Ç–µ–∫—Å—Ç Apache, –∏ Nginx, –∏ FrankenPHP
        if (isset($_SERVER['REQUEST_METHOD']) || isset($_SERVER['SERVER_PROTOCOL']) || PHP_SAPI === 'cli-server') {
            return self::$detectedEnvironment = self::ENV_WEB;
        }

        if (PHP_SAPI === 'cli' || PHP_SAPI === 'phpdbg') {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ª–∏ –∫–æ–Ω—Å–æ–ª—å
            if (defined('STDOUT') && stream_isatty(STDOUT)) {
                return self::$detectedEnvironment = self::ENV_CLI_INTERACTIVE;
            }
        }

        // –°—é–¥–∞ –ø–æ–ø–∞–¥–µ—Ç cron, –¥–µ–º–æ–Ω, –≤—ã–≤–æ–¥ –≤ —Ñ–∞–π–ª, embed –±–µ–∑ –≤–µ–±-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ...
        return self::$detectedEnvironment = self::ENV_CLI_NON_INTERACTIVE;
    }

    /**
     * –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∞—è —Å—Ä–µ–¥–∞ –≤–µ–±-–æ–∫—Ä—É–∂–µ–Ω–∏–µ–º.
     * @return bool
     */
    public static function isWeb(): bool
    {
        return self::getEnvironment() === self::ENV_WEB;
    }

    /**
     * –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∞—è —Å—Ä–µ–¥–∞ –∫–æ–Ω—Å–æ–ª—å—é (–ª—é–±–æ–≥–æ —Ç–∏–ø–∞).
     * @return bool
     */
    public static function isCli(): bool
    {
        $env = self::getEnvironment();
        return $env === self::ENV_CLI_INTERACTIVE || $env === self::ENV_CLI_NON_INTERACTIVE;
    }

    /**
     * –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∞—è —Å—Ä–µ–¥–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–Ω—Å–æ–ª—å—é.
     * @return bool
     */
    public static function isInteractiveCli(): bool
    {
        return self::getEnvironment() === self::ENV_CLI_INTERACTIVE;
    }
}

===
File: src/ApiClient.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram;

use Amp\Http\Client\HttpClient;
use Amp\Http\Client\HttpClientBuilder;
use Amp\Http\Client\Request;
use Amp\Http\Client\Form;
use Amp\File as AmpFile;
use ZenithGram\ZenithGram\Exceptions\NetworkException;
use ZenithGram\ZenithGram\Exceptions\TelegramApiException;
use ZenithGram\ZenithGram\Interfaces\ApiClientInterface;
use ZenithGram\ZenithGram\Utils\LocalFile;

use function Amp\ByteStream\pipe;

class ApiClient implements ApiClientInterface
{

    public const DEFAULT_API_URL = 'https://api.telegram.org';
    private const DEFAULT_TIMEOUT = 10;
    private string $apiUrl;
    private string $apiFileUrl;
    private HttpClient $httpClient;
    private string $token;

    public function __construct(string $token, string $baseUrl = self::DEFAULT_API_URL)
    {
        $baseUrl = rtrim($baseUrl, '/');
        $this->apiUrl = $baseUrl . '/bot' . $token . '/';
        $this->apiFileUrl = $baseUrl . '/file/bot' . $token . '/';
        $this->httpClient = HttpClientBuilder::buildDefault();
        $this->token = $token;
    }

    /**
     * @inheritDoc
     * @throws \Amp\ByteStream\StreamException
     * @throws \Amp\Http\Client\HttpException
     * @throws \JsonException
     * @throws \ZenithGram\ZenithGram\Exceptions\TelegramApiException|\ZenithGram\ZenithGram\Exceptions\NetworkException
     */
    public function callAPI(string $method, array $params = [], int $timeout = self::DEFAULT_TIMEOUT): array
    {
        $url = $this->apiUrl . $method;
        $body = new Form();

        if ($params) {
            foreach ($params as $key => $value) {
                if ($value instanceof LocalFile) {
                    $body->addFile($key, $value->getPath());
                } elseif (is_array($value)) {
                    $body->addField($key, json_encode($value, JSON_THROW_ON_ERROR));
                } else {
                    $body->addField($key, (string)$value);
                }
            }
        }

        $request = new Request($url, 'POST');
        $request->setBody($body);

        $request->setInactivityTimeout($timeout);
        $request->setTransferTimeout($timeout);

        $request->setTcpConnectTimeout(10);
        $request->setTlsHandshakeTimeout(10);

        try {
            $response = $this->httpClient->request($request);
        } catch (HttpException $e) {
            throw new NetworkException("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Telegram API: " . $e->getMessage(), 0, $e);
        }

        $responseJson = $response->getBody()->read();

        try {
            $responseArray = json_decode($responseJson, true, 512, JSON_THROW_ON_ERROR);
        } catch (\JsonException $e) {
            throw new TelegramApiException("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –æ—Ç–≤–µ—Ç –æ—Ç Telegram: " . $e->getMessage());
        }

        if ($response->getStatus() === 200 && ($responseArray['ok'] ?? false)) {
            return $responseArray;
        }

        $errorMsg = sprintf(
            "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ [%s]: %s",
            $responseArray['error_code'] ?? 'Unknown',
            $responseArray['description'] ?? 'No description'
        );

        throw new TelegramApiException($errorMsg . "\n" . $this->formatParamsArray($params), (int)$responseArray['error_code'], $params);
    }

    /**
     * @inheritDoc
     * @throws \Amp\File\FilesystemException
     * @throws \Amp\Http\Client\HttpException
     * @throws \ZenithGram\ZenithGram\Exceptions\TelegramApiException
     * @internal
     */
    public function downloadFile(string $url, string $destinationPath): void
    {
        $request = new Request($url, 'GET');
        $request->setTransferTimeout(300);
        $request->setInactivityTimeout(60);

        $response = $this->httpClient->request($request);

        if ($response->getStatus() !== 200) {
            throw new TelegramApiException("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª. HTTP –∫–æ–¥: " . $response->getStatus());
        }

        $file = AmpFile\openFile($destinationPath, 'w');

        try {
            pipe($response->getBody(), $file);
        } finally {
            $file->close();
        }
    }

    /** @internal  */
    public function getApiUrl(): string { return $this->apiUrl; }
    /** @internal  */
    public function getApiFileUrl(): string { return $this->apiFileUrl; }
    /** @internal  */
    public function getToken(): string { return $this->token; }

    private function formatParamsArray(array $array, int $indent = 0): string
    {
        $space = str_repeat("‚Äá", $indent * 2); // —Å–∏–º–≤–æ–ª "‚Äá" (U+2007, Figure Space)
        $result = "Array (\n";

        foreach ($array as $key => $value) {
            if (is_string($value) && ($decoded = json_decode($value, true)) !== null) {
                $value = $decoded;
            }

            if (is_object($value)) {
                $result .= $space . "‚Äá‚Äá[$key] => " . $this->formatParamsArray((array) $value, $indent + 1);
            }

            if (is_array($value)) {
                $result .= $space . "‚Äá‚Äá[$key] => " . $this->formatParamsArray($value, $indent + 1);
            } else {
                $result .= $space . "‚Äá‚Äá[$key] => " . ($value ?: 'null') . "\n";
            }
        }
        return $result . $space . ")\n";
    }

}



===
File: src/Interfaces/ApiClientInterface.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Interfaces;

interface ApiClientInterface
{

    /**
     * @param string $method  –ú–µ—Ç–æ–¥ API
     * @param array  $params  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
     * @param int    $timeout –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ç–∞–π–º–∞—É—Ç <br> –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10.
     *
     * @return array
     */
    public function callAPI(string $method, array $params = [],
        int $timeout = 10,
    ): array;

    /**
     * @param string $url
     * @param string $destinationPath
     *
     * @return void
     */
    public function downloadFile(string $url, string $destinationPath): void;

    /**
     * @internal
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω
     */
    public function getToken(): string;

    /**
     * @internal
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ </br>
     * –ü—Ä: https://api.telegram.org/file/bot/{TOKEN}/
     */
    public function getApiFileUrl(): string;
}


===
File: src/Interfaces/StorageInterface.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Storage;

interface StorageInterface
{
    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     *
     * @param int|string $user_id ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     *
     * @return string|null
     *
     * @see https://zenithgram.github.io/classes/storage#%D0%BC%D0%B5%D1%82%D0%BE%D0%B4%D1%8B-%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B8%D1%81%D0%B0
     */
    public function getState(int|string $user_id): ?string;

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     *
     * @param int|string $user_id ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     * @param string     $state   –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (—à–∞–≥–∞)
     *
     * @return void
     *
     * @throws \JsonException
     * @see https://zenithgram.github.io/classes/storage#%D0%BC%D0%B5%D1%82%D0%BE%D0%B4%D1%8B-%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B8%D1%81%D0%B0
     */
    public function setState(int|string $user_id, string $state): void;

    /**
     * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤—ã—Ö–æ–¥ –∏–∑ –¥–∏–∞–ª–æ–≥–∞)
     *
     * @param int|string $user_id ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     *
     * @return void
     *
     * @throws \JsonException
     * @see https://zenithgram.github.io/classes/storage#%D0%BC%D0%B5%D1%82%D0%BE%D0%B4%D1%8B-%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B8%D1%81%D0%B0
     */
    public function clearState(int|string $user_id): void;

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     *
     * @param int|string $user_id ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     *
     * @return array
     *
     * @see https://zenithgram.github.io/classes/storage#%D0%BC%D0%B5%D1%82%D0%BE%D0%B4%D1%8B-%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B8%D1%81%D0%B0
     */
    public function getSessionData(int|string $user_id): array;

    /**
     * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ–ø–æ–ª–Ω—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ)
     *
     * @param int|string $user_id ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     * @param array $data   –ú–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
     *
     * @return void
     *
     * @see https://zenithgram.github.io/classes/storage#%D0%BC%D0%B5%D1%82%D0%BE%D0%B4%D1%8B-%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B8%D1%81%D0%B0
     */
    public function setSessionData(int|string $user_id, array $data): void;

    /**
     * –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     *
     * @param int|string $user_id
     *
     * @return void
     *
     * @see https://zenithgram.github.io/classes/storage#%D0%BC%D0%B5%D1%82%D0%BE%D0%B4%D1%8B-%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B8%D1%81%D0%B0
     */

    public function clearSessionData(int|string $user_id): void;
}

===
File: src/Button.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram;

class Button
{
    /**
     * Inline –∫–Ω–æ–ø–∫–∞ —Å Callback Data
     *
     * @var string $text –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
     * @var string $data CallbackData
     *
     * @return array
     *
     * @see https://zenithgram.github.io/classes/button#cb
     */
    public static function cb(string $text, string $data): array
    {
        return ['text' => $text, 'callback_data' => $data];
    }

    /**
     * Inline –∫–Ω–æ–ø–∫–∞-—Å—Å—ã–ª–∫–∞
     *
     * @var string $text –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
     * @var string $url  –°—Å—ã–ª–∫–∞
     *
     * @return array
     *
     * @see https://zenithgram.github.io/classes/button#url
     */
    public static function url(string $text, string $url): array
    {
        return ['text' => $text, 'url' => $url];
    }

    /**
     * Inline –∫–Ω–æ–ø–∫–∞ –¥–ª—è WebApp
     *
     * @var string $text –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
     * @var string $url  –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
     *
     * @return array
     *
     * @see https://zenithgram.github.io/classes/button#webApp
     */
    public static function webApp(string $text, string $url): array
    {
        return ['text' => $text, 'web_app' => ['url' => $url]];
    }

    /**
     * –¢–µ–∫—Å—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ (–¥–ª—è Reply)
     *
     * @var string $text –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
     *
     * @return array
     *
     * @see https://zenithgram.github.io/classes/button#text
     */
    public static function text(string $text): array
    {
        return ['text' => $text];
    }

    /**
     * –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞
     *
     * @var string $text –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
     *
     * @return array
     *
     * @see https://zenithgram.github.io/classes/button#contact
     */
    public static function contact(string $text): array
    {
        return ['text' => $text, 'request_contact' => true];
    }

    /**
     * –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
     *
     * @var string $text –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
     *
     * @return array
     *
     * @see https://zenithgram.github.io/classes/button#location
     */
    public static function location(string $text): array
    {
        return ['text' => $text, 'request_location' => true];
    }
}

===
File: src/Inline.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram;

use ZenithGram\ZenithGram\Enums\MessageParseMode;
use ZenithGram\ZenithGram\Enums\InlineType;

class Inline
{
    //    private const VIDEO_SIZE_LIMIT = 20971520; // 20 MB
    //    private const AUDIO_SIZE_LIMIT = 20971520; // 20 MB
    //    private const GIF_SIZE_LIMIT   = 20971520; // 20 MB
    //    private const PHOTO_SIZE_LIMIT = 5242880;  // 5 MB

    private string $type;
    private string $parse_mode = '';
    private string $id = '';
    private string $title = '';
    private string $description = '';
    private string $message_text = '';
    private array $kbd = [];
    private array $params_additionally = [];
    private string $fileUrl = '';
    private string $fileId = '';
    private string $thumbUrl = '';
    private string $mimeType = '';
    private float $latitude = 0;
    private float $longitude = 0;
    private string $address = '';

    public function __construct(InlineType $type = InlineType::Article)
    {
        $this->type = $type->value;
    }

    /**
     * –ó–∞–¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
     *
     * @param string $id
     *
     * @return Inline
     *
     * @see https://zenithgram.github.io/classes/inlineMethods/id
     */
    public function id(string $id): self
    {
        $this->id = $id;

        return $this;
    }

    /**
     * –ó–∞–¥–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫
     *
     * @param string $title
     *
     * @return Inline
     *
     * @see https://zenithgram.github.io/classes/inlineMethods/title
     */
    public function title(string $title): self
    {
        $this->title = $title;

        return $this;
    }

    /**
     * –ó–∞–¥–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ
     *
     * @param string $description
     *
     * @return Inline
     *
     * @see https://zenithgram.github.io/classes/inlineMethods/description
     */
    public function description(string $description): self
    {
        $this->description = $description;

        return $this;
    }

    /**
     * –ó–∞–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
     *
     * @param string $text
     *
     * @return Inline
     *
     * @see https://zenithgram.github.io/classes/inlineMethods/text
     */
    public function text(string $text): self
    {
        $this->message_text = $text;

        return $this;
    }

    /**
     * –ó–∞–¥–∞–µ—Ç URL –º–µ–¥–∏–∞-—Ñ–∞–π–ª–∞
     *
     * @param string $url
     *
     * @return Inline
     *
     * @see https://zenithgram.github.io/classes/inlineMethods/fileUrl
     */
    public function fileUrl(string $url = ''): self
    {
        $this->fileUrl = $url;

        return $this;
    }

    /**
     * –ó–∞–¥–∞–µ—Ç ID –º–µ–¥–∏–∞-—Ñ–∞–π–ª–∞
     *
     * @param string $id
     *
     * @return Inline
     *
     * @see https://zenithgram.github.io/classes/inlineMethods/fileId
     */
    public function fileId(string $id = ''): self
    {
        $this->fileId = $id;

        return $this;
    }

    /**
     * –ó–∞–¥–∞–µ—Ç MIME-—Ç–∏–ø –º–µ–¥–∏–∞-—Ñ–∞–π–ª–∞
     *
     * @param string $mime
     *
     * @return Inline
     *
     * @see https://zenithgram.github.io/classes/inlineMethods/mimeType
     */
    public function mimeType(string $mime): self
    {
        $this->mimeType = $mime;

        return $this;
    }

    /**
     * –ó–∞–¥–∞–µ—Ç URL –º–∏–Ω–∏–∞—Ç—é—Ä—ã
     *
     * @param string $url
     *
     * @return Inline
     *
     * @see https://zenithgram.github.io/classes/inlineMethods/thumb
     */
    public function thumb(string $url = ''): self
    {
        $this->thumbUrl = $url;

        return $this;
    }

    /**
     * –ó–∞–¥–∞–µ—Ç inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
     *
     * @param array $buttons
     *
     * @return Inline
     *
     * @see https://zenithgram.github.io/classes/inlineMethods/kbd
     */
    public function kbd(array $buttons = []): self
    {
        $this->kbd = ['inline_keyboard' => $buttons];

        return $this;
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
     *
     * @param array $params
     *
     * @return Inline
     *
     * @see https://zenithgram.github.io/classes/inlineMethods/params
     */
    public function params(array $params = []): self
    {
        $this->params_additionally = $params;

        return $this;
    }

    /**
     * –ó–∞–¥–∞–µ—Ç —Ä–µ–∂–∏–º –ø–∞—Ä—Å–∏–Ω–≥–∞
     *
     * @param MessageParseMode $mode
     *
     * @return Inline
     *
     * @see https://zenithgram.github.io/classes/inlineMethods/parseMode
     */
    public function parseMode(MessageParseMode $mode): self
    {
        $this->parse_mode = $mode->value;

        return $this;
    }

    /**
     * –ó–∞–¥–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
     *
     * @param float $latitude
     * @param float $longitude
     *
     * @return Inline
     *
     * @see https://zenithgram.github.io/classes/inlineMethods/coordinates
     */
    public function coordinates(float $latitude, float $longitude): self
    {
        $this->latitude = $latitude;
        $this->longitude = $longitude;

        return $this;
    }

    /**
     * –ó–∞–¥–∞–µ—Ç –∞–¥—Ä–µ—Å
     *
     * @param string $address
     *
     * @return Inline
     *
     * @see https://zenithgram.github.io/classes/inlineMethods/address
     */
    public function address(string $address): self
    {
        $this->address = $address;

        return $this;
    }

    /**
     * –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–∏–Ω –º–∞—Å—Å–∏–≤
     *
     * @return array
     *
     * @see https://zenithgram.github.io/classes/inlineMethods/create
     */
    public function create(): array
    {
        return match ($this->type) {
            'article'    => $this->createArticle(),
            'photo'      => $this->createPhoto(),
            'gif'        => $this->createGif(),
            'mpeg4_gif'  => $this->createMpeg4Gif(),
            'audio'      => $this->createAudio(),
            'video'      => $this->createVideo(),
            'voice'      => $this->createVoice(),
            'document'   => $this->createDocument(),
            'location'   => $this->createLocation(),
            'venue'      => $this->createVenue(),
        };
    }

    private function createParams(): array
    {
        return [
            'type'  => $this->type,
            'id'    => $this->id,
            'title' => $this->title,
        ];
    }

    private function addKbdInParams(&$params): void
    {
        if (!empty($this->kbd)) {
            $params['reply_markup'] = $this->kbd;
        }
    }

    private function createArticle(): array
    {
        $message = [
            'message_text' => $this->message_text,
            'parse_mode'   => $this->parse_mode,
        ];

        $message += $this->params_additionally;

        $params = $this->createParams();

        $params += [
            'description'           => $this->description,
            'input_message_content' => $message,
        ];

        if (!empty($this->thumbUrl)) {
            $params['thumb_url'] = $this->thumbUrl;
        }

        $this->addKbdInParams($params);

        return $params;
    }

    private function createPhoto(): array
    {
        $params = $this->createParams();

        $params += [
            'description'   => $this->description,
            'caption'       => $this->message_text,
            'thumbnail_url' => empty($this->thumbUrl) ? $this->fileUrl
                : $this->thumbUrl,
            'parse_mode'    => $this->parse_mode,
        ];

        if (!empty($this->fileUrl)) {
            $params['photo_url'] = $this->fileUrl;
        } else {
            $params['photo_file_id'] = $this->fileId;
        }

        $this->addKbdInParams($params);

        return $params + $this->params_additionally;
    }

    private function createGif(): array
    {
        $params = $this->createParams();

        $params += [
            'description'   => $this->description,
            'caption'       => $this->message_text,
            'thumbnail_url' => empty($this->thumbUrl) ? $this->fileUrl
                : $this->thumbUrl,
            'parse_mode'    => $this->parse_mode,
        ];

        if (!empty($this->fileUrl)) {
            $params['gif_url'] = $this->fileUrl;
        } else {
            $params['gif_file_id'] = $this->fileId;
        }

        $this->addKbdInParams($params);

        return $params + $this->params_additionally;
    }

    private function createMpeg4Gif(): array
    {
        $params = $this->createParams();

        $params += [
            'description'   => $this->description,
            'caption'       => $this->message_text,
            'thumbnail_url' => empty($this->thumbUrl) ? $this->fileUrl
                : $this->thumbUrl,
            'parse_mode'    => $this->parse_mode,
        ];

        if (!empty($this->fileUrl)) {
            $params['mpeg4_url'] = $this->fileUrl;
        } else {
            $params['mpeg4_file_id'] = $this->fileId;
        }

        $this->addKbdInParams($params);

        return $params + $this->params_additionally;
    }

    private function createVideo(): array
    {
        $params = $this->createParams();

        $params += [
            'description' => $this->description,
            'caption'     => $this->message_text,
            'mime_type'   => $this->mimeType === '' ? 'video/mp4'
                : $this->mimeType,
            'parse_mode'  => $this->parse_mode,
        ];

        if (!empty($this->fileUrl)) {
            $params['video_url'] = $this->fileUrl;
        } else {
            $params['video_file_id'] = $this->fileId;
        }

        $this->addKbdInParams($params);

        if (!empty($this->thumbUrl)) {
            $params['thumbnail_url'] = $this->thumbUrl;
        }

        return $params + $this->params_additionally;
    }

    private function createDocument(): array
    {
        $params = $this->createParams();

        $params += [
            'description' => $this->description,
            'caption'     => $this->message_text,
            'mime_type'   => $this->mimeType,
            'parse_mode'  => $this->parse_mode,
        ];

        if (!empty($this->fileUrl)) {
            $params['document_url'] = $this->fileUrl;
        } else {
            $params['document_file_id'] = $this->fileId;
        }

        $this->addKbdInParams($params);

        if (!empty($this->thumbUrl)) {
            $params['thumbnail_url'] = $this->thumbUrl;
        }

        return $params + $this->params_additionally;
    }

    private function createAudio(): array
    {
        $params = $this->createParams();

        $params += [
            'caption'    => $this->message_text,
            'parse_mode' => $this->parse_mode,
        ];

        if (!empty($this->fileUrl)) {
            $params['audio_url'] = $this->fileUrl;
        } else {
            $params['audio_file_id'] = $this->fileId;
        }

        $this->addKbdInParams($params);

        return $params + $this->params_additionally;
    }

    private function createVoice(): array
    {
        $params = $this->createParams();

        $params += [
            'caption'    => $this->message_text,
            'parse_mode' => $this->parse_mode,
        ];

        if (!empty($this->fileUrl)) {
            $params['voice_url'] = $this->fileUrl;
        } else {
            $params['voice_file_id'] = $this->fileId;
        }

        $this->addKbdInParams($params);

        return $params + $this->params_additionally;
    }

    private function createLocation(): array
    {
        $params = $this->createParams();

        $params += [
            'latitude'  => $this->latitude,
            'longitude' => $this->longitude,
        ];

        $this->addKbdInParams($params);

        if (!empty($this->thumbUrl)) {
            $params['thumbnail_url'] = $this->thumbUrl;
        }

        return $params + $this->params_additionally;
    }

    private function createVenue(): array
    {
        $params = $this->createParams();

        $params += [
            'latitude'  => $this->latitude,
            'longitude' => $this->longitude,
            'address'   => $this->address,
        ];

        $this->addKbdInParams($params);

        if (!empty($this->thumbUrl)) {
            $params['thumbnail_url'] = $this->thumbUrl;
        }

        return $params + $this->params_additionally;
    }

}

===
File: src/Enums/PaginationNumberStyle.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Enums;

enum PaginationNumberStyle: int
{
    /**
     * 1, 2, 3, ...
     */
    case CLASSIC = 0;

    /**
     * 1Ô∏è‚É£, 2Ô∏è‚É£, 3Ô∏è‚É£, ...
     */
    case EMOJI = 1;
}

===
File: src/Enums/MessageParseMode.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Enums;

enum MessageParseMode: string
{
    case HTML = 'HTML';
    case Markdown = 'Markdown';
    case MarkdownV2 = 'MarkdownV2';
    case None = '';
}

===
File: src/Enums/ChatAction.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Enums;

enum ChatAction: string
{
    /**
     * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç: "–ø–µ—á–∞—Ç–∞–µ—Ç..."
     */
    case Typing = 'typing';

    /**
     * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç: "–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ..."
     */
    case UploadPhoto = 'upload_photo';

    /**
     * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç: "–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∏–¥–µ–æ..."
     */
    case UploadVideo = 'upload_video';

    /**
     * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç: "–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤–∏–¥–µ–æ..."
     */
    case RecordVideo = 'record_video';

    /**
     * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç: "–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ..."
     */
    case RecordVoice = 'record_voice';

    /**
     * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç: "–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ..."
     */
    case UploadVoice = 'upload_voice';

    /**
     * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç: "–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª..."
     */
    case UploadDocument = 'upload_document';

    /**
     * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç: "–≤—ã–±–∏—Ä–∞–µ—Ç —Å—Ç–∏–∫–µ—Ä..."
     */
    case ChooseSticker = 'choose_sticker';

    /**
     * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç: "–≤—ã–±–∏—Ä–∞–µ—Ç –ª–æ–∫–∞—Ü–∏—é..."
     */
    case FindLocation = 'find_location';

    /**
     * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç: "–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ..."
     */
    case RecordVideoNote = 'record_video_note';

    /**
     * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç: "–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ..."
     */
    case UploadVideoNote = 'upload_video_note';
}

===
File: src/Enums/UpdateType.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Enums;

enum UpdateType: string
{
    /** –ù–æ–≤–æ–µ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª—é–±–æ–≥–æ —Ç–∏–ø–∞ ‚Äî —Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ, —Å—Ç–∏–∫–µ—Ä –∏ —Ç.–¥. */
    case Message = 'message';

    /** –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –∏–∑–≤–µ—Å—Ç–Ω–æ –±–æ—Ç—É –∏ –±—ã–ª–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ */
    case EditedMessage = 'edited_message';

    /** –ù–æ–≤—ã–π –≤—Ö–æ–¥—è—â–∏–π –ø–æ—Å—Ç –≤ –∫–∞–Ω–∞–ª–µ –ª—é–±–æ–≥–æ —Ç–∏–ø–∞ ‚Äî —Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ, —Å—Ç–∏–∫–µ—Ä –∏ —Ç.–¥. */
    case ChannelPost = 'channel_post';

    /** –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø–æ—Å—Ç–∞ –≤ –∫–∞–Ω–∞–ª–µ, –∫–æ—Ç–æ—Ä—ã–π –∏–∑–≤–µ—Å—Ç–µ–Ω –±–æ—Ç—É –∏ –±—ã–ª –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω */
    case EditedChannelPost = 'edited_channel_post';

    /** –ù–æ–≤—ã–π –≤—Ö–æ–¥—è—â–∏–π inline-–∑–∞–ø—Ä–æ—Å */
    case InlineQuery = 'inline_query';

    /** –†–µ–∑—É–ª—å—Ç–∞—Ç inline-–∑–∞–ø—Ä–æ—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –≤—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É */
    case ChosenInlineResult = 'chosen_inline_result';

    /** –ù–æ–≤—ã–π –≤—Ö–æ–¥—è—â–∏–π callback-–∑–∞–ø—Ä–æ—Å */
    case CallbackQuery = 'callback_query';

    /** –ù–æ–≤—ã–π –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É. –¢–æ–ª—å–∫–æ –¥–ª—è —Å—á–µ—Ç–æ–≤ —Å –≥–∏–±–∫–æ–π —Ü–µ–Ω–æ–π */
    case ShippingQuery = 'shipping_query';

    /** –ù–æ–≤—ã–π –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É (pre-checkout). –°–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ */
    case PreCheckoutQuery = 'pre_checkout_query';

    /** –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–ø—Ä–æ—Å–∞. –ë–æ—Ç—ã –ø–æ–ª—É—á–∞—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –æ–± –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –æ–ø—Ä–æ—Å–∞—Ö –∏ –æ–ø—Ä–æ—Å–∞—Ö, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–∞–º–∏–º –±–æ—Ç–æ–º */
    case Poll = 'poll';

    /** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–∏–ª —Å–≤–æ–π –æ—Ç–≤–µ—Ç –≤ –Ω–µ–∞–Ω–æ–Ω–∏–º–Ω–æ–º –æ–ø—Ä–æ—Å–µ. –ë–æ—Ç—ã –ø–æ–ª—É—á–∞—é—Ç –Ω–æ–≤—ã–µ –≥–æ–ª–æ—Å–∞ —Ç–æ–ª—å–∫–æ –≤ –æ–ø—Ä–æ—Å–∞—Ö, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–∞–º–∏–º –±–æ—Ç–æ–º */
    case PollAnswer = 'poll_answer';

    /** –°—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–∏—è –±–æ—Ç–∞ –≤ —á–∞—Ç–µ –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω. –î–ª—è –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤ —ç—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –±–æ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º */
    case MyChatMember = 'my_chat_member';

    /** –°—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ —á–∞—Ç–∞ –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≤ —á–∞—Ç–µ –∏ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å "chat_member" –≤ —Å–ø–∏—Å–∫–µ allowed_updates */
    case ChatMember = 'chat_member';

    /** –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ —á–∞—Ç. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ can_invite_users */
    case ChatJoinRequest = 'chat_join_request';

    /** –í —á–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω –±—É—Å—Ç (Chat Boost) */
    case ChatBoost = 'chat_boost';

    /** –ò–∑ —á–∞—Ç–∞ —É–¥–∞–ª–µ–Ω –±—É—Å—Ç */
    case RemovedChatBoost = 'removed_chat_boost';
}

===
File: src/Enums/PaginationLayout.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Enums;

enum PaginationLayout: int
{
    /**
     * –í—Å–µ 4 –∫–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setNavigationLayout#–≤–æ–∑–º–æ–∂–Ω—ã–µ-–∑–Ω–∞—á–µ–Ω–∏—è-–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
     *
     */
    case ROW = 0;

    /**
     * –ö–Ω–æ–ø–∫–∏ "–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞" –∏ "–°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞" –±—É–¥—É—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –Ω–∞
     * –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
     *
     * –ö–Ω–æ–ø–∫–∏ "–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞" –∏ "–ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞" –±—É–¥—É—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –Ω–∞
     * –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setNavigationLayout#–≤–æ–∑–º–æ–∂–Ω—ã–µ-–∑–Ω–∞—á–µ–Ω–∏—è-–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
     *
     */
    case SPLIT = 1;

    /**
     * –ö–Ω–æ–ø–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –±—É–¥—É—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏,
     * —á—Ç–æ –∏—Ö 2
     *
     * –ò–Ω–∞—á–µ –±—É–¥—É—Ç –Ω–∞ —Ä–∞–∑–Ω—ã—Ö
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setNavigationLayout#–≤–æ–∑–º–æ–∂–Ω—ã–µ-–∑–Ω–∞—á–µ–Ω–∏—è-–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
     *
     */
    case SMART = 2;
}

===
File: src/Enums/MessageDice.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Enums;

enum MessageDice: string
{
    /**
     * –ö—É–±–∏–∫ (–ó–Ω–∞—á–µ–Ω–∏—è: 1-6)
     */
    case Dice = 'üé≤';

    /**
     * –î–∞—Ä—Ç—Å (–ó–Ω–∞—á–µ–Ω–∏—è: 1-6)
     */
    case Darts = 'üéØ';

    /**
     * –ë–∞—Å–∫–µ—Ç–±–æ–ª (–ó–Ω–∞—á–µ–Ω–∏—è: 1-5)
     */
    case Basketball = 'üèÄ';

    /**
     * –§—É—Ç–±–æ–ª (–ó–Ω–∞—á–µ–Ω–∏—è: 1-5)
     */
    case Football = '‚öΩ';

    /**
     * –ë–æ—É–ª–∏–Ω–≥ (–ó–Ω–∞—á–µ–Ω–∏—è: 1-6)
     */
    case Bowling = 'üé≥';

    /**
     * –ö–∞–∑–∏–Ω–æ (–ó–Ω–∞—á–µ–Ω–∏—è: 1-64)
     */
    case Casino = 'üé∞';
}

===
File: src/Enums/PaginationMode.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Enums;

enum PaginationMode: int
{
    /**
     * –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ "–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞" –∏ "–°–ª–µ–¥—É—é—â–∞—è
     * —Å—Ç—Ä–∞–Ω–∏—Ü–∞"
     */
    case ARROWS = 0;    // < >

    /**
     * –ù–µ—Å–∫–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü –Ω–∞ —Å—Ç—Ä–æ–∫–µ
     */
    case NUMBERS = 1;   // 1 2 3
}

===
File: src/Enums/InlineType.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Enums;

enum InlineType: string
{
    /** –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç, —Å—Ç–∞—Ç—å—è –∏–ª–∏ —Å—Å—ã–ª–∫–∞ */
    case Article = 'article';

    /** –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã) */
    case Location = 'location';

    /** –ê–Ω–∏–º–∞—Ü–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ MP4 (–±–µ–∑ –∑–≤—É–∫–∞) */
    case Mpeg4Gif = 'mpeg4_gif';

    /** –ú–µ—Å—Ç–æ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã + –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å) */
    case Venue = 'venue';

    /** –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è */
    case Photo = 'photo';

    /** GIF-–∞–Ω–∏–º–∞—Ü–∏—è */
    case Gif = 'gif';

    /** –í–∏–¥–µ–æ—Ñ–∞–π–ª */
    case Video = 'video';

    /** –ê—É–¥–∏–æ—Ñ–∞–π–ª (–º—É–∑—ã–∫–∞) */
    case Audio = 'audio';

    /** –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */
    case Voice = 'voice';

    /** –î–æ–∫—É–º–µ–Ω—Ç –∏–ª–∏ –ª—é–±–æ–π —Ñ–∞–π–ª */
    case Document = 'document';
}

===
File: src/Attributes/OnVoice.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnVoice
{
    public function __construct() {}
}

===
File: src/Attributes/OnText.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.
 *
 * @param string|array $text –¢–µ–∫—Å—Ç –¥–ª—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnText
{
    public function __construct(
        public string|array $text
    ) {}
}

===
File: src/Attributes/OnMessage.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (message fallback).
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnMessage
{
    public function __construct() {}
}

===
File: src/Attributes/OnVideo.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å –≤–∏–¥–µ–æ.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnVideo
{
    public function __construct() {}
}

===
File: src/Attributes/Btn.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏.
 *
 * @param string $id –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–Ω–æ–ø–∫–∏.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class Btn
{
    public function __construct(
        public string $id
    ) {}
}

===
File: src/Attributes/OnAudio.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∞—É–¥–∏–æ.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnAudio
{
    public function __construct() {}
}

===
File: src/Attributes/OnState.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (—à–∞–≥–∞ –¥–∏–∞–ª–æ–≥–∞).
 *
 * @param string $name –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'ask_age').
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnState
{
    public function __construct(
        public string $name
    ) {}
}

===
File: src/Attributes/OnDefault.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–æ–±—â–∏–π fallback).
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnDefault
{
    public function __construct() {}
}

===
File: src/Attributes/OnCallbackPreg.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è callback-–∑–∞–ø—Ä–æ—Å–∞ –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º—É –≤—ã—Ä–∞–∂–µ–Ω–∏—é.
 *
 * @param string|array $pattern –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è CallbackData.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnCallbackPreg
{
    public function __construct(
        public string|array $pattern
    ) {}
}

===
File: src/Attributes/OnBotCommand.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '/start').
 *
 * @param string|array $command –¢–µ–∫—Å—Ç –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnBotCommand
{
    public function __construct(
        public string|array $command
    ) {}
}

===
File: src/Attributes/OnNewChatMember.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ(—ã—Ö) —É—á–∞—Å—Ç–Ω–∏–∫–∞(–æ–≤) —á–∞—Ç–∞.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnNewChatMember
{
    public function __construct() {}
}

===
File: src/Attributes/OnStart.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /start.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnStart
{
    public function __construct() {}
}

===
File: src/Attributes/OnDocument.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnDocument
{
    public function __construct() {}
}

===
File: src/Attributes/OnSticker.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∏–∫–µ—Ä–æ–≤.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnSticker
{
    public function __construct() {}
}

===
File: src/Attributes/OnVideoNote.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö –≤–∏–¥–µ–æ-—Å–æ–æ–±—â–µ–Ω–∏–π (–∫—Ä—É–∂–æ—á–∫–æ–≤).
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnVideoNote
{
    public function __construct() {}
}

===
File: src/Attributes/OnReferral.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnReferral
{
    public function __construct() {}
}

===
File: src/Attributes/OnCommand.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –∫–æ–º–∞–Ω–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, '!start').
 *
 * @param string|array $command –¢–µ–∫—Å—Ç –∫–æ–º–∞–Ω–¥—ã.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnCommand
{
    public function __construct(
        public string|array $command
    ) {}
}

===
File: src/Attributes/OnPhoto.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ñ–æ—Ç–æ.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnPhoto
{
    public function __construct() {}
}

===
File: src/Attributes/OnInline.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è inline-–∑–∞–ø—Ä–æ—Å–∞.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnInline
{
    public function __construct() {}
}

===
File: src/Attributes/OnCallback.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è callback-–∑–∞–ø—Ä–æ—Å–∞.
 *
 * @param string|array $data –î–∞–Ω–Ω—ã–µ –∏–∑ callback-–∫–Ω–æ–ø–∫–∏.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnCallback
{
    public function __construct(
        public string|array $data
    ) {}
}

===
File: src/Attributes/OnLeftChatMember.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –≤—ã—à–µ–¥—à–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —á–∞—Ç–∞.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnLeftChatMember
{
    public function __construct() {}
}

===
File: src/Attributes/OnTextPreg.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º—É –≤—ã—Ä–∞–∂–µ–Ω–∏—é.
 *
 * @param string|array $pattern –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnTextPreg
{
    public function __construct(
        public string|array $pattern
    ) {}
}

===
File: src/Attributes/OnEditedMessage.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Attributes;

use Attribute;

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è.
 */
#[Attribute(Attribute::TARGET_METHOD)]
class OnEditedMessage
{
    public function __construct() {}
}

===
File: src/MessageBuilderTrait.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram;

use ZenithGram\ZenithGram\Enums\MessageDice;
use ZenithGram\ZenithGram\Enums\MessageParseMode;
use ZenithGram\ZenithGram\Utils\LocalFile;

use function Amp\File\exists;

trait MessageBuilderTrait
{
    protected array $mediaQueue = [];
    protected bool $sendDice = false;
    protected bool $sendSticker = false;
    protected string $mediaPreviewUrl = '';
    protected array $messageData
        = [
            'text'                => '',
            'reply_markup'        => '',
            'parse_mode'          => MessageParseMode::None->value,
            'reply_to_message_id' => '',
            'entities'            => '',
            'emoji'               => '',
            'sticker'             => '',
        ];

    protected array $reply_markup_raw = [];
    protected array $additionally_params = [];

    /**
     * –ó–∞–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –æ—Ç–≤–µ—Ç
     *
     * @param string $text –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/messageMethods/text
     */
    public function text(string $text = ''): self
    {
        $this->messageData['text'] = $text;

        return $this;
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫ —Å–æ–æ–±—â–µ–Ω–∏—é.
     *
     * @param array $params –ú–∞—Å—Å–∏–≤ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/messageMethods/params
     */
    public function params(array $params): self
    {
        $this->additionally_params = array_merge(
            $this->additionally_params, $params,
        );

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–µ–∂–∏–º –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
     *
     * @param MessageParseMode $parseMode
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/messageMethods/parseMode
     */
    public function parseMode(MessageParseMode $parseMode): self
    {
        $this->messageData['parse_mode'] = $parseMode->value;

        return $this;
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç "—Å—É—â–Ω–æ—Å—Ç—å" —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
     *
     * @param array $entities –ú–∞—Å—Å–∏–≤ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
     *
     * @return self
     *
     * @throws \JsonException
     * @see https://zenithgram.github.io/classes/messageMethods/entities
     */
    public function entities(array $entities): self
    {
        $this->messageData['entities'] = json_encode(
            $entities, JSON_THROW_ON_ERROR,
        );

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–µ–∂–∏–º –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ.
     *
     * @param int|null $message_id ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞. –ï—Å–ª–∏ null, –æ—Ç–≤–µ—á–∞–µ—Ç
     *                             –Ω–∞ —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/messageMethods/reply
     */
    public function reply(int|null $message_id = null): self
    {
        if ($message_id === null) {
            $message_id = $this->context->getMessageId();
        }

        $this->messageData['reply_to_message_id'] = $message_id;

        return $this;
    }

    /* reply_markup */

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
     *
     * @param array $buttons  –ö–Ω–æ–ø–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
     * @param bool  $one_time –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ?
     * @param bool  $resize   –†–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É?
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/messageMethods/kbd
     */
    public function kbd(array $buttons, bool $one_time = false,
        bool $resize = true,
    ): self {
        $reply_markup = [
            'keyboard'          => $buttons,
            'resize_keyboard'   => $resize,
            'one_time_keyboard' => $one_time,
        ];

        $this->reply_markup_raw = $reply_markup;

        return $this;
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
     *
     * @param array $buttons –ö–Ω–æ–ø–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/messageMethods/inlineKbd
     */
    public function inlineKbd(array $buttons): self
    {
        $reply_markup = [
            'inline_keyboard' => $buttons,
        ];

        $this->reply_markup_raw = $reply_markup;

        return $this;
    }

    /**
     * –£–¥–∞–ª—è–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
     *
     * @return self
     *
     * @throws \JsonException
     * @see https://zenithgram.github.io/classes/messageMethods/removeKbd
     */
    public function removeKbd(): self
    {
        $reply_markup = ['remove_keyboard' => true];

        $this->messageData['reply_markup'] = json_encode(
            $reply_markup, JSON_THROW_ON_ERROR,
        );

        return $this;
    }

    /**
     * –í–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º ForceReply
     *
     * @param string $placeholder –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - ''
     * @param bool   $selective   –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - false
     *
     * @return self
     *
     * @throws \JsonException
     * @see https://zenithgram.github.io/classes/messageMethods/forceReply
     */
    public function forceReply(string $placeholder = '',
        bool $selective = false,
    ): self {
        $reply_markup = [
            'force_reply'             => true,
            'input_field_placeholder' => $placeholder,
            'selective'               => $selective,
        ];

        $this->messageData['reply_markup'] = json_encode(
            $reply_markup, JSON_THROW_ON_ERROR,
        );

        return $this;
    }

    /* –ú–µ–¥–∏–∞ */

    private function detectInput(string $input): string|LocalFile
    {
        if (filter_var($input, FILTER_VALIDATE_URL)) {
            return $input;
        }

        if (exists($input)) {
            return new LocalFile($input);
        }

        return $input;
    }

    private function addMedia(string $type, string|array $input): self
    {
        $inputs = is_array($input) ? $input : [$input];

        foreach ($inputs as $item) {
            $this->mediaQueue[] = [
                'type'    => $type,
                'payload' => $this->detectInput($item),
            ];
        }

        return $this;
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
     *
     * @param string|array $img –°—Å—ã–ª–∫–∞ –∏–ª–∏ –º–∞—Å—Å–∏–≤ —Å—Å—ã–ª–æ–∫ (FileID)
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/messageMethods/img
     */
    public function img(string|array $img): self
    {
        $this->addMedia('photo', $img);

        return $this;
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–º–æ–¥–∑–∏
     *
     * @param MessageDice $dice –≠–º–æ–¥–∑–∏, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç –±–æ—Ç   \
     *                          **–ü—Ä: MessageDice::Dice**
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/messageMethods/dice
     */
    public function dice(MessageDice $dice): self
    {
        $this->sendDice = true;
        $this->messageData['emoji'] = $dice->value;

        return $this;
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç gif-—Ñ–∞–π–ª –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
     *
     * @param string|array $gif –°—Å—ã–ª–∫–∞ –∏–ª–∏ –º–∞—Å—Å–∏–≤ —Å—Å—ã–ª–æ–∫ (ID)
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/messageMethods/gif
     */
    public function gif(string|array $gif): self
    {
        $this->addMedia('animation', $gif);

        return $this;
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
     *
     * @param string $voice –°—Å—ã–ª–∫–∞ (ID)
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/messageMethods/voice
     */
    public function voice(string $voice): self
    {
        $this->addMedia('voice', $voice);

        return $this;
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –∞—É–¥–∏–æ-—Ñ–∞–π–ª –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
     *
     * @param string|array $audio –°—Å—ã–ª–∫–∞ –∏–ª–∏ –º–∞—Å—Å–∏–≤ —Å—Å—ã–ª–æ–∫ (ID)
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/messageMethods/audio
     */
    public function audio(string|array $audio): self
    {
        $this->addMedia('audio', $audio);

        return $this;
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –≤–∏–¥–µ–æ-—Ñ–∞–π–ª –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
     *
     * @param string|array $video –°—Å—ã–ª–∫–∞ –∏–ª–∏ –º–∞—Å—Å–∏–≤ —Å—Å—ã–ª–æ–∫ (ID)
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/messageMethods/video
     */
    public function video(string|array $video): self
    {
        $this->addMedia('video', $video);

        return $this;
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
     *
     * @param string|array $document –°—Å—ã–ª–∫–∞ –∏–ª–∏ –º–∞—Å—Å–∏–≤ —Å—Å—ã–ª–æ–∫ (ID)
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/messageMethods/doc
     */
    public function doc(string|array $document): self
    {
        $this->addMedia('document', $document);

        return $this;
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–µ–≤—å—é –∫ —Å–æ–æ–±—â–µ–Ω–∏—é —Å –ø–æ–º–æ—â—å—é —Å—Å—ã–ª–∫–∏.
     *
     * @param string $url
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/messageMethods/mediaPreview
     */
    public function mediaPreview(string $url): self
    {
        $this->mediaPreviewUrl = $url;

        return $this;
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∏–∫–µ—Ä
     *
     * @param string $sticker
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/messageMethods/sticker
     */
    public function sticker(string $sticker): self
    {
        $this->sendSticker = true;
        $this->messageData['sticker'] = $sticker;

        return $this;
    }


    /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã */

    /**
     * @internal
     */
    public function getMessageData(): array
    {
        return $this->messageData;
    }

    /**
     * @internal
     */
    public function setMessageData(array $messageData): self
    {
        $this->messageData = $messageData;

        return $this;
    }

    /**
     * @internal
     */
    public function getReplyMarkupRaw(): array
    {
        return $this->reply_markup_raw;
    }

    /**
     * @internal
     */
    public function setReplyMarkupRaw(array $reply_markup): self
    {
        $this->reply_markup_raw = $reply_markup;

        return $this;
    }

    /**
     * @internal
     */
    public function getAdditionallyParams(): array
    {
        return $this->additionally_params;
    }

    /**
     * @internal
     */
    public function setAdditionallyParams(array $params): self
    {
        $this->additionally_params = $params;

        return $this;
    }

    /**
     * @internal
     */
    public function getMediaQueue(): array
    {
        return $this->mediaQueue;
    }

    /**
     * @internal
     */
    public function setMediaQueue(array $params): self
    {
        $this->mediaQueue = $params;

        return $this;
    }

    /**
     * @internal
     */
    public function getSendType(): array
    {
        return [$this->sendDice, $this->sendSticker];
    }

    /**
     * @internal
     */
    public function setSendType(bool $sendDice, bool $sendSticker): self
    {
        $this->sendSticker = $sendSticker;
        $this->sendDice = $sendDice;

        return $this;
    }

    /**
     * @internal
     */
    public function getMediaPreviewUrl(): string
    {
        return $this->mediaPreviewUrl;
    }

    /**
     * @internal
     */
    public function setMediaPreviewUrl(string $params): self
    {
        $this->mediaPreviewUrl = $params;

        return $this;
    }
}

===
File: src/Action.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram;

class Action
{
    use MessageBuilderTrait;

    private string $id;
    private mixed $condition;
    private $handler;
    public string $queryText = '';
    public string $redirect_to = '';
    public \Closure|null $middleware_handler = null;
    private array $access_ids = [];
    private array $no_access_ids = [];
    private \Closure|null $access_handler = null;
    private \Closure|null $no_access_handler = null;
    private int $messageDataAction = 0; // 0 - send, 1 - editText, 2 - editCaption, 3 - editMedia

    public function __construct(string $id, mixed $condition)
    {
        $this->id = $id;
        $this->condition = $condition;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç middleware –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞.
     *
     * @param callable $handler –û–±—Ä–∞–±–æ—Ç—á–∏–∫
     *
     * @return Bot
     *
     * @see https://zenithgram.github.io/classes/actionMethods/middleware
     */
    public function middleware(callable $handler): self
    {
        $this->middleware_handler = $handler(...);

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞.
     *
     * @param callable $handler –û–±—Ä–∞–±–æ—Ç—á–∏–∫
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/actionMethods/func
     */
    public function func(callable $handler): self
    {
        $this->handler = $handler(...);

        return $this;
    }

    /**
     * –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –¥—Ä—É–≥–æ–π.
     * –ö–æ–ø–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞ –∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞ $id –≤ —Ç–µ–∫—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç.
     *
     * @param string $id ID –º–∞—Ä—à—Ä—É—Ç–∞, –∫—É–¥–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/actionMethods/redirect
     */
    public function redirect(string $id): self
    {
        $this->redirect_to = $id;

        return $this;
    }

    /**
     * –ó–∞–¥–∞–µ—Ç –≤—Å–ø–ª—ã–≤–∞—é—â–∏–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É
     *
     * @param string $query –í—Å–ø–ª—ã–≤–∞—é—â–∏–π —Ç–µ–∫—Å—Ç
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/actionMethods/query
     */
    public function query(string $query): self
    {
        return $this->setQueryText($query);
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–º –¥–æ—Å—Ç—É–ø–µ–Ω –º–∞—Ä—à—Ä—É—Ç
     *
     * @param int|string|array $ids     –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
     * @param callable|null    $handler –û–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –º–∞—Ä—à—Ä—É—Ç—É
     *                                  –∑–∞–ø—Ä–µ—â–µ–Ω
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/actionMethods/access
     */
    public function access(int|string|array $ids, ?callable $handler = null,
    ): self {
        $this->access_ids = is_numeric($ids) ? [$ids] : $ids;
        $this->access_handler = ($handler !== null) ? $handler(...) : null;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–º –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –º–∞—Ä—à—Ä—É—Ç
     *
     * @param int|string|array $ids     –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
     * @param callable|null    $handler –û–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –º–∞—Ä—à—Ä—É—Ç—É
     *                                  –∑–∞–ø—Ä–µ—â–µ–Ω
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/actionMethods/noAccess
     */
    public function noAccess(int|string|array $ids, ?callable $handler = null,
    ): self {
        $this->no_access_ids = is_numeric($ids) ? [$ids] : $ids;

        $this->no_access_handler = ($handler !== null) ? $handler(...) : null;

        return $this;
    }

    /** @internal */
    public function getQueryText(): string
    {
        return $this->queryText;
    }

    /** @internal */
    public function getId(): string
    {
        return $this->id;
    }

    /** @internal */
    public function getCondition(): mixed
    {
        return $this->condition;
    }

    /** @internal */
    public function getHandler(): ?callable
    {
        return $this->handler;
    }

    /** @internal */
    public function getAccessIds(): array
    {
        return $this->access_ids;
    }

    /** @internal */
    public function getNoAccessIds(): array
    {
        return $this->no_access_ids;
    }

    /** @internal */
    public function getAccessHandler(): ?callable
    {
        return $this->access_handler;
    }

    /** @internal */
    public function getNoAccessHandler(): ?callable
    {
        return $this->no_access_handler;
    }

    /** @internal */
    public function setHandler(?callable $handler): self
    {
        $this->handler = $handler;

        return $this;
    }

    /** @internal */
    public function setQueryText(?string $queryText): self
    {
        $this->queryText = $queryText;

        return $this;
    }

    /**
     * –ò–∑–º–µ–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
     *
     * @param string $text –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/actionMethods/editText
     */
    public function editText(string $text = ''): self
    {
        $this->messageData['text'] = $text;
        $this->messageDataAction = 1;

        return $this;
    }

    /**
     * –ò–∑–º–µ–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è
     *
     * @param string $text –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/actionMethods/editCaption
     */
    public function editCaption(string $text = ''): self
    {
        $this->messageData['text'] = $text;
        $this->messageDataAction = 2;

        return $this;
    }

    /**
     * –ò–∑–º–µ–Ω—è–µ—Ç –º–µ–¥–∏–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/actionMethods/editMedia
     */
    public function editMedia(): self
    {
        $this->messageDataAction = 3;

        return $this;
    }

    /** @internal */
    public function getMessageDataAction(): int
    {
        return $this->messageDataAction;
    }

    /**
     * @throws \Exception
     * @internal
     */
    public function execute(ZG $zg): array
    {
        $msg = new Message('', $zg);

        $msg->setAdditionallyParams($this->additionally_params);
        $msg->setMediaPreviewUrl($this->mediaPreviewUrl);
        $msg->setMediaQueue($this->mediaQueue);
        $msg->setMessageData($this->messageData);
        $msg->setReplyMarkupRaw($this->reply_markup_raw);

        $msg->setSendType($this->sendDice, $this->sendSticker);

        return match ($this->messageDataAction) {
            1 => $msg->editText(),
            2 => $msg->editCaption(),
            3 => $msg->editMedia(),
            default => $msg->send(),
        };
    }
}

===
File: src/Pagination.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram;

use ZenithGram\ZenithGram\Enums\PaginationLayout;
use ZenithGram\ZenithGram\Enums\PaginationMode;
use ZenithGram\ZenithGram\Enums\PaginationNumberStyle;

class Pagination
{
    private array $items;               // –ö–Ω–æ–ø–∫–∏
    private int $perPage = 5;           // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–æ–ø–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    private int $columns = 1;           // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫
    private int $page = 1;              // –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    private string $callbackPrefix;     // –ü—Ä–µ—Ñ–∏–∫—Å
    private string $prevText = "<";     // –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    private string $nextText = ">";     // –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    private null|string $returnButtonText = null;
    private null|string $returnButtonCallbackData = null;
    private null|string $firstText = null;
    private null|string $lastText = null;
    private bool $showFirstLast = false;
    private null|int $totalItems = null;
    private null|array $headerButtons = null;
    private PaginationLayout $navigationLayout = PaginationLayout::ROW;
    private PaginationMode $mode = PaginationMode::ARROWS;
    private PaginationNumberStyle|\Closure $numberStyle = PaginationNumberStyle::CLASSIC;
    private int $MaxPageBtn = 5;
    private string|null $ActiveBtnFormatPattern = null;
    private string|null $ActiveBtnFormatPatternLeft = null;
    private string|null $ActiveBtnFormatPatternRight = null;

    public function __construct() {}

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤–∏–¥ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–°—Ç—Ä–µ–ª–∫–∏ –∏–ª–∏ –¶–∏—Ñ—Ä—ã)
     *
     * @param PaginationMode $mode –û–¥–Ω–∞ –∏–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç: PaginationMode::ARROWS,
     *                             PaginationMode::NUMBERS
     *
     * @return Pagination
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setMode
     */
    public function setMode(PaginationMode $mode): self
    {
        $this->mode = $mode;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–æ–ø–æ–∫-—Å—Ç—Ä–∞–Ω–∏—Ü
     *
     * @param int $max
     *
     * @return Pagination
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setMaxPageBtn
     */
    public function setMaxPageBtn(int $max): self
    {
        $this->MaxPageBtn = $max;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–æ–º–µ—Ä–æ–≤
     *
     * –õ–∏–±–æ –≥–æ—Ç–æ–≤—ã–µ —Å—Ç–∏–ª–∏: PaginationNumberStyle::CLASSIC –∏
     * PaginationNumberStyle::EMOJI
     *
     * –õ–∏–±–æ –∞–Ω–æ–Ω–∏–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç
     * —Ç–µ–∫—Å—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏
     *
     * @param PaginationNumberStyle|callable $style
     *
     * @return Pagination
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setNumberStyle
     */
    public function setNumberStyle(PaginationNumberStyle|callable $style): self
    {
        if (is_callable($style)) {
            $this->numberStyle = \Closure::fromCallable($style);
        } else {
            $this->numberStyle = $style;
        }

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–º –±—É–¥–µ—Ç –≤—ã–¥–µ–ª—è—Ç—å—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞
     *
     * –õ–∏–±–æ —É–∫–∞–∑–∞—Ç—å —Å–∏–º–≤–æ–ª—ã —Å –¥–≤—É—Ö —Å—Ç–æ—Ä–æ–Ω. –ü—Ä–∏–º–µ—Ä: ->setActivePageFormat('- ',
     * ' -');
     *
     * –õ–∏–±–æ —É–∫–∞–∑–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è sprintf. –ü—Ä–∏–º–µ—Ä: ->setActivePageFormat('- %s
     * -');
     *
     * –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ–±–æ–∏—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:
     *
     * 1, 2, - 3 -, 4, 5
     *
     *
     * @param string      $left_or_pattern
     * @param string|null $right
     *
     * @return Pagination
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setActivePageFormat
     */
    public function setActivePageFormat(string $left_or_pattern,
        string|null $right = null,
    ): self {
        if ($right === null) {
            $this->ActiveBtnFormatPattern = $left_or_pattern;
        } else {
            $this->ActiveBtnFormatPatternLeft = $left_or_pattern;
            $this->ActiveBtnFormatPatternRight = $right;
        }

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–∞—Å—Å–∏–≤ –∫–Ω–æ–ø–æ–∫, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥—É—Ç —Å–æ–±–∏—Ä–∞—Ç—å—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
     *
     * @param array $items –ú–∞—Å—Å–∏–≤ callback-–∫–Ω–æ–ø–æ–∫
     *
     * @return Pagination
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setItems
     */
    public function setItems(array $items): self
    {
        $this->items = $items;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥–µ—Ç
     * —Å–æ—Å—Ç–æ—è—Ç—å —Å–ø–∏—Å–æ–∫
     *
     * –£–¥–æ–±–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤–µ—Å—å —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫, –µ—Å–ª–∏ –∏—Ö —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ
     *
     * @param int $totalItems
     *
     * @return Pagination
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setTotalItems
     */
    public function setTotalItems(int $totalItems): self
    {
        $this->totalItems = $totalItems;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–æ–ø–æ–∫
     *
     * @param int $perPage
     *
     * @return Pagination
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setPerPage
     */
    public function setPerPage(int $perPage): self
    {
        if ($perPage <= 0) {
            throw new \LogicException('PerPage –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è');
        }

        $this->perPage = $perPage;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫
     *
     * @param int $columns
     *
     * @return Pagination
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setColumns
     */
    public function setColumns(int $columns): self
    {
        if ($columns <= 0) {
            throw new \LogicException('Columns –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è');
        }

        $this->columns = $columns;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
     *
     * @param int $page
     *
     * @return Pagination
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setPage
     */
    public function setPage(int $page): self
    {
        if ($page <= 0) {
            throw new \LogicException('Page –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è');
        }

        $this->page = $page;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Callback-–ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
     *
     * @param string $callbackPrefix
     *
     * @return Pagination
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setPrefix
     */
    public function setPrefix(string $callbackPrefix): self
    {
        if ($callbackPrefix === '') {
            throw new \LogicException('CallbackPrefix –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
        }

        $this->callbackPrefix = $callbackPrefix;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ("–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞",
     * "–°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞")
     *
     * @param string $prevText –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
     * @param string $nextText –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
     *
     * @return Pagination
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setSigns
     */
    public function setSigns(string $prevText, string $nextText): self
    {
        if ($prevText === '' || $nextText === '') {
            throw new \LogicException(
                'PrevText –∏–ª–∏ NextText –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏',
            );
        }

        $this->prevText = $prevText;
        $this->nextText = $nextText;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ("–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞", "–ü–æ—Å–ª–µ–¥–Ω—è—è
     * —Å—Ç—Ä–∞–Ω–∏—Ü–∞")
     *
     * @param string $firstText –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
     * @param string $lastText  –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
     *
     * @return Pagination
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setSideSigns
     */
    public function setSideSigns(string $firstText, string $lastText): self
    {
        if ($firstText === '' || $lastText === '') {
            throw new \LogicException(
                'FirstText –∏–ª–∏ LastText –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏',
            );
        }

        $this->firstText = $firstText;
        $this->lastText = $lastText;
        $this->showFirstLast = true;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
     *
     * @param PaginationLayout $layout –û–¥–Ω–∞ –∏–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç: PaginationLayout::ROW,
     *                                 PaginationLayout::SPLIT,
     *                                 PaginationLayout::SMART
     *
     * @return Pagination
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/setNavigationLayout
     */
    public function setNavigationLayout(PaginationLayout $layout): self
    {
        $this->navigationLayout = $layout;

        return $this;
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
     *
     * @param string $text         –¢–µ–∫—Å—Ç –ö–Ω–æ–ø–∫–∏
     * @param string $callbackData CallbackData
     *
     * @return Pagination
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/addReturnBtn
     */
    public function addReturnBtn(string $text, string $callbackData): self
    {
        if ($text === '' || $callbackData === '') {
            throw new \LogicException(
                'Text –∏–ª–∏ CallbackData –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏',
            );
        }

        $this->returnButtonText = $text;
        $this->returnButtonCallbackData = $callbackData;

        return $this;
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç —Ä—è–¥ –∫–Ω–æ–ø–æ–∫ –≤ –Ω–∞—á–∞–ª–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
     *
     * @param array $buttons –†—è–¥ –∫–Ω–æ–ø–æ–∫ –≤–∏–¥–∞ [[button], [button]]
     *
     * @return Pagination
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/addHeaderBtn
     */
    public function addHeaderBtn(array $buttons): self
    {
        if (empty($buttons)) {
            throw new \LogicException(
                '–†—è–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º',
            );
        }

        $this->headerButtons = $buttons;

        return $this;
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü
     *
     * @return int
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/getTotalPage
     */
    public function getTotalPage(): int
    {
        $totalItems = $this->totalItems ?? count($this->items);

        return (int)ceil($totalItems / $this->perPage);
    }

    /**
     * –°–æ–±–∏—Ä–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É
     *
     * @return array
     *
     * @see https://zenithgram.github.io/classes/paginationMethods/create
     */
    public function create(): array
    {
        if (empty($this->items)) {
            return [];
        }

        $totalPages = $this->getTotalPage();

        if ($this->page > $totalPages) {
            $this->page = $totalPages;
        }

        $offset = ($this->page - 1) * $this->perPage;
        $pageItems = array_slice($this->items, $offset, $this->perPage);

        $keyboard = array_chunk($pageItems, $this->columns);

        if ($this->headerButtons !== null) {
            array_unshift($keyboard, $this->headerButtons);
        }

        if ($totalPages > 1) {
            if ($this->mode === PaginationMode::ARROWS) {
                $keyboard = $this->createArrowsKbd($keyboard, $totalPages);
            } elseif ($this->mode === PaginationMode::NUMBERS) {
                $keyboard = $this->createNumbersKbd($keyboard, $totalPages);
            }
        }

        if ($this->returnButtonText !== null
            && $this->returnButtonCallbackData !== null
        ) {
            $keyboard[] = [[
                               'text'          => $this->returnButtonText,
                               'callback_data' => $this->returnButtonCallbackData,
                           ]];
        }

        return $keyboard;
    }

    private function createArrowsKbd($keyboard, $totalPages): array
    {
        $innerButtons = [];
        $outerButtons = [];

        // –ö–Ω–æ–ø–∫–∞ –Ω–∞—á–∞–ª–æ
        if ($this->showFirstLast && $this->page > 1) {
            $outerButtons['first'] = [
                'text'          => $this->firstText,
                'callback_data' => $this->callbackPrefix.'1',
            ];
        }

        // –ö–Ω–æ–ø–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è
        if ($this->page > 1) {
            $innerButtons['prev'] = [
                'text'          => $this->prevText,
                'callback_data' => $this->callbackPrefix.($this->page - 1),
            ];
        }

        // –ö–Ω–æ–ø–∫–∞ –≤–ø–µ—Ä–µ–¥
        if ($this->page < $totalPages) {
            $innerButtons['next'] = [
                'text'          => $this->nextText,
                'callback_data' => $this->callbackPrefix.($this->page + 1),
            ];
        }

        // –ö–Ω–æ–ø–∫–∞ –∫–æ–Ω–µ—Ü
        if ($this->showFirstLast && $this->page < $totalPages) {
            $outerButtons['last'] = [
                'text'          => $this->lastText,
                'callback_data' => $this->callbackPrefix.$totalPages,
            ];
        }

        $totalNavButtons = count($innerButtons) + count($outerButtons);

        switch ($this->navigationLayout) {
            case PaginationLayout::SPLIT:
                $shouldSplit = !empty($outerButtons);
                break;

            case PaginationLayout::SMART:
                $shouldSplit = $totalNavButtons > 2;
                break;

            case PaginationLayout::ROW:
                $shouldSplit = false;
                break;
        }

        if ($shouldSplit) {
            if (!empty($innerButtons)) {
                $keyboard[] = array_values($innerButtons);
            }

            if (!empty($outerButtons)) {
                $keyboard[] = array_values($outerButtons);
            }

        } else {
            $row = [];
            if (isset($outerButtons['first'])) {
                $row[] = $outerButtons['first'];
            }
            if (isset($innerButtons['prev'])) {
                $row[] = $innerButtons['prev'];
            }
            if (isset($innerButtons['next'])) {
                $row[] = $innerButtons['next'];
            }
            if (isset($outerButtons['last'])) {
                $row[] = $outerButtons['last'];
            }

            if (!empty($row)) {
                $keyboard[] = $row;
            }
        }

        return $keyboard;
    }

    private function createNumbersKbd(array $keyboard, int $totalPages): array
    {
        $maxVisible = $this->MaxPageBtn;
        $current = $this->page;

        if ($totalPages <= $maxVisible) {
            $start = 1;
            $end = $totalPages;
        } else {
            $half = (int)floor($maxVisible / 2);
            $start = $current - $half;
            $end = $start + $maxVisible - 1;

            if ($start < 1) {
                $start = 1;
                $end = $maxVisible;
            }

            if ($end > $totalPages) {
                $end = $totalPages;
                $start = $totalPages - $maxVisible + 1;
            }
        }

        $row = [];
        for ($i = $start; $i <= $end; $i++) {
            $text = $this->formatPageNumber($i);

            if ($i === $current) {
                $text = $this->decorateActivePage($text);
            }

            $row[] = [
                'text'          => $text,
                'callback_data' => $this->callbackPrefix.$i,
            ];
        }

        $keyboard[] = $row;

        return $keyboard;
    }

    private function formatPageNumber(int $number): string
    {
        if ($this->numberStyle instanceof \Closure) {
            return ($this->numberStyle)($number);
        }

        return match ($this->numberStyle) {
            PaginationNumberStyle::EMOJI => $this->toEmojiNumber($number),
            PaginationNumberStyle::CLASSIC => (string)$number,
        };
    }

    private function decorateActivePage(string $text): string
    {
        if ($this->ActiveBtnFormatPattern !== null) {
            return sprintf($this->ActiveBtnFormatPattern, $text);
        }

        if ($this->ActiveBtnFormatPatternLeft !== null) {
            return $this->ActiveBtnFormatPatternLeft.$text
                .($this->ActiveBtnFormatPatternRight ?? '');
        }

        return $text;
    }

    private function toEmojiNumber(int $number): string
    {
        $map = [
            '0' => '0Ô∏è‚É£', '1' => '1Ô∏è‚É£', '2' => '2Ô∏è‚É£', '3' => '3Ô∏è‚É£',
            '4' => '4Ô∏è‚É£',
            '5' => '5Ô∏è‚É£', '6' => '6Ô∏è‚É£', '7' => '7Ô∏è‚É£', '8' => '8Ô∏è‚É£',
            '9' => '9Ô∏è‚É£',
        ];

        return str_replace(
            array_keys($map), array_values($map), (string)$number,
        );
    }
}





===
File: src/Dto/MessageDto.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Dto;

/**
 * DTO –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ Message –∏–∑ Telegram API.
 *
 * –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Å–æ–æ–±—â–µ–Ω–∏–µ. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ,
 * –º–µ–¥–∏–∞—Ñ–∞–π–ª, —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Ç.–¥.
 *
 * @see https://core.telegram.org/bots/api#message
 */
class MessageDto
{
    public function __construct(
        public readonly int $messageId,
        public readonly int $date,
        public readonly ChatDto $chat,

        // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è (–º–æ–≥—É—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –∫–∞–Ω–∞–ª–∞—Ö –Ω–µ—Ç 'from')
        public readonly ?int $messageThreadId,
        public readonly ?UserDto $from,
        public readonly ?ChatDto $senderChat,

        // –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å (–æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)
        public readonly ?MessageDto $replyToMessage,
        public readonly ?MessageDto $pinnedMessage,

        // –ö–æ–Ω—Ç–µ–Ω—Ç
        public readonly ?string $text,
        public readonly ?string $caption,

        // –ú–∞—Å—Å–∏–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π (—Å—Å—ã–ª–∫–∏, –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ —Ç.–¥.)
        public readonly ?array $entities,
        public readonly ?array $captionEntities,

        // –ú–µ–¥–∏–∞ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã
        public readonly ?array $dice, // ['emoji' => 'üé≤', 'value' => 6]
        public readonly ?array $photo, // –ú–∞—Å—Å–∏–≤ PhotoSize
        public readonly ?array $sticker,
        public readonly ?array $video,
        public readonly ?array $audio,
        public readonly ?array $voice,
        public readonly ?array $document,

        // –°–ª—É–∂–µ–±–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        public readonly ?bool $isTopicMessage,
        public readonly ?array $newChatMembers, // –ú–∞—Å—Å–∏–≤ UserDto
        public readonly ?UserDto $leftChatMember,
    ) {}

    /**
     * –§–∞–±—Ä–∏—á–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è DTO –∏–∑ –º–∞—Å—Å–∏–≤–∞.
     *
     * @param array $data –ú–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–±—ã—á–Ω–æ $update['message'])
     * @return static
     */
    public static function fromArray(array $data): static
    {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤ UserDto –¥–ª—è –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        $newChatMembers = [];
        if (isset($data['new_chat_members']) && is_array($data['new_chat_members'])) {
            foreach ($data['new_chat_members'] as $member) {
                $newChatMembers[] = UserDto::fromArray($member);
            }
        }

        return new static(
            messageId:       $data['message_id'],
            date:            $data['date'],

            // ChatDto –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –≤ –æ–±—ä–µ–∫—Ç–µ Message
            chat:            ChatDto::fromArray($data['chat']),

            // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
            messageThreadId: $data['message_thread_id'] ?? null,
            from:            isset($data['from']) ? UserDto::fromArray($data['from']) : null,
            senderChat:      isset($data['sender_chat']) ? ChatDto::fromArray($data['sender_chat']) : null,

            // –†–ï–ö–£–†–°–ò–Ø: –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π MessageDto, –µ—Å–ª–∏ —ç—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
            replyToMessage:  isset($data['reply_to_message']) ? self::fromArray($data['reply_to_message']) : null,
            pinnedMessage:   isset($data['pinned_message']) ? self::fromArray($data['pinned_message']) : null,

            // –¢–µ–∫—Å—Ç –∏ –ø–æ–¥–ø–∏—Å–∏
            text:            $data['text'] ?? null,
            caption:         $data['caption'] ?? null,

            // –°—É—â–Ω–æ—Å—Ç–∏ (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π EntityDto, –Ω–æ –ø–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –º–∞—Å—Å–∏–≤–æ–º)
            entities:        $data['entities'] ?? null,
            captionEntities: $data['caption_entities'] ?? null,

            // –ú–µ–¥–∏–∞
            dice:            $data['dice'] ?? null,
            photo:           $data['photo'] ?? null,
            sticker:         $data['sticker'] ?? null,
            video:           $data['video'] ?? null,
            audio:           $data['audio'] ?? null,
            voice:           $data['voice'] ?? null,
            document:        $data['document'] ?? null,

            // –°–ª—É–∂–µ–±–Ω—ã–µ
            isTopicMessage:  $data['is_topic_message'] ?? null,
            newChatMembers:  !empty($newChatMembers) ? $newChatMembers : null,
            leftChatMember:  isset($data['left_chat_member']) ? UserDto::fromArray($data['left_chat_member']) : null,
        );
    }

    /**
     * –£–¥–æ–±–Ω—ã–π —Ö–µ–ª–ø–µ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∏—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–∏–∑ text –∏–ª–∏ caption)
     */
    public function getEffectiveText(): ?string
    {
        return $this->text ?? $this->caption;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–º
     */
    public function isReply(): bool
    {
        return $this->replyToMessage !== null;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ Dice (–∏—Å–ø–æ–ª—å–∑—É—è –≤–∞—à Enum)
     */
    public function getDiceEmoji(): ?string
    {
        return $this->dice['emoji'] ?? null;
    }
}

===
File: src/Dto/ChatDto.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Dto;

/**
 * DTO –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ Chat –∏–∑ Telegram API.
 *
 * –û–±—ä–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —á–∞—Ç. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ª–∏—á–Ω—ã–π —á–∞—Ç, –≥—Ä—É–ø–ø–∞,
 * —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–∞ –∏–ª–∏ –∫–∞–Ω–∞–ª.
 *
 * @see https://core.telegram.org/bots/api#chat
 */
class ChatDto
{
    /**
     * @param int     $id          –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —á–∞—Ç–∞.
     * @param string  $type        –¢–∏–ø —á–∞—Ç–∞: "private", "group", "supergroup"
     *                             –∏–ª–∏ "channel".
     * @param ?string $title       –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. –ù–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø,
     *                             –∫–∞–Ω–∞–ª–æ–≤ –∏ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤.
     * @param ?string $username    –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –ª–∏—á–Ω—ã—Ö
     *                             —á–∞—Ç–æ–≤, —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø –∏ –∫–∞–Ω–∞–ª–æ–≤).
     * @param ?string $firstName   –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. –ò–º—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ.
     * @param ?string $lastName    –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. –§–∞–º–∏–ª–∏—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –≤ –ª–∏—á–Ω–æ–º
     *                             —á–∞—Ç–µ.
     * @param ?string $description –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. –û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø, —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø
     *                             –∏ –∫–∞–Ω–∞–ª–æ–≤.
     * @param ?string $inviteLink  –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞
     *                             –¥–ª—è –≥—Ä—É–ø–ø, —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø –∏ –∫–∞–Ω–∞–ª–æ–≤.
     * @param ?bool   $isForum     –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. True, –µ—Å–ª–∏ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–∞ —è–≤–ª—è–µ—Ç—Å—è
     *                             —Ñ–æ—Ä—É–º–æ–º.
     */
    public function __construct(
        public readonly int $id,
        public readonly string $type,
        public readonly ?string $title,
        public readonly ?string $username,
        public readonly ?string $firstName,
        public readonly ?string $lastName,
        public readonly ?string $description,
        public readonly ?string $inviteLink,
        public readonly ?bool $isForum,
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏ –¥—Ä—É–≥–∏–µ –ø–æ–ª—è –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏: photo, pinned_message, permissions –∏ —Ç.–¥.
    ) {}

    /**
     * –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥-—Ñ–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è DTO –∏–∑ –º–∞—Å—Å–∏–≤–∞ –æ—Ç Telegram.
     *
     * @param array $data –ú–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö —á–∞—Ç–∞ –æ—Ç Telegram API.
     *
     * @return static
     */
    public static function fromArray(array $data): static
    {
        return new static(
            id:             $data['id'],
            type:           $data['type'],
            title:          $data['title'] ?? null,
            username:       $data['username'] ?? null,
            firstName:      $data['first_name'] ?? null,
            lastName:       $data['last_name'] ?? null,
            description:    $data['description'] ?? null,
            inviteLink:     $data['invite_link'] ?? null,
            isForum:        $data['is_forum'] ?? null,
        );
    }
}

===
File: src/Dto/UserDto.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Dto;

/**
 * –ë–∞–∑–æ–≤—ã–π DTO –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ User –∏–∑ Telegram API.
 */
class UserDto
{
    public function __construct(
        public readonly int $id,
        public readonly bool $isBot,
        public readonly string $firstName,
        public readonly ?string $lastName,
        public readonly ?string $username,
        public readonly ?string $languageCode
    ) {
    }

    /**
     * –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥-—Ñ–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è DTO –∏–∑ –º–∞—Å—Å–∏–≤–∞ –æ—Ç Telegram.
     *
     * @param array $data
     *
     * @return static
     */
    public static function fromArray(array $data): static
    {
        return new static(
            id: $data['id'],
            isBot: $data['is_bot'],
            firstName: $data['first_name'],
            lastName: $data['last_name'] ?? null,
            username: $data['username'] ?? null,
            languageCode: $data['language_code'] ?? null
        );
    }
}

===
File: src/Bot.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram;

use ZenithGram\ZenithGram\Dto\UserDto;
use ZenithGram\ZenithGram\Storage\StorageInterface;
use ZenithGram\ZenithGram\Utils\DependencyResolver;
use ZenithGram\ZenithGram\Utils\EnvironmentDetector;
use ZenithGram\ZenithGram\Exceptions\RouteException;
use ZenithGram\ZenithGram\Utils\AttributesLoader;
use Psr\Container\ContainerInterface;
use Psr\SimpleCache\CacheInterface;

class Bot
{
    private ZG|null $tg;
    private UpdateContext|null $context;
    private array $ctx = [];
    private ?StorageInterface $storage = null;
    private DependencyResolver $resolver;

    private array $routes
        = [
            'bot_command'         => [],
            'command'             => [],
            'text_exact'          => [],
            'text_preg'           => [],
            'callback_query'      => [],
            'callback_query_preg' => [],
            'state'               => [],
            'inline_fallback'     => null,
            'start_command'       => null,
            'referral_command'    => null,
            'edit_message'        => null,
            'sticker_fallback'    => null,
            'message_fallback'    => null,
            'photo_fallback'      => null,
            'video_fallback'      => null,
            'audio_fallback'      => null,
            'voice_fallback'      => null,
            'document_fallback'   => null,
            'video_note_fallback' => null,
            'new_chat_members'    => null,
            'left_chat_member'    => null,
            'fallback'            => null,
        ];

    public array $buttons
        = [
            'btn'    => [],
            'action' => [],
        ];

    private array $pendingRedirects = [];
    private \Closure|null $middleware_handler = null;
    private bool $useReflection = false;

    public function __construct(ZG|null $tg = null,
        null|DependencyResolver $resolver = null,
    ) {
        $this->tg = $tg;
        $this->context = $tg?->context;
        $this->resolver = $resolver ?? new DependencyResolver();
    }

    /**
     * –í–∫–ª—é—á–∞–µ—Ç –∏–ª–∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ (Dependency Injection)
     * –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏.
     *
     * @param bool $status true - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DI, false - –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å ($zg,
     *                     ...$args)
     *
     * @return Bot
     *
     * @see https://zenithgram.github.io/classes/botMethods/reflection
     */
    public function reflection(bool $status = true): self
    {
        $this->useReflection = $status;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç PSR-11 –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
     *
     * @param ContainerInterface $container –û–±—ä–µ–∫—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–µ—à–∞
     *
     * @return Bot
     *
     * @see https://zenithgram.github.io/classes/botMethods/setContainer
     */
    public function setContainer(ContainerInterface $container): self
    {
        $this->resolver->setContainer($container);

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç PSR-16 –∫–µ—à –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏
     *
     * @param CacheInterface $cache –û–±—ä–µ–∫—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–µ—à–∞
     *
     * @return Bot
     *
     * @see https://zenithgram.github.io/classes/botMethods/setCache
     */
    public function setCache(CacheInterface $cache): self
    {
        $this->resolver->setCache($cache);

        return $this;
    }

    /**
     * –ü–æ–¥–∫–ª—é—á–∞–µ—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∫ –±–æ—Ç—É (—Ñ–∞–π–ª—ã, –ë–î, Redis)
     *
     * @param StorageInterface $storage –û–±—ä–µ–∫—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
     *
     * @return Bot
     *
     * @see https://zenithgram.github.io/classes/botMethods/setStorage
     */
    public function setStorage(StorageInterface $storage): self
    {
        $this->storage = $storage;
        $this->tg?->setStorage($storage);

        return $this;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (—à–∞–≥–∞ –¥–∏–∞–ª–æ–≥–∞)
     *
     * @param string $stateName –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'ask_age')
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onState
     */
    public function onState(string $stateName): Action
    {
        $route = new Action("state_{$stateName}", $stateName);
        $this->routes['state'][$stateName] = $route;

        return $route;
    }

    public function attributes(): AttributesLoader
    {
        return new AttributesLoader($this);
    }

    /** @internal  */
    public function getContainer(): ?ContainerInterface { return $this->resolver->getContainer(); }
    /** @internal  */
    public function getCache(): ?CacheInterface { return $this->resolver->getCache(); }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç middleware
     *
     * @param callable $handler –û–±—Ä–∞–±–æ—Ç—á–∏–∫
     *
     * @return void
     *
     * @see https://zenithgram.github.io/classes/botMethods/middleware
     */
    public function middleware(callable $handler): void
    {
        $this->middleware_handler = \Closure::fromCallable($handler);
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏.
     *
     * @param string      $id   –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–Ω–æ–ø–∫–∏.
     * @param string|null $text –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/btn
     */
    public function btn(string $id, string|null $text = null): Action
    {
        $this->buttons['btn'][$id] = $text ?? $id;

        $route = new Action($id, $text ?? $id);
        $this->buttons['action'][$id] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –∫–æ–º–∞–Ω–¥—ã.
     *
     * @param string            $id      –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–∞—Ä—à—Ä—É—Ç–∞.
     * @param array|string|null $command –¢–µ–∫—Å—Ç –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä '/start'.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onBotCommand
     */
    public function onBotCommand(string $id, array|string|null $command = null,
    ): Action {
        $route = new Action($id, $command ?? $id);
        $this->routes['bot_command'][$id] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /start.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onStart
     */
    public function onStart(): Action
    {
        $route = new Action('start_command', null);
        $this->routes['start_command'] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onReferral
     */
    public function onReferral(): Action
    {
        $route = new Action('referral_command', null);
        $this->routes['referral_command'] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onEditedMessage
     */
    public function onEditedMessage(): Action
    {
        $route = new Action('edit_message', null);
        $this->routes['edit_message'] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –∫–æ–º–∞–Ω–¥—ã.
     *
     * @param string            $id      –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–∞—Ä—à—Ä—É—Ç–∞.
     * @param array|string|null $command –¢–µ–∫—Å—Ç –∫–æ–º–∞–Ω–¥—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä '!start'.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onCommand
     */
    public function onCommand(string $id, array|string|null $command = null,
    ): Action {
        $route = new Action($id, $command ?? $id);
        $this->routes['command'][$id] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.
     *
     * @param string            $id   –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä.
     * @param array|string|null $text –¢–µ–∫—Å—Ç –¥–ª—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onText
     */
    public function onText(string $id, array|string|null $text = null): Action
    {
        $route = new Action($id, $text ?? $id);
        $this->routes['text_exact'][$id] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º—É –≤—ã—Ä–∞–∂–µ–Ω–∏—é.
     *
     * @param string            $id      –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä.
     * @param array|string|null $pattern –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onTextPreg
     */
    public function onTextPreg(string $id, array|string|null $pattern = null,
    ): Action {
        $route = new Action($id, $pattern ?? $id);
        $this->routes['text_preg'][$id] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è callback-–∑–∞–ø—Ä–æ—Å–∞.
     *
     * @param string            $id   –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä.
     * @param array|string|null $data –î–∞–Ω–Ω—ã–µ –∏–∑ callback-–∫–Ω–æ–ø–∫–∏.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onCallback
     */
    public function onCallback(string $id, array|string|null $data = null,
    ): Action {
        $route = new Action($id, $data ?? $id);
        $this->routes['callback_query'][$id] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è callback-–∑–∞–ø—Ä–æ—Å–∞ –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º—É –≤—ã—Ä–∞–∂–µ–Ω–∏—é.
     *
     * @param string            $id      –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä.
     * @param array|string|null $pattern –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è CallbackData.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onCallbackPreg
     */
    public function onCallbackPreg(string $id,
        array|string|null $pattern = null,
    ): Action {
        $route = new Action($id, $pattern ?? $id);
        $this->routes['callback_query_preg'][$id] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è inline-–∑–∞–ø—Ä–æ—Å–∞.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onInline
     */
    public function onInline(): Action
    {
        $route = new Action('inline_fallback', null);
        $this->routes['inline_fallback'] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∏–∫–µ—Ä–æ–≤.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onSticker
     */
    public function onSticker(): Action
    {
        $route = new Action('sticker_fallback', null);
        $this->routes['sticker_fallback'] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onMessage
     */
    public function onMessage(): Action
    {
        $route = new Action('message_fallback', null);
        $this->routes['message_fallback'] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ñ–æ—Ç–æ.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onPhoto
     */
    public function onPhoto(): Action
    {
        $route = new Action('photo_fallback', null);
        $this->routes['photo_fallback'] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å –≤–∏–¥–µ–æ.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onVideo
     */
    public function onVideo(): Action
    {
        $route = new Action('video_fallback', null);
        $this->routes['video_fallback'] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∞—É–¥–∏–æ.
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onAudio
     */
    public function onAudio(): Action
    {
        $route = new Action('audio_fallback', null);
        $this->routes['audio_fallback'] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onVoice
     */
    public function onVoice(): Action
    {
        $route = new Action('voice_fallback', null);
        $this->routes['voice_fallback'] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onDocument
     */
    public function onDocument(): Action
    {
        $route = new Action('document_fallback', null);
        $this->routes['document_fallback'] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤—Å–µ—Ö –≤–∏–¥–µ–æ-—Å–æ–æ–±—â–µ–Ω–∏–π
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onVideoNote
     */
    public function onVideoNote(): Action
    {
        $route = new Action('video_note_fallback', null);
        $this->routes['video_note_fallback'] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ(—ã—Ö) —É—á–∞—Å—Ç–Ω–∏–∫–∞(–æ–≤) —á–∞—Ç–∞
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onNewChatMember
     */
    public function onNewChatMember(): Action
    {
        $route = new Action('new_chat_members', null);
        $this->routes['new_chat_members'] = $route;

        return $route;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –≤—ã—à–µ–¥—à–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —á–∞—Ç–∞
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onLeftChatMember
     */
    public function onLeftChatMember(): Action
    {
        $route = new Action('left_chat_member', null);
        $this->routes['left_chat_member'] = $route;

        return $route;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (fallback).
     *
     * @return Action
     *
     * @see https://zenithgram.github.io/classes/botMethods/onDefault
     */
    public function onDefault(): Action
    {
        $route = new Action('fallback', null);
        $this->routes['fallback'] = $route;

        return $route;
    }

    private function dispatch(): void
    {
        $next = function(): void {
            $this->processRoutes();
        };

        if (is_callable($this->middleware_handler)) {
            if ($this->useReflection) {
                $args = ['next' => $next];
                $dependencies = $this->resolver->resolve(
                    $this->middleware_handler, $this->tg, $args,
                );

                ($this->middleware_handler)(...$dependencies);
            } else {
                ($this->middleware_handler)($this->tg, $next);
            }
        } else {
            $next();
        }
    }

    private function processRoutes()
    {
        $type = $this->context->getType();
        $text = $this->context->getText();
        $callback_data = $this->context->getCallbackData();
        $userId = $this->context->getUserId();

        if ($type === 'bot_command'
            || ($type === "text"
                && str_starts_with($text, '/')
            )
        ) {
            $text = strtolower(mb_convert_encoding($text, 'UTF-8'));

            if (str_starts_with($text, '/start ')
                && $this->routes['referral_command'] !== null
            ) {
                $route = $this->routes['referral_command'];
                $this->dispatchAnswer(
                    $route, $type, [trim(mb_substr($text, 6))],
                );

                return;
            }

            if ($text === '/start'
                && $this->routes['start_command'] !== null
            ) {
                $route = $this->routes['start_command'];
                $this->dispatchAnswer($route, $type);

                return;
            }

            $words = explode(' ', $text);
            $command = $words[0];
            unset($words[0]);
            $final_text = implode(' ', $words);

            foreach ($this->routes['bot_command'] as $route) {
                $conditions = (array)$route->getCondition();
                foreach ($conditions as $condition) {
                    if ($condition === $command) {
                        $this->dispatchAnswer(
                            $route, $type, [$final_text],
                        );

                        return;
                    }
                }
            }
        }

        if ($this->storage && $userId) {
            $currentState = $this->storage->getState($userId);

            if ($currentState && isset($this->routes['state'][$currentState])) {
                $route = $this->routes['state'][$currentState];
                $this->dispatchAnswer(
                    $route, 'state', [$text ?? $callback_data],
                );

                return;
            }
        }

        if (($type === 'text' || $type === 'bot_command')) {
            if (!empty($text)) {
                foreach ($this->routes['command'] as $route) {
                    $conditions = (array)$route->getCondition();
                    foreach ($conditions as $commandPattern) {
                        if (str_contains($commandPattern, '{')) {
                            $regex = $this->convertCommandPatternToRegex(
                                $commandPattern,
                            );
                            if (preg_match($regex, $text, $matches)) {
                                $args = $this->cleanMatches($matches);
                                $this->dispatchAnswer($route, $type, $args);

                                return;
                            }
                        } else {
                            $commandFromRoute = mb_convert_encoding(
                                $commandPattern, 'UTF-8',
                            );
                            if (str_starts_with($text, $commandFromRoute)) {
                                $commandLength = strlen($commandFromRoute);
                                if (!isset($text[$commandLength])
                                    || $text[$commandLength] === ' '
                                    || $text[$commandLength] === "\n"
                                ) {
                                    $argsString = trim(
                                        substr($text, $commandLength),
                                    );
                                    $args = ($argsString === '')
                                        ? []
                                        : preg_split(
                                            '/\s+/', $argsString, -1,
                                            PREG_SPLIT_NO_EMPTY,
                                        );
                                    $this->dispatchAnswer($route, $type, $args);

                                    return;
                                }
                            }
                        }
                    }
                }

                foreach ($this->routes['text_exact'] as $route) {
                    $conditions = (array)$route->getCondition();
                    foreach ($conditions as $condition) {
                        if ($condition === $text) {
                            $this->dispatchAnswer($route, $type);

                            return;
                        }
                    }
                }

                foreach ($this->buttons['action'] as $route) {
                    $conditions = (array)$route->getCondition();
                    foreach ($conditions as $condition) {
                        if ($condition === $text) {
                            $this->dispatchAnswer($route, 'text_button');

                            return;
                        }
                    }
                }

                foreach ($this->routes['text_preg'] as $route) {
                    $patterns = (array)$route->getCondition();
                    foreach ($patterns as $pattern) {
                        if (preg_match($pattern, $text, $matches)) {
                            // UPD: –ò—Å–ø–æ–ª—å–∑—É–µ–º cleanMatches
                            $args = $this->cleanMatches($matches);
                            $this->dispatchAnswer($route, $type, $args);

                            return;
                        }
                    }
                }

                if ($this->routes['message_fallback'] !== null) {
                    $this->dispatchAnswer(
                        $this->routes['message_fallback'], 'text',
                    );

                    return;
                }
            }

            if ($this->tryProcessFallbackMedia('photo')) {
                return;
            }
            if ($this->tryProcessFallbackMedia('audio')) {
                return;
            }
            if ($this->tryProcessFallbackMedia('video')) {
                return;
            }
            if ($this->tryProcessFallbackMedia('sticker')) {
                return;
            }
            if ($this->tryProcessFallbackMedia('voice')) {
                return;
            }
            if ($this->tryProcessFallbackMedia('document')) {
                return;
            }
            if ($this->tryProcessFallbackMedia('video_note')) {
                return;
            }

            if (!empty(
                $this->context->getUpdateData()['message']['new_chat_members']
                )
                && $this->routes['new_chat_members'] !== null
            ) {
                $newMembersData = $this->context->getUpdateData(
                )['message']['new_chat_members'];
                $newMembersDtos = array_map(
                    fn(array $memberData) => UserDto::fromArray($memberData),
                    $newMembersData,
                );
                $this->dispatchAnswer(
                    $this->routes['new_chat_members'],
                    'text',
                    $newMembersDtos,
                );
            }

            if (!empty(
                $this->context->getUpdateData()['message']['left_chat_member']
                )
                && $this->routes['left_chat_member'] !== null
            ) {
                $leftMember = UserDto::fromArray(
                    $this->context->getUpdateData(
                    )['message']['left_chat_member'],
                );
                $this->dispatchAnswer(
                    $this->routes['left_chat_member'],
                    'text',
                    [$leftMember],
                );
            }
        }

        if ($type === 'callback_query') {
            foreach ($this->buttons['action'] as $route) {
                if ($route->getId() === $callback_data) {
                    $this->dispatchAnswer($route, 'button_'.$type);

                    return;
                }
            }

            foreach ($this->routes['callback_query'] as $route) {
                $conditions = (array)$route->getCondition();
                foreach ($conditions as $condition) {
                    if (str_contains($condition, '{')) {
                        $regex = $this->convertPatternToRegex($condition);
                        if (preg_match($regex, $callback_data, $matches)) {
                            $args = $this->cleanMatches($matches);
                            $this->dispatchAnswer($route, $type, $args);

                            return;
                        }
                    } else {
                        if ($condition === $callback_data) {
                            $this->dispatchAnswer($route, $type);

                            return;
                        }
                    }
                }
            }

            if (!empty($this->routes['callback_query_preg'])) {
                foreach ($this->routes['callback_query_preg'] as $route) {
                    $patterns = (array)$route->getCondition();
                    foreach ($patterns as $pattern) {
                        if (preg_match($pattern, $callback_data, $matches)) {
                            $args = $this->cleanMatches($matches);
                            $this->dispatchAnswer($route, $type, $args);

                            return;
                        }
                    }
                }
            }
        }

        if ($type === 'edited_message') {
            if ($this->routes['edit_message'] !== null) {
                $this->dispatchAnswer($this->routes['edit_message'], 'text');

                return;
            }
        }

        if ($type === 'inline_query') {
            if ($this->routes['inline_fallback'] !== null) {
                $this->dispatchAnswer($this->routes['inline_fallback'], $type);

                return;
            }
        }

        if ($this->routes['fallback'] !== null) {
            $this->dispatchAnswer($this->routes['fallback'], 'text');

            return;
        }
    }

    private function cleanMatches(array $matches): array
    {
        $args = [];

        $hasNamed = false;
        foreach ($matches as $key => $value) {
            if (is_string($key)) {
                $hasNamed = true;
                break;
            }
        }

        if ($hasNamed) {
            foreach ($matches as $key => $value) {
                if (is_string($key)) {
                    $args[$key] = $value;
                }
            }
        } else {
            foreach ($matches as $key => $value) {
                if (is_int($key) && $key > 0) {
                    $args[] = $value;
                }
            }
        }

        return $args;
    }

    private function tryProcessFallbackMedia(string $route_type): bool
    {
        $fallback_key = $route_type.'_fallback';

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –º–µ–¥–∏–∞ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –ò —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –¥–ª—è –Ω–µ–≥–æ fallback
        if (!empty($this->context->getUpdateData()['message'][$route_type])
            && $this->routes[$fallback_key] !== null
        ) {
            $file_id = File::getFileId(
                $this->context->getUpdateData(), $route_type,
            );
            $file = new File($file_id, $this->tg->api);

            $this->dispatchAnswer(
                $this->routes[$fallback_key],
                'text',
                [$file],
            );

            return true;
        }

        return false;
    }

    private function convertCommandPatternToRegex(string $pattern): string
    {
        $pattern = preg_replace(
            '/\{([a-zA-Z0-9_]+)}/', '(?P<$1>\S+)', $pattern,
        );

        preg_match_all(
            '/(?P<name>\(\?P<[^>]+>[^)]+\))|\S+/u', $pattern, $matches,
        );
        $tokens = $matches[0];

        $regexParts = [];
        foreach ($tokens as $token) {
            if (str_starts_with($token, '(?P<')) {
                $regexParts[] = $token;
                continue;
            }

            $regexParts[] = preg_quote($token, '/');
        }

        $regex = '^'.implode('\s+', $regexParts).'$';

        return '/'.$regex.'/u';
    }

    private function convertPatternToRegex(string $pattern): string
    {
        $regex = preg_quote($pattern, '/');

        $regex = preg_replace(
            '/\\\{([a-zA-Z0-9_]+)\\\}/', '(?P<$1>[a-zA-Z0-9_-]+)', $regex,
        );

        return '/^'.$regex.'$/u';
    }

    private function dispatchAnswer($route, $type, array $other_data = [])
    {
        $this->ctx = [
            $route,
            $type,
            $other_data,
        ];

        $this->tg->setBotButtons($this->buttons['btn']);

        $next = function(): void {
            $this->processAnswer();
        };

        if (is_callable($route->middleware_handler)) {
            if ($this->useReflection) {
                $resolveArgs = array_merge($other_data, ['next' => $next]);
                $dependencies = $this->resolver->resolve(
                    $route->middleware_handler, $this->tg, $resolveArgs,
                );
                ($route->middleware_handler)(...$dependencies);
            } else {
                ($route->middleware_handler)($this->tg, $next);
            }

        } else {
            $next();
        }
    }

    private function processAnswer()
    {
        [$route, $type, $other_data] = $this->ctx;

        if (!empty($route->redirect_to)) {
            $targetAction = $this->findActionById($route->redirect_to);
            if ($targetAction === null) {
                throw new \LogicException(
                    "–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –∞–π–¥–∏ '{$route->redirect_to}' –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                );
            }
            $query_id = $this->context->getQueryId();
            if ($query_id && !empty($route->getQueryText())) {
                $this->tg->answerCallbackQuery(
                    $query_id, ['text' => $route->getQueryText()],
                );
            }

            return $this->executeAction($targetAction, $other_data);
        }

        $user_id = $this->context->getUserId();
        if ($user_id) {
            $accessIds = $route->getAccessIds();
            if (!empty($accessIds) && !in_array($user_id, $accessIds)) {
                $accessHandler = $route->getAccessHandler();
                if (is_callable($accessHandler)) {
                    if ($this->useReflection) {
                        $dependencies = $this->resolver->resolve(
                            $accessHandler, $this->tg, $other_data,
                        );
                        $accessHandler(...$dependencies);
                    } else {
                        $accessHandler($this->tg);
                    }
                }

                return null;
            }
            $noAccessIds = $route->getNoAccessIds();
            if (!empty($noAccessIds) && in_array($user_id, $noAccessIds)) {
                $noAccessHandler = $route->getNoAccessHandler();
                if (is_callable($noAccessHandler)) {
                    if ($this->useReflection) {
                        $dependencies = $this->resolver->resolve(
                            $noAccessHandler, $this->tg, $other_data,
                        );
                        $noAccessHandler(...$dependencies);
                    } else {
                        $noAccessHandler($this->tg);
                    }
                }

                return null;
            }
        }

        $handler = $route->getHandler();
        if (!empty($handler)) {
            if ($this->useReflection) {
                $dependencies = $this->resolver->resolve(
                    $handler, $this->tg, $other_data,
                );
                $handler(...$dependencies);
            } else {
                $handler($this->tg, ...array_values($other_data));
            }

            return null;
        }

        if ($type === 'bot_command' || $type === 'text'
            || $type === 'text_button'
        ) {
            if (empty($route->getMessageData())) {
                return null;
            }
            $route->execute($this->tg);

            return null;
        }

        if ($type === 'state') {
            $type = $this->context->getType();
            if ($type === 'callback_query') {
                $this->tg->answerCallbackQuery(
                    $this->context->getQueryId(),
                    ['text' => $route->getQueryText()],
                );
            }
            $route->execute($this->tg);

            return null;
        }

        if ($type === 'button_callback_query') {
            $query_id = $this->context->getQueryId();
            $this->tg->answerCallbackQuery(
                $query_id, ['text' => $route->getQueryText()],
            );
            if (empty($route->getMessageData())) {
                $callback_data = $this->context->getCallbackData();
                foreach ($this->routes['callback_query'] as $route2) {
                    if ($route2->getCondition() === $callback_data) {
                        $this->dispatchAnswer($route2, 'callback_query');

                        return null;
                    }
                }

                return null;
            }
            $route->execute($this->tg);

            return null;
        }

        if ($type === 'callback_query') {
            $query_id = $this->context->getQueryId();
            $this->tg->answerCallbackQuery(
                $query_id, ['text' => $route->getQueryText()],
            );
            if (empty($route->getMessageData())) {
                return null;
            }
            $route->execute($this->tg);

            return null;
        }

        return null;
    }

    /**
     * –ü—Ä–æ–∫–∏–¥—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å ZG –≤ –∫–ª–∞—Å—Å Bot.
     *
     * –°–æ–∑–¥–∞–Ω –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å –º–µ—Ç–æ–¥–æ–º –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
     * LongPoll.
     *
     * @param ZG $ZG –û–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ ZG
     *
     * @return Bot
     *
     * @throws \InvalidArgumentException –ï—Å–ª–∏ –æ–¥–∏–Ω –∏–∑ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω.
     *
     * @see https://zenithgram.github.io/classes/botMethods/zg
     */
    public function zg(ZG $ZG): self
    {
        $this->tg = $ZG;
        $this->context = $ZG->context;

        if ($this->storage) {
            $this->tg->setStorage($this->storage);
        }

        return $this;
    }

    /**
     * –ú–µ—Ç–æ–¥ —è–≤–ª—è–µ—Ç—Å—è "—Å–µ—Ä–¥—Ü–µ–º" —Ä–æ—É—Ç–µ—Ä–∞. –û–Ω –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
     * (–¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏–∏) –≤—Ö–æ–¥—è—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º–∏ –≤–∞–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏.
     *
     * –û–±—ã—á–Ω–æ run –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –≤ –∫–æ–Ω—Ü–µ –≤–∞—à–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.
     *
     * @param null|string $id =    –û–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ ZG
     *
     * @return void
     *
     * @throws \InvalidArgumentException –ï—Å–ª–∏ –æ–¥–∏–Ω –∏–∑ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω.
     *
     * @see https://zenithgram.github.io/classes/botMethods/run
     */
    public function run(null|string $id = null): void
    {
        if ($id === null) {
            $this->processRedirects();
            $this->dispatch();

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º OK
            if (EnvironmentDetector::isWeb() && $this->tg !== null) {
                $this->tg->sendOk();
            }
        } else {
            $actionToRun = $this->findActionById($id);
            if ($actionToRun === null) {
                throw new RouteException(
                    "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: –ú–∞—Ä—à—Ä—É—Ç '$id' –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                );
            }
            $this->executeAction($actionToRun);
        }
    }

    private function executeAction(Action $action, array $other_data = [])
    {
        $handler = $action->getHandler();
        if ($handler !== null) {
            if ($this->useReflection) {
                $dependencies = $this->resolver->resolve(
                    $handler, $this->tg, $other_data,
                );

                return $handler(...$dependencies);
            }

            return $handler($this->tg, ...array_values($other_data));
        }

        if (!empty($action->getMessageData())) {
            return $action->execute($this->tg);
        }

        return null;
    }

    /**
     * –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –æ–¥–∏–Ω –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –¥—Ä—É–≥–æ–π.
     * –ö–æ–ø–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞ –∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞ $to_id –≤ –º–∞—Ä—à—Ä—É—Ç $id.
     *
     * @param string $id    ID –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ (–æ—Ç–∫—É–¥–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç).
     * @param string $to_id ID —Ü–µ–ª–µ–≤–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ (–∫—É–¥–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç).
     *
     * @return Bot
     *
     * @throws \InvalidArgumentException –ï—Å–ª–∏ –æ–¥–∏–Ω –∏–∑ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω.
     *
     * @see https://zenithgram.github.io/classes/botMethods/redirect
     */
    public function redirect(string $id, string $to_id): Bot
    {
        $this->pendingRedirects[] = ['from' => $id, 'to' => $to_id];

        return $this;
    }

    private function processRedirects(): void
    {
        foreach ($this->pendingRedirects as $redirect) {
            $sourceAction = $this->findActionById($redirect['from']);
            if ($sourceAction === null) {
                throw new RouteException(
                    "–ò—Å—Ö–æ–¥–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ —Å ID '{$redirect['from']}' –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                );
            }

            $targetAction = $this->findActionById($redirect['to']);
            if ($targetAction === null) {
                throw new RouteException(
                    "–¶–µ–ª–µ–≤–æ–π –º–∞—Ä—à—Ä—É—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ —Å ID '{$redirect['to']}' –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                );
            }

            $sourceAction
                ->setHandler($targetAction->getHandler())
                ->setMessageData($targetAction->getMessageData())
                ->setQueryText($targetAction->getQueryText());
        }

        $this->pendingRedirects = [];
    }

    private function findActionById(string $id): ?Action
    {
        foreach ($this->routes as $type => $actions) {
            if (is_array($actions) && isset($actions[$id])) {
                return $actions[$id];
            }
        }

        $singleActionRoutes = [
            'inline_fallback', 'start_command', 'referral_command',
            'edit_message', 'sticker_fallback', 'message_fallback',
            'photo_fallback', 'video_fallback', 'audio_fallback',
            'voice_fallback', 'document_fallback', 'video_note_fallback',
            'new_chat_members', 'left_chat_member', 'fallback',
        ];

        foreach ($singleActionRoutes as $routeName) {
            $action = $this->routes[$routeName];
            if ($action instanceof Action && $action->getId() === $id) {
                return $action;
            }
        }

        if (isset($this->buttons['action'][$id])) {
            return $this->buttons['action'][$id];
        }

        return null;
    }
}

===
File: src/Poll.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram;

use ZenithGram\ZenithGram\Enums\MessageParseMode;
use ZenithGram\ZenithGram\Interfaces\ApiClientInterface;

class Poll
{

    private ApiClientInterface $api;
    private UpdateContext $context;
    private string $type = 'regular';
    private string $question_parse_mode = '';
    private ?string $question = null;
    private array $options = [];
    private bool $is_anonymous = true;
    private bool $allows_multiple_answers = false;
    private ?int $correct_option_id = null;
    private string $explanation_parse_mode = '';
    private ?string $explanation = null;
    private bool $is_closed = false;
    private ?int $open_period = null;
    private ?int $close_date = null;

    public function __construct(string $type, ApiClientInterface $api, UpdateContext $context)
    {
        $type = in_array($type, ['regular', 'quiz']) ? $type : 'regular';
        $this->type = $type;

        $this->context = $context;
        $this->api = $api;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–µ–∂–∏–º —Ä–∞–∑–º–µ—Ç–∫–∏ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
     *
     * @param MessageParseMode $parse_mode
     *
     * @return Poll
     *
     * @see https://zenithgram.github.io/classes/pollMethods/parseMode
     */
    public function parseMode(MessageParseMode $parse_mode): self
    {
        $this->explanation_parse_mode = $parse_mode->value;
        $this->question_parse_mode = $parse_mode->value;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–µ–∂–∏–º —Ä–∞–∑–º–µ—Ç–∫–∏ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞
     *
     * @param MessageParseMode $parse_mode
     *
     * @return Poll
     *
     * @see https://zenithgram.github.io/classes/pollMethods/parseMode
     */
    public function questionParseMode(MessageParseMode $parse_mode): self
    {
        $this->question_parse_mode = $parse_mode->value;

        return $this;
    }

    /**
     * –ó–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å –¥–ª—è –æ–ø—Ä–æ—Å–∞
     *
     * @param string $question
     *
     * @return Poll
     *
     * @see https://zenithgram.github.io/classes/pollMethods/question
     */
    public function question(string $question): self
    {
        $this->question = $question;

        return $this;
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç—ã –¥–ª—è –æ–ø—Ä–æ—Å–∞
     *
     * @param string ...$answers
     *
     * @return Poll
     *
     * @see https://zenithgram.github.io/classes/pollMethods/addAnswers
     */
    public function addAnswers(string ...$answers): self
    {
        $this->options = array_merge($this->options, $answers);

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å –æ–ø—Ä–æ—Å–∞
     *
     * @param bool|null $anon
     *
     * @return Poll
     *
     * @see https://zenithgram.github.io/classes/pollMethods/isAnonymous
     */
    public function isAnonymous(?bool $anon = true): self
    {
        $this->is_anonymous = $anon;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
     *
     * @param bool|null $multiple
     *
     * @return Poll
     *
     * @see https://zenithgram.github.io/classes/pollMethods/multipleAnswers
     */
    public function multipleAnswers(bool $multiple = true): self
    {
        $this->allows_multiple_answers = $multiple;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–∏ÃÜ –æ—Ç–≤–µ—Ç (–ù–∞—á–∏–Ω–∞—è —Å 1)
     *
     * @param int $id
     *
     * @return Poll
     *
     * @see https://zenithgram.github.io/classes/pollMethods/correctAnswer
     */
    public function correctAnswer(int $id): self
    {
        if ($this->type === 'quiz') {
            $this->correct_option_id = $id;
        }

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫ –æ–ø—Ä–æ—Å—É
     *
     * @param string $explanation
     *
     * @return Poll
     *
     * @see https://zenithgram.github.io/classes/pollMethods/explanation
     */
    public function explanation(string $explanation): self
    {
        if ($this->type === 'quiz') {
            $this->explanation = $explanation;
        }

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–µ–∂–∏–º —Ä–∞–∑–º–µ—Ç–∫–∏ –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
     *
     * @param MessageParseMode $parse_mode
     *
     * @return Poll
     *
     * @see https://zenithgram.github.io/classes/pollMethods/parseMode
     */
    public function explanationParseMode(MessageParseMode $parse_mode): self
    {
        if ($this->type === 'quiz') {
            $this->explanation_parse_mode = $parse_mode->value;
        }

        return $this;
    }

    /**
     * –°—Ä–∞–∑—É –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–ø—Ä–æ—Å
     *
     * @param bool|null $close
     *
     * @return Poll
     *
     * @see https://zenithgram.github.io/classes/pollMethods/close
     */
    public function close(?bool $close = true): self
    {
        $this->is_closed = $close;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è –æ–ø—Ä–æ—Å–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
     *
     * @param int $seconds
     *
     * @return Poll
     *
     * @see https://zenithgram.github.io/classes/pollMethods/openPeriod
     */
    public function openPeriod(int $seconds): self
    {
        if ($seconds < 5 || $seconds > 600) {
            $seconds = 600;
        }

        $this->open_period = $seconds;
        $this->close_date = null;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞—Ç—É, –∫–æ–≥–¥–∞ –∑–∞–∫—Ä–æ–µ—Ç—Å—è –æ–ø—Ä–æ—Å
     *
     * @param int $timestamp
     *
     * @return Poll
     *
     * @see https://zenithgram.github.io/classes/pollMethods/closeDate
     */
    public function closeDate(int $timestamp): self
    {
        $now = time();

        if ($timestamp < ($now + 5) || $timestamp > ($now + 600)) {
            $timestamp = $now + 600;
        }

        $this->close_date = $timestamp;
        $this->open_period = null;

        return $this;
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–ø—Ä–æ—Å
     *
     * @param int|null $chatID
     *
     * @return array
     *
     * @see https://zenithgram.github.io/classes/pollMethods/send
     *
     * @throws \JsonException
     */
    public function send(?int $chatID = null): array
    {
        $params = [
            'chat_id' => $chatID ?? $this->context->getChatId(),
        ];

        $params['question'] = $this->question;
        $params['options'] = json_encode($this->options, JSON_THROW_ON_ERROR);
        $params['is_anonymous'] = $this->is_anonymous;
        $params['type'] = $this->type;
        $params['allows_multiple_answers'] = $this->allows_multiple_answers;
        $params['question_parse_mode'] = $this->question_parse_mode;
        $params['is_closed'] = $this->is_closed;

        if ($this->type === 'quiz') {
            $params['correct_option_id'] = $this->correct_option_id;

            if (!empty($this->explanation)) {
                $params['explanation'] = $this->explanation;
            }

            if (!empty($this->explanation_parse_mode)) {
                $params['explanation_parse_mode']
                    = $this->explanation_parse_mode;
            }

            if (!empty($this->open_period)) {
                $params['open_period'] = $this->open_period;
            }

            if (!empty($this->close_date)) {
                $params['close_date'] = $this->close_date;
            }
        }

        return $this->api->callAPI('sendPoll', $params);
    }


}

===
File: src/File.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram;

use Amp\File as AmpFile;
use ZenithGram\ZenithGram\Interfaces\ApiClientInterface;

class File
{
    private array $file_info = [];

    private const MAX_DOWNLOAD_SIZE_BYTES = 20971520;

    public function __construct(
        private readonly string $file_id,
        public readonly ApiClientInterface $api,
    ) {}


    public function getFileInfo(): array
    {
        if (empty($this->file_info)) {
            $response = $this->api->callAPI(
                'getFile', ['file_id' => $this->file_id],
            );
            $this->file_info = $response['result'];
        }

        return $this->file_info;
    }

    public function getFileSize(string $units = 'B', int $precision = 5,
    ): int|float {
        $bytes = $this->getFileInfo()['file_size'] ?? 0;

        $division = match ($units) {
            'MB' => 1048576,
            'KB' => 1024,
            default => 1,
        };

        return round($bytes / $division, $precision);
    }

    public function getFilePath(): string
    {
        return $this->api->getApiFileUrl().$this->getFileInfo()['file_path'];
    }

    /**
     * –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–∞–π–ª
     */
    public function save(string $path): string
    {
        if ($this->getFileSize() >= self::MAX_DOWNLOAD_SIZE_BYTES) {
            throw new \RuntimeException('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 20 –ú–ë');
        }

        $downloadUrl = $this->getFilePath();

        $isDir = str_ends_with($path, DIRECTORY_SEPARATOR)
            || str_ends_with(
                $path, '/',
            );

        if ($isDir
            || AmpFile\isDirectory($path)
        ) {
            $path = rtrim($path, DIRECTORY_SEPARATOR).DIRECTORY_SEPARATOR;
            $path .= basename($downloadUrl);
        }

        $directory = dirname($path);

        if (!AmpFile\isDirectory($directory)) {
            AmpFile\createDirectoryRecursively($directory, 0775);
        }

        $this->api->downloadFile($downloadUrl, $path);

        return $path;
    }

    public static function getFileId(array $context, ?string $type = null,
    ): ?string {
        $message = $context['result'] ?? $context['message'] ?? [];
        if (empty($message)) {
            return null;
        }

        if ($type !== null) {
            $obj = match ($type) {
                'photo' => end($message['photo']),
                default => $message[$type] ?? null,
            };

            return $obj['file_id'] ?? null;
        }

        $fileTypes = ['photo', 'document', 'video', 'audio', 'voice', 'sticker',
                      'video_note'];
        foreach ($fileTypes as $fileType) {
            if (isset($message[$fileType])) {
                if ($fileType === 'photo') {
                    return end($message['photo'])['file_id'];
                }

                return $message[$fileType]['file_id'];
            }
        }

        return null;
    }
}

===
File: src/UpdateContext.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram;

class UpdateContext
{
    private ?array $update;

    public function __construct(?array $update)
    {
        $this->update = $update;
    }

    /**
     * –§–∞–±—Ä–∏—á–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞
     * (–≤–µ–±—Ö—É–∫).
     */
    public static function fromWebhook(): self
    {
        $input = file_get_contents('php://input');
        $update = json_decode($input, true);

        return new self($update);
    }

    public function setUpdate(array $update)
    {
        $this->update = $update;
    }

    public function getUpdateData(): ?array
    {
        return $this->update;
    }

    public function getChatId(): ?int
    {
        return $this->update['message']['chat']['id']
            ?? $this->update['edited_message']['chat']['id']
            ?? $this->update['callback_query']['message']['chat']['id']
            ?? null;
    }

    public function getUserId(): ?int
    {
        return $this->update['message']['from']['id']
            ?? $this->update['edited_message']['from']['id']
            ?? $this->update['callback_query']['from']['id']
            ?? $this->update['inline_query']['from']['id']
            ?? null;
    }

    public function getReplyUserId(): ?int
    {
        return $this->update['message']['reply_to_message']['from']['id'] ?? null;
    }

    public function getText(): ?string
    {
        return $this->update['message']['text']
            ?? $this->update['message']['caption']
            ?? $this->update['edited_message']['text']
            ?? $this->update['inline_query']['query']
            ?? null;
    }

    public function getReplyText(): ?string
    {
        return $this->update['message']['reply_to_message']['text'] ?? null;

    }

    public function getMessageId(): null|int|string
    {
        return $this->update['message']['message_id'] ??
            $this->update['edited_message']['message_id'] ??
            $this->update['callback_query']['message']['message_id'] ??
            $this->update['callback_query']['inline_message_id'] ??
            null;
    }

    public function getReplyMessageId(): null|int|string
    {
        return $this->update['message']['reply_to_message']['message_id'] ?? null;
    }

    public function getCallbackData(): ?string
    {
        return $this->update['callback_query']['data'] ?? null;
    }

    public function getQueryId(): ?string
    {
        return $this->update['callback_query']['id']
            ?? $this->update['inline_query']['id']
            ?? null;
    }

    public function getType(): ?string
    {
        if (isset($this->update['callback_query'])) {
            return 'callback_query';
        }

        if (isset($this->update['edited_message'])) {
            return 'edited_message';
        }
        if (isset($this->update['inline_query'])) {
            return 'inline_query';
        }

        if (isset($this->update['message'])) {
             if (!empty($this->update['message']['entities'])
                && $this->update['message']['entities'][0]['type']
                === 'bot_command'
            ) {
                return 'bot_command';
            }
            return 'text';
        }

        return null;
    }


}


===
File: src/ErrorHandler.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram;

use Closure;
use ErrorException;
use Throwable;
use ZenithGram\ZenithGram\Utils\EnvironmentDetector;

trait ErrorHandler
{
    private Closure|null $handler = null;
    private array|null $debug_chat_ids = null;
    private bool $short_trace = true;
    private string $pathFiler = '';
    private bool $isAlreadyExiting = false;

    /**
     * –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ç—Ä–µ–π—Ç –∏–ª–∏ —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π
     *
     * @param bool $short_trace
     *
     * @return ZG
     *
     * @see https://zenithgram.github.io/classes/errorhandler#shortTrace
     */
    public function shortTrace(bool $short_trace): self
    {
        $this->short_trace = $short_trace;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä –Ω–∞ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –µ–≥–æ
     *
     * @param string $filter "/path/to/your/project"
     *
     * @return ZG
     *
     * @see https://zenithgram.github.io/classes/errorhandler#setTracePathFilter
     */
    public function setTracePathFilter(string $filter): self
    {
        $this->pathFiler = $filter;

        return $this;
    }

    /**
     * –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –¥–µ–±–∞–≥ —Ä–µ–∂–∏–º
     *
     * –ß—Ç–æ–±—ã –æ–Ω —Ä–∞–±–æ—Ç–∞–ª, –Ω—É–∂–Ω–æ –∑–∞–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –ª–∏–±–æ –ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç—å id, –∫—É–¥–∞
     * –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏
     *
     * @return ZG
     *
     * @throws \ErrorException
     * @see https://zenithgram.github.io/classes/errorhandler#enableDebug
     */
    public function enableDebug(): self
    {
        ini_set('display_errors', 0);
        ini_set('display_startup_errors', 1);
        error_reporting(E_ALL);

        set_error_handler(
            fn(int $severity, string $message, string $file, int $line)
                => $this->handleError($severity, $message, $file, $line),
        );

        set_exception_handler(fn(\Throwable $e)
            => $this->handleExceptionFatal($e),
        );

        register_shutdown_function(fn()
            => $this->handleShutdown(),
        );

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç ID, –∫—É–¥–∞ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤–æ–∑–Ω–∏–∫—à–∏–µ –æ—à–∏–±–∫–∏
     *
     * @param int|string|array $ids ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —á–∞—Ç–∞
     *
     * @return ZG
     *
     * @see https://zenithgram.github.io/classes/errorhandler#setSendIds
     */
    public function setSendIds(int|string|array $ids): self
    {
        $this->debug_chat_ids = is_array($ids) ? $ids : [$ids];

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏
     *
     * @param callable $handler –û–±—Ä–∞–±–æ—Ç—á–∏–∫. –ü—Ä–∏–º–µ—Ä: function (ZG $tg, Throwable
     *                          $e)
     *
     * @return ZG
     *
     * @see https://zenithgram.github.io/classes/errorhandler#setHandler
     */
    public function setHandler(callable $handler): self
    {
        $this->handler = $handler(...);

        return $this;
    }

    private function handleError(int $severity, string $message, string $file,
        int $line,
    ): bool {
        if (!(error_reporting() & $severity)) {
            return false;
        }
        throw new ErrorException($message, 0, $severity, $file, $line);
    }

    private function handleShutdown(): void
    {
        if ($this->isAlreadyExiting) {
            return;
        }
        $error = error_get_last();
        if ($error
            && in_array(
                $error['type'],
                [E_ERROR, E_PARSE, E_CORE_ERROR, E_COMPILE_ERROR],
            )
        ) {
            $this->handleExceptionFatal(
                new ErrorException(
                    $error['message'], 0, $error['type'], $error['file'],
                    $error['line'],
                ),
            );
        }
    }

    private function handleExceptionFatal(Throwable $e): void
    {
        $this->isAlreadyExiting = true;
        $this->reportException($e);
        exit(1);
    }

    public function reportException(Throwable $e): void
    {
        $className = (new \ReflectionClass($e))->getShortName();
        $message = $e->getMessage();

        [$userFile, $userLine, $isVendorError] = $this->findUserLocation($e);

        $cleanUserFile = $userFile;
        $cleanRealFile = $e->getFile();

        $trace = $this->renderTrace($e);
        $snippet = $this->getCodeSnippet($userFile, $userLine);

        if (EnvironmentDetector::isCli()) {
            $this->renderCliError(
                $className, $message, $cleanUserFile, $userLine, $cleanRealFile,
                $e->getLine(), $snippet, $trace['cli'],
            );
        }

        if ($this->debug_chat_ids) {
            $this->sendTelegramError(
                $className, $message, $cleanUserFile, $userLine, $cleanRealFile,
                $e->getLine(), $snippet, $trace['html'],
            );
        }

        if ($this->handler !== null) {
            ($this->handler)($this, $e);
        }
    }

    private function findUserLocation(Throwable $e): array
    {
        $realFile = $e->getFile();
        $realLine = $e->getLine();

        if (!$this->isVendorPath($realFile)) {
            return [$realFile, $realLine, false];
        }

        foreach ($e->getTrace() as $frame) {
            if (isset($frame['file']) && !$this->isVendorPath($frame['file'])) {
                return [$frame['file'], $frame['line'], true];
            }
        }

        return [$realFile, $realLine, true];
    }

    private function isVendorPath(string $path): bool
    {
        return str_contains(
                $path, DIRECTORY_SEPARATOR.'vendor'.DIRECTORY_SEPARATOR,
            )
            || str_contains($path, '/vendor/')
            || str_contains($path, '\\vendor\\');
    }

    private function renderCliError(string $type, string $msg, string $userFile,
        int $userLine, string $realFile, int $realLine, array $snippet,
        string $fullTrace,
    ): void {
        $reset = "\033[0m";
        $bgRed = "\033[41;30m";
        $yellow = "\033[1;33m";
        $cyan = "\033[36m";
        $gray = "\033[90m";
        $boldWhite = "\033[1;37m";

        echo PHP_EOL;

        echo "$bgRed$type $reset$boldWhite$msg$reset".PHP_EOL;

        echo $cyan.$this->filteredFile($userFile).":$userLine$reset".PHP_EOL;

        if ($userFile !== $realFile) {
            echo "$gray(Inside: ".$this->filteredFile($realFile)
                .":$realLine)$reset".PHP_EOL;
        }

        echo PHP_EOL;

        foreach ($snippet as $num => $codeLine) {
            $cleanCode = str_replace(["\r", "\n"], '', $codeLine);

            if ($num === $userLine) {
                echo sprintf(
                        " %s > %s %s %-80s %s", $bgRed, $num, $reset,
                        $cleanCode, $reset,
                    ).PHP_EOL;
            } else {
                echo sprintf(" $gray   %s %s %s", $num, $reset, $cleanCode)
                    .PHP_EOL;
            }
        }

        echo PHP_EOL."$yellow Stack Trace: $reset".PHP_EOL.$gray.$fullTrace
            .$reset.PHP_EOL;
    }

    private function sendTelegramError(string $type, string $msg,
        string $userFile, int $userLine, string $realFile, int $realLine,
        array $snippet, string $trace,
    ): void {
        $esc = fn($s) => htmlspecialchars($s, ENT_QUOTES | ENT_SUBSTITUTE);

        $locationInfo
            = "<u>File:</u> <code>".$this->filteredFile($esc($userFile))
            .":{$userLine}</code>\n";
        if ($userFile !== $realFile) {
            $locationInfo .= "<i><u>Inside:</u><code>".$this->filteredFile(
                    $esc($realFile),
                ).":{$realLine}</code></i>\n";
        }

        $codeBlock = "";
        foreach ($snippet as $num => $codeLine) {
            $marker = ($num === $userLine) ? "üëâ " : "   ";
            $codeLine = mb_strimwidth($codeLine, 0, 60, "...");
            $codeBlock .= "$marker$num: ".$esc($codeLine);
        }

        $token = $this->api->getToken();
        $first_chars_token = substr($token, 0, 3).'...';


        $html = "<b>üî• Fatal Error: {$esc($type)}</b>\n\n".
            "<u>Message:</u> <b>{$esc($msg)}</b>\n".
            $locationInfo."\n".
            "<pre><code class=\"language-php\">".str_replace(
                $token, $first_chars_token, $codeBlock,
            )."</code></pre>\n\n".
            "<b>Stack Trace:</b>\n";

        if (mb_strlen($trace) > 2000) {
            $message_chunk = str_split($trace, 2000);
            $html .= "<pre>{$message_chunk[0]}</pre>";
            unset($message_chunk[0]);

            $chunks = array_chunk($message_chunk, 2);

            $mergedArray = [];
            foreach ($chunks as $chunk) {
                if (count($chunk) === 2) {
                    $mergedArray[] = $chunk[0].' '.$chunk[1];
                } else {
                    $mergedArray[] = $chunk[0];
                }
            }


        } else {
            $html .= "<pre><code class=\"language-bash\">{$trace}</code></pre>";
        }

        foreach ($this->debug_chat_ids as $chatId) {
            try {
                $this->api->callAPI(
                    'sendMessage', ['chat_id'    => $chatId, 'text' => $html,
                                    'parse_mode' => 'HTML'],
                );
                if (!empty($mergedArray)) {
                    foreach ($mergedArray as $message) {
                        $this->api->callAPI(
                            'sendMessage', ['chat_id'    => $chatId,
                                            'text'       => "<pre><code class=\"language-bash\">"
                                                .$message."</code></pre>",
                                            'parse_mode' => 'HTML'],
                        );
                    }
                }
            } catch (Throwable $t) {
                fwrite(STDERR, "Log send fail: ".$t->getMessage());
            }
        }
    }

    private function getCodeSnippet(string $file, int $line, int $padding = 5,
    ): array {
        if (!is_readable($file)) {
            return [];
        }
        $lines = file($file);
        $start = max(0, $line - $padding - 1);
        $slice = array_slice($lines, $start, ($line + $padding) - $start, true);
        $result = [];
        foreach ($slice as $i => $content) {
            $result[$i + 1] = $content;
        }

        return $result;
    }

    private function renderTrace(Throwable $e): array
    {
        $trace = "";
        $i = 0;
        foreach ($e->getTrace() as $item) {
            if ($this->checkTraceForCleaning($item) === true) {
                continue;
            }

            $fileRaw = $item['file'] ?? null;
            if ($fileRaw === null) {
                $file = '[internal]';
                $lineStr = '';
            } else {
                $file = $this->pathFiler !== '' ? $this->filteredFile($fileRaw)
                    : $fileRaw;
                $lineStr = "(".($item['line'] ?? '?').")";
            }

            $class = $item['class'] ?? '';
            $type = $item['type'] ?? '';
            $function = $item['function'];

            if (str_contains($function, '{closure')) {
                $function = '{closure}';
            }

            $separator = $lineStr ? " " : ": ";

            $trace .= "#".$i.' '.$file.$lineStr.$separator
                .$class.$type.$function."()\n";

            $i++;
        }

        if (empty($trace) && $this->short_trace) {
            $trace
                = "All stack frames were inside /vendor/ (Internal framework error). \nSet ->shortTrace(false) to see full details.";
        }

        return ['html' => htmlspecialchars($trace), 'cli' => $trace];
    }

    private function checkTraceForCleaning(array $item): bool
    {
        if ($this->short_trace === false) {
            return false;
        }

        $file = $item['file'] ?? '';
        $class = $item['class'] ?? '';

        if ($file !== ''
            && (stripos($file, 'vendor/') !== false
                || stripos(
                    $file, 'vendor\\',
                ) !== false)
        ) {
            return true;
        }

        if (str_starts_with($class, 'Revolt\\')
            || (str_starts_with(
                    $class, 'ZenithGram\ZenithGram\\',
                )
                && $file === '')
            || str_starts_with($class, 'Amp\\')
            || str_contains($class, 'Fiber')
        ) {
            return true;
        }

        if (str_ends_with($class, 'ErrorHandler')) {
            return true;
        }

        return false;
    }

    private function filteredFile(string|null $file): string
    {
        if ($file === null) {
            return '?';
        }

        return str_replace($this->pathFiler, '...', $file);
    }

}

===
File: src/Message.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram;

use ZenithGram\ZenithGram\Enums\MessageParseMode;
use ZenithGram\ZenithGram\Utils\LocalFile;
use ZenithGram\ZenithGram\Exceptions\MessageBuilderException;

final class Message
{
    use MessageBuilderTrait;

    private ApiClient $api;
    private UpdateContext $context;
    private ZG $ZG;

    public function __construct(?string $text, ZG $ZG)
    {
        $this->messageData['text'] = $text;
        $this->api = $ZG->api;
        $this->context = $ZG->context;
        $this->ZG = $ZG;
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ.
     * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –º–µ—Ç–æ–¥ API (sendMessage, sendPhoto, sendMediaGroup
     * –∏ —Ç.–¥.)
     *
     * @param int|string|null $chat_id
     *
     * @return array –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ (–∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏
     *               –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ)
     *
     * @throws \JsonException
     * @throws \Amp\Http\Client\HttpException
     * @throws \ZenithGram\ZenithGram\Exceptions\MessageBuilderException
     * @see https://zenithgram.github.io/classes/messageMethods/send
     */
    public function send(int|string|null $chat_id = null): array
    {
        if ($this->mediaPreviewUrl !== '') {
            $this->applyMediaPreview();
        }

        $params = ['chat_id' => $chat_id ?: $this->context->getChatId()];

        if ($this->reply_markup_raw !== []) {
            $this->buildReplyMarkup();
        }

        $commonParams = array_merge($params, $this->additionally_params);

        if ($this->sendDice) {
            return $this->api->callAPI(
                'sendDice', array_merge($commonParams, $this->messageData),
            );
        }

        if ($this->sendSticker) {
            $stickerParams = [
                'sticker'      => $this->messageData['sticker'],
                'reply_markup' => $this->messageData['reply_markup'] ?? '',
            ];

            return $this->api->callAPI(
                'sendSticker', array_merge($commonParams, $stickerParams),
            );
        }

        $mediaCount = count($this->mediaQueue);

        if ($mediaCount === 0) {
            return $this->api->callAPI(
                'sendMessage', array_merge($commonParams, $this->messageData),
            );
        }

        $captionData = $this->messageData;
        $captionData['caption'] = $captionData['text'] ?? '';
        unset($captionData['text']);

        if ($mediaCount === 1) {
            return $this->sendSingleMedia(
                $this->mediaQueue[0], $commonParams, $captionData,
            );
        }

        if ($this->canBeGrouped($this->mediaQueue)) {
            $mediaGroupParams = $this->buildMediaGroupParams(
                $this->mediaQueue, $captionData,
            );

            return $this->api->callAPI(
                'sendMediaGroup', array_merge(
                $commonParams,
                $mediaGroupParams,
            ),
            );
        }

        throw new MessageBuilderException(
            "–í—ã –¥–æ–±–∞–≤–∏–ª–∏ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Ç–∏–ø—ã –º–µ–¥–∏–∞. –ü—Ä–∏–º–µ—Ä: –Ω–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–æ–ª–æ—Å–æ–≤—ã—Ö",
        );

    }

    /**
     * –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
     *
     * @param string|int|null $message_id
     * @param string|int|null $chat_id
     *
     * @return array
     *
     * @throws \Exception
     *
     * @see https://zenithgram.github.io/classes/messageMethods/editText
     */

    public function editText(string|int|null $message_id = null,
        string|int|null $chat_id = null,
    ): array {
        $params = $this->getIdentifier($message_id, $chat_id);

        if ($this->reply_markup_raw !== []) {
            $this->buildReplyMarkup();
        }

        $commonParams = array_merge($params, $this->additionally_params);
        $commonParams += $this->messageData;


        return $this->api->callAPI('editMessageText', $commonParams);
    }

    /**
     * –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–ª–∏—á–∏–µ –º–µ–¥–∏–∞
     * –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏)
     *
     * @param string|int|null $message_id
     * @param string|int|null $chat_id
     *
     * @return array
     *
     * @throws \Exception
     *
     * @see https://zenithgram.github.io/classes/messageMethods/editCaption
     */
    public function editCaption(string|int|null $message_id = null,
        string|int|null $chat_id = null,
    ): array {
        $params = $this->getIdentifier($message_id, $chat_id);

        if ($this->reply_markup_raw !== []) {
            $this->buildReplyMarkup();
        }

        $this->messageData['caption'] = $this->messageData['text'];
        $this->messageData['caption_entities'] = $this->messageData['entities'];
        unset($this->messageData['text'], $this->messageData['entities']);

        $commonParams = array_merge($params, $this->additionally_params);
        $commonParams += $this->messageData;

        return $this->api->callAPI('editMessageCaption', $commonParams);
    }

    /**
     * –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –º–µ–¥–∏–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
     *
     * @param string|int|null $message_id
     * @param string|int|null $chat_id
     *
     * @return array
     *
     * @throws \Exception
     *
     * @see https://zenithgram.github.io/classes/messageMethods/editCaption
     */
    public function editMedia(string|int|null $message_id = null,
        string|int|null $chat_id = null,
    ): array {
        $params = $this->getIdentifier($message_id, $chat_id);

        if (count($this->mediaQueue) !== 1) {
            throw new MessageBuilderException(
                "–î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–¥–∏–∞ (editMedia) –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã",
            );
        }

        if ($this->reply_markup_raw !== []) {
            $this->buildReplyMarkup();
        }

        $item = $this->mediaQueue[0];
        $inputMediaData = $this->prepareInputMediaForEdit($item);

        $params['media'] = $inputMediaData['media'];

        if (!empty($inputMediaData['attachments'])) {
            $params = array_merge($params, $inputMediaData['attachments']);
        }

        $finalParams = array_merge($params, $this->additionally_params);
        $finalParams += $this->messageData;

        return $this->api->callAPI('editMessageMedia', $finalParams);
    }

    private function getIdentifier(string|int|null $message_id,
        string|int|null $chat_id,
    ): array {
        $updateData = $this->context->getUpdateData();

        if (isset($updateData['callback_query']['inline_message_id'])) {
            return ['inline_message_id' => $updateData['callback_query']['inline_message_id']];
        }

        return [
            'chat_id'    => $chat_id ?: $this->context->getChatId(),
            'message_id' => $message_id ?: $this->context->getMessageId(),
        ];
    }

    private function sendSingleMedia(array $item, array $commonParams,
        array $captionData,
    ): array {
        $type = $item['type'];
        $payload = $item['payload'];

        $method = 'send'.$this->mapTypeToApiMethod($type);
        $fieldName = $this->mapTypeToField($type);

        $params = array_merge($commonParams, $captionData);
        $params[$fieldName] = $payload;

        return $this->api->callAPI($method, $params);
    }

    private function canBeGrouped(array $queue): bool
    {
        if (empty($queue)) {
            return false;
        }

        foreach ($queue as $item) {
            if ($item['type'] === 'voice') {
                return false;
            }
        }

        $firstGroup = $this->getMediaTypeGroup($queue[0]['type']);

        foreach ($queue as $item) {
            if ($this->getMediaTypeGroup($item['type']) !== $firstGroup) {
                return false;
            }
        }

        return true;
    }

    private function getMediaTypeGroup(string $type): string
    {
        return match ($type) {
            'img', 'photo', 'video', 'animation' => 'visual',
            'audio' => 'audio',
            'document', 'doc' => 'document',
            default => 'unknown',
        };
    }

    private function prepareInputMediaForEdit(array $item): array
    {
        $originalType = $item['type'];

        $type = match ($originalType) {
            'img' => 'photo',
            'doc' => 'document',
            default => $originalType,
        };

        $inputMedia = ['type' => $type];
        $attachments = [];

        if ($item['payload'] instanceof LocalFile) {
            $attachKey = 'media_file_upload';
            $attachments[$attachKey] = $item['payload'];
            $inputMedia['media'] = 'attach://'.$attachKey;
        } else {
            $inputMedia['media'] = $item['payload'];
        }

        // –î–æ–±–∞–≤–ª—è–µ–º caption –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ Message
        if (!empty($this->messageData['text'])) {
            $inputMedia['caption'] = $this->messageData['text'];
        }
        if (!empty($this->messageData['parse_mode'])) {
            $inputMedia['parse_mode'] = $this->messageData['parse_mode'];
        }
        if (!empty($this->messageData['entities'])) {
            $inputMedia['caption_entities'] = $this->messageData['entities'];
        }

        return ['media' => $inputMedia, 'attachments' => $attachments];
    }

    private function buildMediaGroupParams(array $queue, array $commonData,
    ): array {
        $mediaArray = [];
        $attachments = [];

        foreach ($queue as $index => $item) {
            $originalType = $item['type'];

            $type = match ($originalType) {
                'img' => 'photo',
                'animation' => 'video',
                default => $originalType,
            };

            $inputMedia = ['type' => $type];

            if ($item['payload'] instanceof LocalFile) {
                $attachKey = 'media_attach_'.$index;
                $attachments[$attachKey] = $item['payload'];
                $inputMedia['media'] = 'attach://'.$attachKey;
            } else {
                $inputMedia['media'] = $item['payload'];
            }

            if ($index === 0) {
                if (!empty($commonData['caption'])) {
                    $inputMedia['caption'] = $commonData['caption'];
                }
                if (!empty($commonData['parse_mode'])) {
                    $inputMedia['parse_mode'] = $commonData['parse_mode'];
                }
                if (!empty($commonData['entities'])) {
                    $inputMedia['caption_entities'] = $commonData['entities'];
                }
            }

            $mediaArray[] = $inputMedia;
        }

        return array_merge(['media' => $mediaArray], $attachments);
    }

    private function mapTypeToApiMethod(string $type): string
    {
        return match ($type) {
            'img', 'photo' => 'Photo',
            'animation' => 'Animation',
            'voice' => 'Voice',
            'audio' => 'Audio',
            'video' => 'Video',
            'document', 'doc' => 'Document',
            default => 'Document',
        };
    }

    private function mapTypeToField(string $type): string
    {
        return match ($type) {
            'img', 'photo' => 'photo',
            'animation' => 'animation',
            'voice' => 'voice',
            'audio' => 'audio',
            'video' => 'video',
            'document', 'doc' => 'document',
            default => 'document',
        };
    }

    private function buildReplyMarkup(): void
    {
        $is_inline = isset($this->reply_markup_raw['inline_keyboard']);
        $buttons = $is_inline ? $this->reply_markup_raw['inline_keyboard']
            : $this->reply_markup_raw['keyboard'];

        $searchBotButtons = false;
        foreach ($buttons as $row) {
            if (!is_array($row)) {
                throw new MessageBuilderException("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã");
            }
            foreach ($row as $button) {
                if (is_string($button)) {
                    $searchBotButtons = true;
                    break;
                }
            }
        }

        if ($searchBotButtons) {
            $buttons = $this->findBotButtons($buttons, $is_inline);
            if ($is_inline) {
                $this->reply_markup_raw['inline_keyboard'] = $buttons;
            } else {
                $this->reply_markup_raw['keyboard'] = $buttons;
            }
        }

        $this->messageData['reply_markup'] = json_encode(
            $this->reply_markup_raw, JSON_THROW_ON_ERROR,
        );
    }

    private function findBotButtons(array $gettingButtons, bool $inline): array
    {
        $botButtons = $this->ZG->getBotButtons();

        foreach ($gettingButtons as $key => $row) {
            foreach ($row as $key_2 => $button) {
                if (is_string($button)) {
                    if (isset($botButtons[$button])) {
                        if ($inline) {
                            $gettingButtons[$key][$key_2]
                                = $this->ZG->buttonCallback(
                                $botButtons[$button], $button,
                            );
                        } else {
                            $gettingButtons[$key][$key_2]
                                = $this->ZG->buttonText($botButtons[$button]);
                        }
                    } else {
                        throw new MessageBuilderException(
                            "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É $button",
                        );
                    }
                }
            }
        }

        return $gettingButtons;
    }

    private function applyMediaPreview(): void
    {
        $url = $this->mediaPreviewUrl;
        $invisibleCharacter = '‚Äã'; // U+200B

        if (($this->messageData['parse_mode'] ?? '')
            === MessageParseMode::MarkdownV2->value
            || ($this->messageData['parse_mode'] ?? '')
            === MessageParseMode::Markdown->value
        ) {
            $this->messageData['text'] = "[$invisibleCharacter](".$url.")"
                .($this->messageData['text'] ?? '');
        } elseif (($this->messageData['parse_mode'] ?? '')
            === MessageParseMode::HTML->value
        ) {
            $this->messageData['text'] = "<a href=\"".$url."\">"
                .$invisibleCharacter."</a>"
                .($this->messageData['text'] ?? '');
        } else {
            $this->messageData['text'] = $invisibleCharacter
                .($this->messageData['text'] ?? '');

            $lengthInUtf16 = strlen(
                    mb_convert_encoding(
                        $invisibleCharacter, 'UTF-16LE', 'UTF-8',
                    ),
                ) / 2;

            $entity = [
                'type'   => 'text_link',
                'offset' => 0,
                'length' => $lengthInUtf16,
                'url'    => $url,
            ];

            $currentEntities = [];
            if (isset($this->messageData['entities'])
                && is_string(
                    $this->messageData['entities'],
                )
            ) {
                $currentEntities = json_decode(
                    $this->messageData['entities'], true,
                ) ?? [];
            }

            array_unshift($currentEntities, $entity);
            $this->messageData['entities'] = json_encode($currentEntities);
        }
    }
}

===
File: src/Exceptions/MessageBuilderException.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Exceptions;

class MessageBuilderException extends ZenithGramException {}


===
File: src/Exceptions/RouteException.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Exceptions;

class RouteException extends ZenithGramException {}


===
File: src/Exceptions/ZenithGramException.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Exceptions;

class ZenithGramException extends \Exception {}


===
File: src/Exceptions/NetworkException.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Exceptions;

class NetworkException extends ZenithGramException {}


===
File: src/Exceptions/TelegramApiException.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Exceptions;

class TelegramApiException extends ZenithGramException
{
    private array $parameters;

    public function __construct(string $message, int $code = 0, array $parameters = [])
    {
        parent::__construct($message, $code);
        $this->parameters = $parameters;
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑–≤–∞–ª –æ—à–∏–±–∫—É (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
     */
    public function getParameters(): array
    {
        return $this->parameters;
    }
}

===
File: src/ZG.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram;

use Exception;
use LogicException;
use ZenithGram\ZenithGram\Dto\ChatDto;
use ZenithGram\ZenithGram\Dto\MessageDto;
use ZenithGram\ZenithGram\Dto\UserDto;
use ZenithGram\ZenithGram\Enums\ChatAction;
use ZenithGram\ZenithGram\Enums\InlineType;
use ZenithGram\ZenithGram\Storage\StorageInterface;
use ZenithGram\ZenithGram\Interfaces\ApiClientInterface;

class ZG
{
    use ErrorHandler;
    private ?StorageInterface $storage = null;

    public function __construct(
        public readonly ApiClientInterface $api,
        public readonly UpdateContext $context,
    ) {}

    /**
     * –°–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ ZG
     *
     * @param string $token   –¢–æ–∫–µ–Ω, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –≤ BotFather
     * @param string $baseUrl –ê–¥—Ä–µ—Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ Telegram (–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:
     *                        https://api.telegram.org)
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/zenith
     */
    public static function create(string $token,
        string $baseUrl = ApiClient::DEFAULT_API_URL,
    ): self {

        $api = new ApiClient($token, $baseUrl);
        $context = UpdateContext::fromWebhook();

        return new self($api, $context);
    }

    /**
     * –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤—ã–∑–æ–≤ –∫ Telegram Bot API.
     *
     * @param string     $method
     * @param array|null $params
     *
     * @return array
     *
     * @throws Exception
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/callAPI
     */
    public function callAPI(string $method, ?array $params = []): array
    {
        return $this->api->callAPI($method, $params);
    }

    /**
     * –Ø–≤–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç 200 OK Telegram'—É.
     * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ Bot::run() –∏–ª–∏ –≤—Ä—É—á–Ω—É—é.
     *
     * @return void
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/sendOk
     */
    public function sendOk(): void
    {
        if (!headers_sent()) {
            http_response_code(200);
            header('Content-Type: text/plain');
        }

        echo 'ok';

        if (function_exists('fastcgi_finish_request')) {
            fastcgi_finish_request();
        }
    }

    /**
     * –ú–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ Message –¥–ª—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
     *
     * @param string $text
     *
     * @return Message
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/msg
     */
    public function msg(string $text = ''): Message
    {
        return new Message(
            $text, $this,
        );
    }

    /**
     * –ú–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ Poll –¥–ª—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –æ–ø—Ä–æ—Å–æ–≤
     *
     * @param string $type
     *
     * @return Poll
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/poll
     */
    public function poll(string $type = 'regular'): Poll
    {
        return new Poll($type, $this->api, $this->context);
    }

    /**
     * –ú–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ Inline –¥–ª—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ Inline-–∑–∞–ø—Ä–æ—Å–æ–≤
     *
     * @param InlineType $type
     *
     * @return Inline
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/inline
     */
    public function inline(InlineType $type = InlineType::Article): Inline
    {
        return new Inline($type);
    }

    /**
     * –ú–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ Pagination –¥–ª—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
     *
     * @return \ZenithGram\ZenithGram\Pagination
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/pagination
     */
    public function pagination(): Pagination
    {
        return new Pagination();
    }

    /**
     * –ú–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ File –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
     *
     * @param string $file_id
     *
     * @return File
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/file
     */
    public function file(string $file_id): File
    {
        return new File($file_id, $this->api);
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π (FSM)
     *
     * @param StorageInterface $storage –û–±—ä–µ–∫—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
     *
     * @return ZG
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/setStorage
     */
    public function setStorage(StorageInterface $storage): self
    {
        $this->storage = $storage;

        return $this;
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä —Ç–µ–∫—É—â–µ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–ª—è –ø—Ä—è–º—ã—Ö –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π
     *
     * @return StorageInterface|null
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/storage
     */
    public function getStorage(): ?StorageInterface
    {
        return $this->storage;
    }

    /**
     * –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (—Å–æ—Å—Ç–æ—è–Ω–∏–µ)
     *
     * @param string $state –ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
     *
     * @return void
     *
     * @throws LogicException|\JsonException –ï—Å–ª–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/step
     */
    public function step(string $state): void
    {
        if (!$this->storage) {
            throw new LogicException(
                'Storage is not configured. Use Bot->setStorage().',
            );
        }
        $userId = $this->getUserId();
        if ($userId) {
            $this->storage->setState($userId, $state);
        }
    }

    /**
     * –ó–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —à–∞–≥ (—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
     *
     * –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–∏
     *
     * @param bool $clear_data –£–¥–∞–ª—è—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ True/False
     *
     * @return void
     *
     * @throws LogicException|\JsonException –ï—Å–ª–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/endStep
     */
    public function endStep(bool $clear_data = true): void
    {
        if (!$this->storage) {
            throw new LogicException('Storage is not configured.');
        }
        $user_id = $this->getUserId();
        if ($user_id) {
            $this->storage->clearState($user_id);
            if ($clear_data) {
                $this->storage->clearSessionData($user_id);
            }
        }
    }

    /**
     * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–µ—Å—Å–∏–∏
     *
     * –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –º–∞—Å—Å–∏–≤ $data ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç (–º–µ—Ä–∂–∏—Ç) –¥–∞–Ω–Ω—ã–µ.
     * –ï—Å–ª–∏ $data –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
     *
     * @param array|null $data –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
     *
     * @return array –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏
     *
     * @throws LogicException –ï—Å–ª–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/session
     */
    public function session(?array $data = null): array
    {
        if (!$this->storage) {
            throw new LogicException('Storage is not configured.');
        }

        $user_id = $this->getUserId();
        if (!$user_id) {
            return [];
        }

        if ($data !== null) {
            $this->storage->setSessionData($user_id, $data);

            return $this->storage->getSessionData($user_id);
        }

        return $this->storage->getSessionData($user_id);
    }

    /**
     * –ú–µ—Ç–æ–¥ —É–¥–∞–ª—è–µ—Ç –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π
     *
     * @param array|int|null  $msg_ids
     * @param int|string|null $chat_id
     *
     * @return array
     *
     * @throws \Exception
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/delMsg
     */
    public function delMsg(array|int|null $msg_ids = null,
        int|string|null $chat_id = null,
    ): array {
        $msg_ids ??= $this->context->getMessageId();
        $chat_id ??= $this->context->getChatId();

        if (is_array($msg_ids)) {
            $method = 'deleteMessages';
            $params = ['message_ids' => $msg_ids];
        } else {
            $method = 'deleteMessage';
            $params = ['message_id' => $msg_ids];
        }

        $params['chat_id'] = $chat_id;

        return $this->api->callAPI(
            $method, $params,
        );
    }

    /**
     * –ú–µ—Ç–æ–¥ –∫–æ–ø–∏—Ä—É–µ—Ç –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π
     *
     * @param int|array|null  $msg_ids      ID —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –º–∞—Å—Å–∏–≤ ID
     *                                      —Å–æ–æ–±—â–µ–Ω–∏–π
     * @param int|string|null $chat_id      –ö—É–¥–∞ –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
     *                                      —Ç–µ–∫—É—â–∏–π —á–∞—Ç)
     * @param int|string|null $from_chat_id –û—Ç–∫—É–¥–∞ –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑
     *                                      chat_id)
     * @param array           $params       –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (caption,
     *                                      parse_mode, reply_markup,
     *                                      message_thread_id)
     *
     * @return array
     *
     * @throws \Amp\Http\Client\HttpException
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/copyMsg
     * @see https://core.telegram.org/bots/api#copyMessages
     * @see https://core.telegram.org/bots/api#copyMessage
     */
    public function copyMsg(int|array|null $msg_ids = null,
        int|string|null $chat_id = null, int|string|null $from_chat_id = null,
        array $params = [],
    ): array {
        $msg_ids ??= $this->context->getMessageId();
        $chat_id ??= $this->context->getChatId();
        $from_chat_id ??= $chat_id;

        $isArray = is_array($msg_ids);

        if ($isArray) {
            $method = 'copyMessages';
            $baseParams = ['message_ids' => $msg_ids];
        } else {
            $method = 'copyMessage';
            $baseParams = ['message_id' => $msg_ids];
        }

        $baseParams['chat_id'] = $chat_id;
        $baseParams['from_chat_id'] = $from_chat_id;

        $payload = array_merge($baseParams, $params);

        return $this->api->callAPI($method, $payload);
    }

    /**
     * –ú–µ—Ç–æ–¥ –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π
     *
     * @param int|array|null  $msg_ids      ID —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –º–∞—Å—Å–∏–≤ ID
     *                                      —Å–æ–æ–±—â–µ–Ω–∏–π
     * @param int|string|null $chat_id      –ö—É–¥–∞ –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
     *                                      —Ç–µ–∫—É—â–∏–π —á–∞—Ç)
     * @param int|string|null $from_chat_id –û—Ç–∫—É–¥–∞ –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑
     *                                      chat_id)
     * @param array           $params       –î–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (message_thread_id,
     *                                      disable_notification,
     *                                      protect_content)
     *
     * @return array
     *
     * @throws \Amp\Http\Client\HttpException
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/fwdMsg
     * @see https://core.telegram.org/bots/api#forwardmessages
     * @see https://core.telegram.org/bots/api#forwardmessage
     */
    public function fwdMsg(
        int|array|null $msg_ids = null,
        int|string|null $chat_id = null,
        int|string|null $from_chat_id = null,
        array $params = [],
    ): array {
        $msg_ids ??= $this->context->getMessageId();
        $chat_id ??= $this->context->getChatId();
        $from_chat_id ??= $chat_id;

        if (is_array($msg_ids)) {
            $method = 'forwardMessages';
            $baseParams = ['message_ids' => $msg_ids];
        } else {
            $method = 'forwardMessage';
            $baseParams = ['message_id' => $msg_ids];
        }

        $baseParams['chat_id'] = $chat_id;
        $baseParams['from_chat_id'] = $from_chat_id;

        $payload = array_merge($baseParams, $params);

        return $this->api->callAPI($method, $payload);
    }

    /**
     * –ó–∞–∫—Ä–µ–ø–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
     *
     * @param int|null        $msg_id               ID —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç
     *                                              –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ
     * @param int|string|null $chat_id              ID —á–∞—Ç–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç
     *                                              –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
     * @param bool            $disable_notification –í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫? True/False
     *
     * @return array
     *
     * @throws \Amp\Http\Client\HttpException
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/pinMsg
     */
    public function pinMsg(
        int|null $msg_id = null,
        int|string|null $chat_id = null,
        bool $disable_notification = false,
    ): array {
        $msg_id ??= $this->context->getMessageId();
        $chat_id ??= $this->context->getChatId();

        return $this->api->callAPI('pinChatMessage', [
            'chat_id'              => $chat_id,
            'message_id'           => $msg_id,
            'disable_notification' => $disable_notification,
        ]);
    }

    /**
     * –û—Ç–∫—Ä–µ–ø–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
     *
     * @param int|null        $msg_id  ID —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç
     *                                 –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ
     * @param int|string|null $chat_id ID —á–∞—Ç–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç
     *                                 –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
     * @param bool            $all     –û—Ç–∫—Ä–µ–ø–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è? True/False
     *
     * @return array
     *
     * @throws \Amp\Http\Client\HttpException
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/unpinMsg
     */
    public function unpinMsg(
        int|null $msg_id = null,
        int|string|null $chat_id = null,
        bool $all = false,
    ): array {
        $chat_id ??= $this->context->getChatId();

        $params = ['chat_id' => $chat_id];

        if ($all) {
            $method = 'unpinAllChatMessage';
        } else {
            $msg_id ??= $this->context->getMessageId();
            $params['message_id'] = $msg_id;
            $method = 'unpinChatMessage';
        }

        return $this->api->callAPI($method, $params);
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ –±–æ—Ç–∞
     *
     * @param ChatAction $action –û–¥–Ω–æ –∏–∑ –¥–µ–π—Å—Ç–≤–∏–π –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è (Enum)
     *
     *                           –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: Typing
     *
     * @return ZG
     *
     * @throws \Exception
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/sendAction
     */
    public function sendAction(ChatAction $action = ChatAction::Typing,
    ): self {
        $this->api->callAPI(
            'sendChatAction',
            ['chat_id' => $this->context->getChatId(),
             'action'  => $action->value,
            ],
        );

        return $this;
    }

    /**
     * –ú–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
     *
     * @param int|string $chat_id
     * @param string     $text
     * @param array      $params
     *
     * @return array
     *
     * @throws \Exception
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/sendMessage
     */
    public function sendMessage(int|string $chat_id, string $text,
        array $params = [],
    ): array {
        $params_message = [
            'chat_id' => $chat_id,
            'text'    => $text,
        ];

        return $this->api->callAPI(
            'sendMessage', $params_message + $params,
        );
    }

    /**
     * –ú–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
     *
     * @param string $text
     * @param array  $params
     *
     * @return array
     *
     * @throws \Exception
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/reply
     */
    public function reply(string $text, array $params = []): array
    {
        if (!isset($params['chat_id'])) {
            $params['chat_id'] = $this->context->getChatId();
        }

        return $this->api->callAPI(
            'sendMessage', array_merge($params, ['text' => $text]),
        );
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç callback-–∫–Ω–æ–ø–∫—É
     *
     * –£—Å—Ç–∞—Ä–µ–≤—à–∏–π –∞–ª–∏–∞—Å –º–µ—Ç–æ–¥–∞ Keyboard::cb()
     *
     * @param string $buttonText –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
     * @param string $buttonData –î–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
     *
     * @return array
     */
    public function buttonCallback(string $buttonText, string $buttonData,
    ): array {
        return Button::cb($buttonText, $buttonData);
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç url-–∫–Ω–æ–ø–∫—É
     *
     * –£—Å—Ç–∞—Ä–µ–≤—à–∏–π –∞–ª–∏–∞—Å –º–µ—Ç–æ–¥–∞ Keyboard::url()
     *
     * @param string $buttonText –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
     * @param string $buttonUrl  URL
     *
     * @return array
     */
    public function buttonUrl(string $buttonText, string $buttonUrl): array
    {
        return Button::url($buttonText, $buttonUrl);
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—É—é –∫–Ω–æ–ø–∫—É
     *
     * –£—Å—Ç–∞—Ä–µ–≤—à–∏–π –∞–ª–∏–∞—Å –º–µ—Ç–æ–¥–∞ Keyboard::text()
     *
     * @param string $buttonText –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
     *
     * @return array
     */
    public function buttonText(string $buttonText): array
    {
        return Button::text($buttonText);
    }

    /**
     * –ú–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –¢–µ–ª–µ–≥—Ä–∞–º—É –Ω–∞ callback-–∑–∞–ø—Ä–æ—Å
     *
     * @param string|array|null $queryIdOrParams –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å ID
     *                                           (ZG::getQueryId), –∏–ª–∏ —Å—Ä–∞–∑—É
     *                                           –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–∏–ø–∞ ['text'
     *                                           => '–í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ']
     * @param array             $params          –ï—Å–ª–∏ –≤ –ø–µ—Ä–≤–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–µ —É–∫–∞–∑–∞–Ω
     *                                           ID, —Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å
     *                                           –≤—Ç–æ—Ä—ã–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º
     *
     * @return array
     * @throws \Exception
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/answers#answercallbackquery
     */
    public function answerCallbackQuery(string|array|null $queryIdOrParams = null,
        array $params = [],
    ): array {
        if (is_array($queryIdOrParams) || $queryIdOrParams === null) {
            $queryId = $this->context->getQueryId();
            $params = array_merge($params, $queryIdOrParams ?? []);
        } else {
            $queryId = $queryIdOrParams;
        }

        $params_methods = array_merge([
            'callback_query_id' => $queryId,
        ], $params);

        return $this->api->callAPI('answerCallbackQuery', $params_methods);
    }

    /**
     * –ú–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –¢–µ–ª–µ–≥—Ä–∞–º—É –Ω–∞ inline-–∑–∞–ø—Ä–æ—Å
     *
     * @param string|array $queryIdOrResults ID –∑–∞–ø—Ä–æ—Å–∞ (string) –∏–ª–∏ —Å—Ä–∞–∑—É
     *                                       –º–∞—Å—Å–∏–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (array), —Ç–æ–≥–¥–∞
     *                                       ID –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
     * @param array        $resultsOrParams  –ï—Å–ª–∏ 1-–π –∞—Ä–≥—É–º–µ–Ω—Ç ID, —Ç–æ –∑–¥–µ—Å—å
     *                                       —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã. –ï—Å–ª–∏ 1-–π ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã,
     *                                       —Ç–æ –∑–¥–µ—Å—å –¥–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (extra).
     * @param array        $extra            –î–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã ID –∏
     *                                       —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–≤—ã–º–∏ –¥–≤—É–º—è
     *                                       –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏).
     *
     * @return array
     * @throws \JsonException
     * @throws \Exception
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/answers#answerinlinequery
     */
    public function answerInlineQuery(string|array $queryIdOrResults,
        array $resultsOrParams = [], array $extra = [],
    ): array {
        if (is_array($queryIdOrResults)) {
            $queryId = $this->context->getQueryId();
            $results = $queryIdOrResults;
            $params = $resultsOrParams;
        } else {
            $queryId = $queryIdOrResults;
            $results = $resultsOrParams;
            $params = $extra;
        }

        $basePayload = [
            'inline_query_id' => $queryId,
            'results'         => json_encode($results, JSON_THROW_ON_ERROR),
        ];

        return $this->api->callAPI(
            'answerInlineQuery', array_merge($basePayload, $params),
        );
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
     *
     * @param $chat_id
     * @param $user_id
     * @param $text
     * @param $type
     * @param $callback_data
     * @param $query_id
     * @param $msg_id
     * @param $is_bot
     * @param $is_command
     *
     * @return array
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/initVars
     */
    public function initVars(
        &$chat_id = null,
        &$user_id = null,
        &$text = null,
        &$type = null,
        &$callback_data = null,
        &$query_id = null,
        &$msg_id = null,
        &$is_bot = null,
        &$is_command = null,
    ): array {
        $update = $this->context->getUpdateData();

        $user_id = $this->context->getUserId();
        $chat_id = $this->context->getChatId();
        $text = $this->context->getText();
        $msg_id = $this->context->getMessageId();
        $type = $this->context->getType();
        $query_id = $this->context->getQueryId();
        $callback_data = $this->context->getCallbackData();

        if (isset($update['message'])) {
            $is_bot = $update['message']['from']['is_bot'];

            $is_command = (isset($update['message']['entities'][0]['type'])
                && $update['message']['entities'][0]['type'] === 'bot_command');

        } elseif (isset($update['callback_query'])) {
            $is_bot = $update['callback_query']['from']['is_bot'];

            $is_command = false;

        } elseif (isset($update['inline_query'])) {
            $is_bot = $update['inline_query']['from']['is_bot'];

            $is_command = false;

        }

        return $update;
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç
     * @internal
     */
    public function getContext(): UpdateContext
    {
        return $this->context;
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
     *
     * @return array
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/get#getupdate
     */
    public function getUpdate(): array
    {
        return $this->context->getUpdateData();
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é callback_data
     *
     * @return string|null
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/get#getcallbackdata
     */
    public function getCallbackData(): string|null
    {
        return $this->context->getCallbackData();
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é query_id
     *
     * @return string|null
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/get#getqueryid
     */
    public function getQueryId(): string|null
    {
        return $this->context->getQueryId();
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é type
     *
     * @return string|null
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/get#gettype
     */
    public function getType(): string|null
    {
        return $this->context->getType();
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é msg_id
     *
     * @return int|string|null
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/get#getmsgid
     */
    public function getMsgId(): int|string|null
    {
        return $this->context->getMessageId();
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é msg_id –∏–∑ –æ—Ç–≤–µ—á–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
     *
     * @return int|string|null
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/get#getreplymsgid
     */
    public function getReplyMsgId(): int|string|null
    {
        return $this->context->getReplyMessageId();
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é text
     *
     * @return string|null
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/get#gettext
     */
    public function getText(): string|null
    {
        return $this->context->getText();
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é text –∏–∑ –æ—Ç–≤–µ—á–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
     *
     * @return string|null
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/get#getreplytext
     */
    public function getReplyText(): string|null
    {
        return $this->context->getReplyText();
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é user_id
     *
     * @return int|string|null user_id
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/get#getuserid
     */
    public function getUserId(): int|string|null
    {
        return $this->context->getUserId();
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é user_id –∏–∑ –æ—Ç–≤–µ—á–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
     *
     * @return int|string|null user_id
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/get#getreplyuserid
     */
    public function getReplyUserId(): int|string|null
    {
        return $this->context->getReplyUserId();
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é chat_id
     *
     * @return int|string|null
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/get#getchatid
     */
    public function getChatId(): int|string|null
    {
        return $this->context->getChatId();
    }

    /**
     * –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ª—é–±–æ–≥–æ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –ø–æ–ª—è –≤ —Ç–µ–∫—É—â–µ–º
     * —Å–æ–±—ã—Ç–∏–∏.
     *
     * –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ —É–Ω–∏–≤–µ—Ä—Å–∞–ª–µ–Ω –∏ –∏—â–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ('from') –≤ —Ç–∞–∫–∏—Ö
     * —Å–æ–±—ã—Ç–∏—è—Ö, –∫–∞–∫ message, callback_query, inline_query, my_chat_member –∏
     * –¥—Ä—É–≥–∏—Ö.
     *
     * @return UserDto –û–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @throws LogicException –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Å–æ–±—ã—Ç–∏–∏.
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/get#getuser
     */
    public function getUser(): UserDto
    {
        $update = $this->context->getUpdateData();
        $user = null;

        $keys = [
            'message',
            'edited_message',
            'callback_query',
            'inline_query',
            'my_chat_member',
            'chat_member',
            'chat_join_request',
        ];

        foreach ($keys as $key) {
            if (isset($update[$key]['from'])) {
                $user = $update[$key]['from'];
                break;
            }
        }

        if ($user === null) {
            throw new LogicException(
                "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ('from') –≤ —Ç–µ–∫—É—â–µ–º —Å–æ–±—ã—Ç–∏–∏.",
            );
        }

        return UserDto::fromArray($user);
    }

    /**
     * –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞ –∏–∑ –ª—é–±–æ–≥–æ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –ø–æ–ª—è –≤ —Ç–µ–∫—É—â–µ–º —Å–æ–±—ã—Ç–∏–∏.
     *
     * –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ —É–Ω–∏–≤–µ—Ä—Å–∞–ª–µ–Ω –∏ –∏—â–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞ ('chat') –≤ —Ç–∞–∫–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö,
     * –∫–∞–∫ message, callback_query, channel_post, my_chat_member –∏ –¥—Ä—É–≥–∏—Ö,
     * –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—è –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
     *
     * @return ChatDto –û–±—ä–µ–∫—Ç —á–∞—Ç–∞.
     * @throws LogicException –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Å–æ–±—ã—Ç–∏–∏.
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/get#getchat
     */
    public function getChat(): ChatDto
    {
        $update = $this->context->getUpdateData();
        $chatData = null;

        $paths = [
            ['message', 'chat'],
            ['edited_message', 'chat'],
            ['channel_post', 'chat'],
            ['edited_channel_post', 'chat'],
            ['my_chat_member', 'chat'],
            ['chat_member', 'chat'],
            ['chat_join_request', 'chat'],
            ['callback_query', 'message', 'chat'],
        ];

        foreach ($paths as $path) {
            $temp = $update;
            $found = true;

            foreach ($path as $key) {
                if (!isset($temp[$key])) {
                    $found = false;
                    break;
                }
                $temp = $temp[$key];
            }

            if ($found) {
                $chatData = $temp;
                break;
            }
        }

        if ($chatData === null) {
            throw new LogicException(
                "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞ ('chat') –≤ —Ç–µ–∫—É—â–µ–º —Å–æ–±—ã—Ç–∏–∏.",
            );
        }

        return ChatDto::fromArray($chatData);
    }

    /**
     * –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –ª—é–±–æ–≥–æ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –ø–æ–ª—è –≤ —Ç–µ–∫—É—â–µ–º —Å–æ–±—ã—Ç–∏–∏.
     *
     * –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ —É–Ω–∏–≤–µ—Ä—Å–∞–ª–µ–Ω –∏ –∏—â–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ('message') –≤ —Ç–∞–∫–∏—Ö
     * —Å–æ–±—ã—Ç–∏—è—Ö, –∫–∞–∫ message, callback_query, channel_post, my_chat_member –∏
     * –¥—Ä—É–≥–∏—Ö, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—è –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
     *
     * @return MessageDto –û–±—ä–µ–∫—Ç —á–∞—Ç–∞.
     * @throws LogicException –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Å–æ–±—ã—Ç–∏–∏.
     *
     * @see https://zenithgram.github.io/classes/zenithMethods/get#getmessage
     */
    public function getMessage(): MessageDto
    {
        $update = $this->context->getUpdateData();

        $messageData = $update['message']
            ?? $update['callback_query']['message']
            ?? $update['edited_message']
            ?? $update['channel_post']
            ?? $update['edited_channel_post']
            ?? null;

        if ($messageData !== null) {
            return MessageDto::fromArray($messageData);
        }

        throw new LogicException(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ('Message') –≤ —Ç–µ–∫—É—â–µ–º —Å–æ–±—ã—Ç–∏–∏.",
        );
    }

    private array $botButtons = [];

    /**
     * @internal
     */
    public function setBotButtons(array $buttons): void
    {
        $this->botButtons = $buttons;
    }

    /**
     * @internal
     */
    public function getBotButtons(): array
    {
        return $this->botButtons;
    }
}

===
File: src/LongPoll.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram;

use Closure;
use Throwable;
use ZenithGram\ZenithGram\Interfaces\ApiClientInterface;

use function Amp\async;
use function Amp\delay;

class LongPoll
{
    private int $offset = 0;
    private bool $skipOldUpdates = false;
    private bool $shortTrace = false;
    private string $pathFiler = '';
    private array|null $debug_chat_ids = null;
    private bool $debug = false;
    private Closure|null $handler = null;
    private array $allowedUpdates = [];

    public function __construct(
        public readonly ApiClientInterface $api,
        private readonly int $timeout = 20,
    ) {}

    /**
     * –°–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ LongPoll </br>
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Ç–∏–≤–Ω—ã–π ApiClient –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
     *
     * @param string $token   –¢–æ–∫–µ–Ω Telegram
     * @param int    $timeout –°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Telegram
     * @param string $baseUrl –ê–¥—Ä–µ—Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ Telegram (–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:
     *                        https://api.telegram.org)
     *
     * @return LongPoll
     *
     * @see https://zenithgram.github.io/classes/longpoll
     */
    public static function create(string $token, int $timeout = 20,
        string $baseUrl = ApiClient::DEFAULT_API_URL,
    ): self {
        return new self(new ApiClient($token, $baseUrl), $timeout);
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–∏–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –±–æ—Ç —Ö–æ—á–µ—Ç –ø–æ–ª—É—á–∞—Ç—å.
     *
     * @param array $updates –ú–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ –∏–ª–∏ Enum –∑–Ω–∞—á–µ–Ω–∏–π UpdateType.
     *                       –ü—Ä–∏–º–µ—Ä: [UpdateType::Message, 'callback_query']
     *
     * @return self
     *
     * @see https://zenithgram.github.io/classes/longpoll#allowedupdates
     */
    public function allowedUpdates(array $updates): self
    {
        $this->allowedUpdates = array_map(function($item) {
            if ($item instanceof UpdateType) {
                return $item->value;
            }

            return (string)$item;
        }, $updates);

        return $this;
    }

    /**
     * –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
     *
     * @return LongPoll
     * @see https://zenithgram.github.io/classes/longpoll#skipoldupdates
     */
    public function skipOldUpdates(): self
    {
        $this->skipOldUpdates = true;

        return $this;
    }

    /**
     * –ó–∞–ø—É—Å–∫–∞–µ—Ç –æ–ø—Ä–æ—Å —Å–µ—Ä–≤–µ—Ä–æ–≤ Telegram
     *
     * @param Closure $handler
     *
     * @return void
     * @see https://zenithgram.github.io/classes/longpoll#listen
     */
    public function listen(Closure $handler): void
    {
        $isRunning = true;

        if ($this->skipOldUpdates) {
            $this->dropPendingUpdates();
        }

        while ($isRunning) {
            try {
                $updates = $this->fetchUpdates();

                if (empty($updates)) {
                    continue;
                }

                foreach ($updates as $updateData) {
                    $this->offset = $updateData['update_id'] + 1;

                    async(function() use ($handler, $updateData) {
                        try {
                            $this->processUpdate($handler, $updateData);
                        } catch (Throwable $e) {
                            $this->reportInternalError($e, 'Update Error');
                        }
                    });
                }

            } catch (Throwable $e) {
                $this->reportInternalError($e, 'Network Error');
                delay(2);
            }
        }
    }

    private function reportInternalError(Throwable $e, $error): void
    {
        $context = new UpdateContext([]);
        $tgInstance = new ZG($this->api, $context);

        if ($this->debug) {
            $tgInstance
                ->enableDebug()
                ->shortTrace($this->shortTrace)
                ->setTracePathFilter($this->pathFiler);

            if ($this->handler !== null) {
                $tgInstance->setHandler($this->handler);
            }

            if ($this->debug_chat_ids !== null) {
                $tgInstance->setSendIds($this->debug_chat_ids);
            }

            $tgInstance->reportException($e);
        } else {
            fwrite(STDERR, "[$error] ".$e->getMessage().PHP_EOL);
        }
    }

    private function fetchUpdates(): array
    {
        $clientTimeout = $this->timeout + 15;

        $response = $this->api->callAPI(
            'getUpdates',
            [
                'offset'          => $this->offset,
                'timeout'         => $this->timeout,
                'allowed_updates' => $this->allowedUpdates,
            ],
            $clientTimeout,
        );

        return $response['result'] ?? [];
    }

    private function dropPendingUpdates(): void
    {
        try {
            $data = $this->api->callAPI(
                'getUpdates', ['limit' => 1, 'offset' => -1,],
            );
            if (!empty($data['result'])) {
                $lastUpdate = end($data['result']);
                $this->offset = $lastUpdate['update_id'] + 1;
            }
        } catch (Throwable $e) {
        }
    }

    private function processUpdate(Closure $handler, array $updateData): void
    {
        $context = new UpdateContext($updateData);

        $tgInstance = new ZG($this->api, $context);
        if ($this->debug) {
            $tgInstance
                ->enableDebug()
                ->shortTrace($this->shortTrace)
                ->setTracePathFilter($this->pathFiler);
            if ($this->handler !== null) {
                $tgInstance->setHandler($this->handler);
            }
            if ($this->debug_chat_ids !== null) {
                $tgInstance->setSendIds($this->debug_chat_ids);
            }
        }
        try {
            $handler($tgInstance);
        } catch (Throwable $e) {
            $tgInstance->reportException($e);
        }
    }

    /**
     * –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –¥–µ–±–∞–≥ —Ä–µ–∂–∏–º
     *
     * –ß—Ç–æ–±—ã –æ–Ω —Ä–∞–±–æ—Ç–∞–ª, –Ω—É–∂–Ω–æ –∑–∞–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –ª–∏–±–æ –ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç—å id, –∫—É–¥–∞
     * –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏
     *
     * @return LongPoll
     *
     * @see https://zenithgram.github.io/classes/errorhandler#enableDebug
     */
    public function enableDebug(): self
    {
        $this->debug = true;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç ID, –∫—É–¥–∞ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤–æ–∑–Ω–∏–∫—à–∏–µ –æ—à–∏–±–∫–∏
     *
     * @param int|string|array $ids ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —á–∞—Ç–∞
     *
     * @return LongPoll
     *
     * @see https://zenithgram.github.io/classes/errorhandler#setSendIds
     */
    public function setSendIds(int|string|array $ids): self
    {
        $this->debug_chat_ids = is_array($ids) ? $ids : [$ids];

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏
     *
     * @param callable $handler –û–±—Ä–∞–±–æ—Ç—á–∏–∫. –ü—Ä–∏–º–µ—Ä: function (ZG $tg, Throwable
     *                          $e)
     *
     * @return LongPoll
     *
     * @see https://zenithgram.github.io/classes/errorhandler#setHandler
     */
    public function setHandler(callable $handler): self
    {
        $this->handler = $handler(...);

        return $this;
    }

    /**
     * –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ç—Ä–µ–π—Ç –∏–ª–∏ —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π
     *
     * @param bool $short
     *
     * @return LongPoll
     *
     * @see https://zenithgram.github.io/classes/errorhandler#shortTrace
     */
    public function shortTrace(bool $short = true): self
    {
        $this->shortTrace = $short;

        return $this;
    }

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä –Ω–∞ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –µ–≥–æ
     *
     * @param string $filter "/path/to/your/project"
     *
     * @return LongPoll
     *
     * @see https://zenithgram.github.io/classes/errorhandler#setTracePathFilter
     */
    public function setTracePathFilter(string $filter): self
    {
        $this->pathFiler = $filter;

        return $this;
    }
}

===
File: src/Storage/RedisStorage.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Storage;

use Amp\Redis\RedisClient;
use Amp\Redis\RedisConfig;
use RuntimeException;
use ZenithGram\ZenithGram\Exceptions\ZenithGramException;
use function Amp\Redis\createRedisClient;
use ZenithGram\ZenithGram\Interfaces\StorageInterface;

class RedisStorage implements StorageInterface
{
    private RedisClient $redis;
    private string $prefix;

    /**
     * –°–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ Redis —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (amphp/redis)
     *
     * @param string      $host    –•–æ—Å—Ç Redis
     * @param int         $port    –ü–æ—Ä—Ç Redis
     * @param string      $prefix  –ü—Ä–µ—Ñ–∏–∫—Å –∫–ª—é—á–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'zg_fsm:')
     * @param int         $dbIndex –ò–Ω–¥–µ–∫—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
     * @param string|null $auth    –ü–∞—Ä–æ–ª—å (–µ—Å–ª–∏ –µ—Å—Ç—å)
     *
     * @throws RuntimeException
     * @throws ZenithGramException
     */
    public function __construct(
        string $host = '127.0.0.1',
        int $port = 6379,
        string $prefix = 'zg_fsm:',
        int $dbIndex = 0,
        ?string $auth = null
    ) {
        if (!class_exists(RedisClient::class)) {
            throw new ZenithGramException('–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è RedisStorage –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç "amphp/redis".');
        }

        $this->prefix = $prefix;

        try {
            $uri = "tcp://{$host}:{$port}";

            $config = RedisConfig::fromUri($uri)
                ->withDatabase($dbIndex);

            if ($auth !== null) {
                $config = $config->withPassword($auth);
            }

            $this->redis = createRedisClient($config);
        } catch (\Throwable $e) {
            throw new RuntimeException("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ RedisStorage: " . $e->getMessage(), 0, $e);
        }
    }

    private function getKey(int|string $userId): string
    {
        return $this->prefix . $userId;
    }

    /** @internal @inheritDoc */
    public function getState(int|string $user_id): ?string
    {
        try {
            $state = $this->redis->execute('HGET', $this->getKey($user_id), 'state');
            return $state === null ? null : (string)$state;
        } catch (\Throwable $e) {
            return null;
        }
    }

    /** @internal @inheritDoc */
    public function setState(int|string $user_id, string $state): void
    {
        $this->redis->getMap($this->getKey($user_id))->setValue('state', $state);
    }

    /** @internal @inheritDoc */
    public function clearState(int|string $user_id): void
    {
        $this->redis->getMap($this->getKey($user_id))->remove('state');
    }

    /** @internal @inheritDoc */
    public function getSessionData(int|string $user_id): array
    {
        try {
            $data = $this->redis->execute('HGET', $this->getKey($user_id), 'session');

            if ($data === null) {
                return [];
            }

            return json_decode((string)$data, true, 512, JSON_THROW_ON_ERROR);
        } catch (\Throwable) {
            return [];
        }
    }

    /** @internal @inheritDoc */
    public function setSessionData(int|string $user_id, array $data): void
    {
        $currentData = $this->getSessionData($user_id);
        $newData = array_merge($currentData, $data);

        $encoded = json_encode($newData, JSON_THROW_ON_ERROR | JSON_UNESCAPED_UNICODE);

        $this->redis->getMap($this->getKey($user_id))->setValue('session', $encoded);
    }

    /** @internal @inheritDoc */
    public function clearSessionData(int|string $user_id): void
    {
        $this->redis->getMap($this->getKey($user_id))->remove('session');
    }
}

===
File: src/Storage/FileStorage.php
===
<?php
declare(strict_types=1);

namespace ZenithGram\ZenithGram\Storage;

use function Amp\File\createDirectoryRecursively;
use function Amp\File\exists;
use function Amp\File\read;
use function Amp\File\write;
use function Amp\File\isDirectory;
use ZenithGram\ZenithGram\Interfaces\StorageInterface;

class FileStorage implements StorageInterface
{
    private string $storageDir;

    /**
     * –°–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä —Ñ–∞–π–ª–æ–≤–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
     *
     * @param string $path –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–π
     *
     * @see https://zenithgram.github.io/classes/storage#filestorage
     */
    public function __construct(string $path = 'storage/sessions')
    {
        $this->storageDir = rtrim($path, '/\\');
    }

    private function getFilePath(int|string $user_id): string
    {
        return $this->storageDir.DIRECTORY_SEPARATOR.$user_id.'.json';
    }

    private function load(int|string $user_id): array
    {
        $file = $this->getFilePath($user_id);

        if (exists($file)) {
            try {
                $content = read($file);
                if (empty($content)) {
                    return [];
                }

                return json_decode($content, true, 512, JSON_THROW_ON_ERROR) ??
                    [];
            } catch (\Throwable $e) {
                return [];
            }
        }

        return [];
    }

    private function save(int|string $user_id, array $data): void
    {
        if (!isDirectory($this->storageDir)) {
            try {
                createDirectoryRecursively($this->storageDir, 0777);
            } catch (\Throwable $e) {
                mkdir($this->storageDir, 0777, true);
            }
        }

        $file = $this->getFilePath($user_id);
        $content = json_encode(
            $data,
            JSON_THROW_ON_ERROR | JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE,
        );

        write($file, $content);
    }

    /** @internal @inheritDoc */
    public function getState(int|string $user_id): ?string
    {
        $data = $this->load($user_id);

        return $data['state'] ?? null;
    }

    /** @internal @inheritDoc */
    public function setState(int|string $user_id, string $state): void
    {
        $data = $this->load($user_id);
        $data['state'] = $state;
        $this->save($user_id, $data);
    }

    /** @internal @inheritDoc */
    public function clearState(int|string $user_id): void
    {
        $data = $this->load($user_id);
        if (isset($data['state'])) {
            unset($data['state']);
            $this->save($user_id, $data);
        }
    }

    /** @internal @inheritDoc */
    public function getSessionData(int|string $user_id): array
    {
        $data = $this->load($user_id);

        return $data['session'] ?? [];
    }

    /** @internal @inheritDoc */
    public function setSessionData(int|string $user_id, array $data): void
    {
        $currentData = $this->load($user_id);
        $currentData['session'] = array_merge(
            $currentData['session'] ?? [], $data,
        );
        $this->save($user_id, $currentData);
    }

    /** @internal @inheritDoc */
    public function clearSessionData(int|string $user_id): void
    {
        $currentData = $this->load($user_id);
        if (isset($currentData['session'])) {
            unset($currentData['session']);
            $this->save($user_id, $currentData);
        }
    }
}

===
File: Tests/Unit/Utils/DependencyResolverTest.php
===
<?php
declare(strict_types=1);

namespace Tests\Unit\Utils;

use PHPUnit\Framework\TestCase;
use PHPUnit\Framework\Attributes\CoversClass;
use ZenithGram\ZenithGram\Utils\DependencyResolver;
use ZenithGram\ZenithGram\ZG;
use Psr\Container\ContainerInterface;
use Psr\SimpleCache\CacheInterface;

#[CoversClass(DependencyResolver::class)]
class DependencyResolverTest extends TestCase
{
    private DependencyResolver $resolver;

    protected function setUp(): void
    {
        // üëá –í—Ä–µ–º–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        set_error_handler(function($errno, $errstr, $errfile, $errline) {
            fwrite(STDERR, "\nüõë NOTICE: $errstr\n   in $errfile:$errline\n");
            return false; // –ü–æ–∑–≤–æ–ª–∏—Ç—å PHPUnit —Ç–æ–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Ç–æ
        }, E_NOTICE | E_USER_NOTICE | E_DEPRECATED | E_USER_DEPRECATED);

        $this->resolver = new DependencyResolver();
    }


    /**
     * –¢–µ—Å—Ç 1: –†–µ–∑–æ–ª–≤–∏–Ω–≥ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤ (ZG)
     */
    public function testResolveSystemClasses(): void
    {
        $zgMock = $this->createMock(ZG::class);

        $handler = function (ZG $bot) {};

        $args = $this->resolver->resolve($handler, $zgMock);

        $this->assertCount(1, $args);
        $this->assertSame($zgMock, $args[0]);
    }

    /**
     * –¢–µ—Å—Ç 2: –†–µ–∑–æ–ª–≤–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –º–∞—Ä—à—Ä—É—Ç–∞ (–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
     * –ü—Ä–∏–º–µ—Ä: /ban {user_id}
     */
    public function testResolveRouteArguments(): void
    {
        $zgMock = $this->createMock(ZG::class);

        $handler = function (int $userId, string $reason) {};

        $routeArgs = ['userId' => 555, 'reason' => 'spam'];

        $resolved = $this->resolver->resolve($handler, $zgMock, $routeArgs);

        $this->assertEquals(555, $resolved[0]);
        $this->assertEquals('spam', $resolved[1]);
    }

    /**
     * –¢–µ—Å—Ç 3: –°–º–µ—à–∞–Ω–Ω—ã–π —Ä–µ–∑–æ–ª–≤–∏–Ω–≥ (ZG + RouteArgs + Default)
     */
    public function testResolveMixedArgs(): void
    {
        $zgMock = $this->createMock(ZG::class);

        $handler = function (ZG $bot, int $id, bool $isAdmin = false) {};

        $routeArgs = ['id' => 100];

        $resolved = $this->resolver->resolve($handler, $zgMock, $routeArgs);

        $this->assertSame($zgMock, $resolved[0]);
        $this->assertEquals(100, $resolved[1]);
        $this->assertFalse($resolved[2]);
    }

    /**
     * –¢–µ—Å—Ç 4: –†–µ–∑–æ–ª–≤–∏–Ω–≥ –∏–∑ PSR-11 –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
     */
    public function testResolveFromContainer(): void
    {
        $zgMock = $this->createMock(ZG::class);
        $containerMock = $this->createMock(ContainerInterface::class);
        $serviceMock = new \stdClass();

        $containerMock->method('has')->with(\stdClass::class)->willReturn(true);
        $containerMock->method('get')->with(\stdClass::class)->willReturn($serviceMock);

        $this->resolver->setContainer($containerMock);

        $handler = function (\stdClass $service) {};

        $resolved = $this->resolver->resolve($handler, $zgMock);

        $this->assertSame($serviceMock, $resolved[0]);
    }

    /**
     * –¢–µ—Å—Ç 5: –†–∞–±–æ—Ç–∞ –∫–µ—à–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
     * –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Reflection –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
     */
    public function testCachingReflection(): void
    {
        $cacheMock = $this->createMock(CacheInterface::class);
        $zgMock = $this->createMock(ZG::class);

        $cachedMeta = [
            [
                'name' => 'fakeArg',
                'type' => null,
                'is_builtin' => true,
                'allows_null' => true,
                'has_default' => false,
                'default_value' => null
            ]
        ];

        $cacheMock->expects($this->atLeastOnce())
            ->method('has')
            ->willReturn(true);

        $cacheMock->expects($this->once())
            ->method('get')
            ->willReturn($cachedMeta);

        $this->resolver->setCache($cacheMock);

        $handler = function () {};

        $routeArgs = ['fakeArg' => 999];

        $args = $this->resolver->resolve($handler, $zgMock, $routeArgs);

        $this->assertCount(1, $args);
        $this->assertEquals(999, $args[0]);
    }

    /**
     * –¢–µ—Å—Ç 5 (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π): –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –∫–µ—à –ø—Ä–∏ —Ö–æ–ª–æ–¥–Ω–æ–º —Å—Ç–∞—Ä—Ç–µ
     */
    public function testWritesToCache(): void
    {
        $cacheMock = $this->createMock(CacheInterface::class);
        $zgMock = $this->createMock(ZG::class);

        $cacheMock->expects($this->once())->method('set');

        $this->resolver->setCache($cacheMock);

        $handler = function($a) {};
        $this->resolver->resolve($handler, $zgMock, ['a' => 1]);
    }

    /**
     * –¢–µ—Å—Ç 6: –û—à–∏–±–∫–∞, –µ—Å–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
     */
    public function testExceptionOnMissingArg(): void
    {
        $zgMock = $this->createMock(ZG::class);
        $handler = function (int $missing) {};

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('DependencyResolver: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏–µ');

        $this->resolver->resolve($handler, $zgMock, []);
    }
}

===
File: Tests/Unit/UpdateContextTest.php
===
<?php
declare(strict_types=1);

namespace Tests\Unit;

use PHPUnit\Framework\TestCase;
use ZenithGram\ZenithGram\UpdateContext;

class UpdateContextTest extends TestCase
{
    /**
     * –¢–µ—Å—Ç –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
     */
    public function testTextMessageExtraction(): void
    {
        $updateData = [
            'update_id' => 1001,
            'message' => [
                'message_id' => 55,
                'from' => [
                    'id' => 123456,
                    'is_bot' => false,
                    'first_name' => 'John'
                ],
                'chat' => [
                    'id' => 987654,
                    'type' => 'private'
                ],
                'date' => 1600000000,
                'text' => 'Hello World'
            ]
        ];

        $ctx = new UpdateContext($updateData);

        $this->assertEquals('text', $ctx->getType());
        $this->assertEquals(987654, $ctx->getChatId());
        $this->assertEquals(123456, $ctx->getUserId());
        $this->assertEquals(55, $ctx->getMessageId());
        $this->assertEquals('Hello World', $ctx->getText());
        $this->assertNull($ctx->getCallbackData());
    }

    /**
     * –¢–µ—Å—Ç –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ Inline-–∫–Ω–æ–ø–∫—É (CallbackQuery)
     */
    public function testCallbackQueryExtraction(): void
    {
        $updateData = [
            'update_id' => 1002,
            'callback_query' => [
                'id' => '777',
                'from' => [
                    'id' => 111,
                    'first_name' => 'Alice'
                ],
                'message' => [
                    'message_id' => 88,
                    'chat' => [
                        'id' => 222,
                        'type' => 'group'
                    ],
                    'text' => 'Menu Message'
                ],
                'chat_instance' => '333',
                'data' => 'menu_btn_click'
            ]
        ];

        $ctx = new UpdateContext($updateData);

        $this->assertEquals('callback_query', $ctx->getType());
        $this->assertEquals('777', $ctx->getQueryId());
        $this->assertEquals('menu_btn_click', $ctx->getCallbackData());

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ ID –±–µ—Ä—É—Ç—Å—è –∏–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ message –∏–ª–∏ callback_query
        $this->assertEquals(222, $ctx->getChatId());
        $this->assertEquals(111, $ctx->getUserId());
        $this->assertEquals(88, $ctx->getMessageId()); // ID —Å–æ–æ–±—â–µ–Ω–∏—è, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞
    }

    /**
     * –¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ (entity type = bot_command)
     */
    public function testBotCommandDetection(): void
    {
        $updateData = [
            'update_id' => 1003,
            'message' => [
                'message_id' => 101,
                'from' => ['id' => 10],
                'chat' => ['id' => 20],
                'text' => '/start',
                'entities' => [
                    [
                        'offset' => 0,
                        'length' => 6,
                        'type' => 'bot_command'
                    ]
                ]
            ]
        ];

        $ctx = new UpdateContext($updateData);

        $this->assertEquals('bot_command', $ctx->getType());
        $this->assertEquals('/start', $ctx->getText());
    }

    /**
     * –¢–µ—Å—Ç –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
     */
    public function testEditedMessageExtraction(): void
    {
        $updateData = [
            'update_id' => 1004,
            'edited_message' => [
                'message_id' => 202,
                'from' => ['id' => 555],
                'chat' => ['id' => 777],
                'date' => 1600000050,
                'edit_date' => 1600000060,
                'text' => 'Edited text'
            ]
        ];

        $ctx = new UpdateContext($updateData);

        $this->assertEquals('edited_message', $ctx->getType());
        $this->assertEquals('Edited text', $ctx->getText());
        $this->assertEquals(777, $ctx->getChatId());
        $this->assertEquals(555, $ctx->getUserId());
        $this->assertEquals(202, $ctx->getMessageId());
    }

    /**
     * –¢–µ—Å—Ç Inline Query (–≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ —á–µ—Ä–µ–∑ @bot)
     */
    public function testInlineQueryExtraction(): void
    {
        $updateData = [
            'update_id' => 1005,
            'inline_query' => [
                'id' => '9999',
                'from' => [
                    'id' => 444,
                    'first_name' => 'Bob'
                ],
                'query' => 'search query',
                'offset' => ''
            ]
        ];

        $ctx = new UpdateContext($updateData);

        $this->assertEquals('inline_query', $ctx->getType());
        $this->assertEquals('search query', $ctx->getText());
        $this->assertEquals('9999', $ctx->getQueryId());
        $this->assertEquals(444, $ctx->getUserId());

        $this->assertNull($ctx->getChatId());
        $this->assertNull($ctx->getMessageId());
    }

    /**
     * –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Ç–≤–µ—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ (Reply)
     */
    public function testReplyExtraction(): void
    {
        $updateData = [
            'message' => [
                'message_id' => 500,
                'from' => ['id' => 100],
                'chat' => ['id' => 200],
                'text' => 'Reply msg',
                'reply_to_message' => [
                    'message_id' => 499,
                    'from' => ['id' => 101],
                    'text' => 'Original text'
                ]
            ]
        ];

        $ctx = new UpdateContext($updateData);

        $this->assertEquals(499, $ctx->getReplyMessageId());
        $this->assertEquals(101, $ctx->getReplyUserId());
        $this->assertEquals('Original text', $ctx->getReplyText());
    }

    /**
     * –¢–µ—Å—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ (caption –¥–ª—è –º–µ–¥–∏–∞)
     */
    public function testCaptionExtraction(): void
    {
        $updateData = [
            'message' => [
                'message_id' => 600,
                'chat' => ['id' => 1],
                'photo' => [],
                'caption' => 'Photo description'
            ]
        ];

        $ctx = new UpdateContext($updateData);
// –ú–µ—Ç–æ–¥ getText() –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å caption, –µ—Å–ª–∏ text –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
        $this->assertEquals('Photo description', $ctx->getText());
        $this->assertEquals('text', $ctx->getType()); // –í –∫–æ–¥–µ —Ç–∏–ø 'text' –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –µ—Å—Ç—å message, –¥–∞–∂–µ —Å —Ñ–æ—Ç–æ, –µ—Å–ª–∏ –Ω–µ—Ç bot_command
    }
}

===
File: Tests/Unit/PollTest.php
===
<?php
declare(strict_types=1);

namespace Tests\Unit;

use PHPUnit\Framework\TestCase;
use ZenithGram\ZenithGram\Poll;
use ZenithGram\ZenithGram\UpdateContext;
use ZenithGram\ZenithGram\Interfaces\ApiClientInterface;
use ZenithGram\ZenithGram\Enums\MessageParseMode;

class PollTest extends TestCase
{
    private $apiMock;
    private $contextMock;

    protected function setUp(): void
    {
        $this->apiMock = $this->createMock(ApiClientInterface::class);
        $this->contextMock = $this->createMock(UpdateContext::class);
    }

    /**
     * –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ã—á–Ω–æ–≥–æ –æ–ø—Ä–æ—Å–∞ (regular)
     */
    public function testCreateRegularPoll(): void
    {
        $this->contextMock->method('getChatId')->willReturn(123);

        $poll = new Poll('regular', $this->apiMock, $this->contextMock);

        $this->apiMock->expects($this->once())
            ->method('callAPI')
            ->with(
                'sendPoll',
                $this->callback(function($params) {
                    return $params['chat_id'] === 123 &&
                        $params['question'] === 'Your favorite color?' &&
                        $params['type'] === 'regular' &&
                        json_decode($params['options']) === ['Red', 'Blue'];
                })
            )
            ->willReturn(['ok' => true]);

        $poll->question('Your favorite color?')
            ->addAnswers('Red', 'Blue')
            ->send();
    }

    /**
     * –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã (quiz) —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –æ—Ç–≤–µ—Ç–æ–º –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º
     */
    public function testCreateQuizPoll(): void
    {
        $poll = new Poll('quiz', $this->apiMock, $this->contextMock);

        $this->apiMock->expects($this->once())
            ->method('callAPI')
            ->with(
                'sendPoll',
                $this->callback(function($params) {
                    return $params['type'] === 'quiz' &&
                        $params['correct_option_id'] === 1 &&
                        $params['explanation'] === 'Because 2+2=4' &&
                        $params['explanation_parse_mode'] === 'HTML';
                })
            );

        $poll->question('2 + 2 = ?')
            ->addAnswers('3', '4', '5')
            ->correctAnswer(1) // –ò–Ω–¥–µ–∫—Å 1 (—ç—Ç–æ '4')
            ->explanation('Because 2+2=4')
            ->explanationParseMode(MessageParseMode::HTML)
            ->send(999); // –Ø–≤–Ω–æ –ø–µ—Ä–µ–¥–∞–µ–º chat_id
    }

    /**
     * –¢–µ—Å—Ç –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç–∏ –∏ –º—É–ª—å—Ç–∏-–æ—Ç–≤–µ—Ç–æ–≤
     */
    public function testPollSettings(): void
    {
        $poll = new Poll('regular', $this->apiMock, $this->contextMock);

        $this->apiMock->expects($this->once())
            ->method('callAPI')
            ->with(
                'sendPoll',
                $this->callback(function($params) {
                    return $params['is_anonymous'] === false &&
                        $params['allows_multiple_answers'] === true;
                })
            );

        $poll->isAnonymous(false)
            ->multipleAnswers(true)
            ->send(1);
    }

    /**
     * –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ openPeriod (–æ—Ç 5 –¥–æ 600 —Å–µ–∫—É–Ω–¥)
     */
    public function testOpenPeriodValidation(): void
    {
        $poll = new Poll('quiz', $this->apiMock, $this->contextMock);

        $poll->openPeriod(2);

        $this->apiMock->expects($this->atLeastOnce())
            ->method('callAPI')
            ->with('sendPoll', $this->callback(fn($p) => $p['open_period'] === 600));

        $poll->send(1);
    }

    /**
     * –¢–µ—Å—Ç –∑–∞–∫—Ä—ã—Ç–∏—è –æ–ø—Ä–æ—Å–∞
     */
    public function testClosePoll(): void
    {
        $poll = new Poll('regular', $this->apiMock, $this->contextMock);

        $this->apiMock->expects($this->once())
            ->method('callAPI')
            ->with('sendPoll', $this->callback(fn($p) => $p['is_closed'] === true));

        $poll->close(true)->send(1);
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ correctAnswer –∏ explanation –ù–ï –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ regular –æ–ø—Ä–æ—Å–µ
     */
    public function testQuizFieldsNotPresentInRegularPoll(): void
    {
        $poll = new Poll('regular', $this->apiMock, $this->contextMock);

        $this->apiMock->expects($this->once())
            ->method('callAPI')
            ->with(
                'sendPoll',
                $this->callback(function($params) {
                    return !isset($params['correct_option_id']) &&
                        !isset($params['explanation']);
                })
            );

        $poll->correctAnswer(0)
            ->explanation('Should not be here')
            ->send(1);
    }
}


===
File: Tests/Unit/Dto/MessageDtoTest.php
===
<?php
declare(strict_types=1);

namespace Tests\Unit\Dto;

use PHPUnit\Framework\TestCase;
use ZenithGram\ZenithGram\Dto\MessageDto;
use ZenithGram\ZenithGram\Dto\ChatDto;
use ZenithGram\ZenithGram\Dto\UserDto;

class MessageDtoTest extends TestCase
{
    /**
     * –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è DTO –∏–∑ –º–∞—Å—Å–∏–≤–∞ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º –¥–∞–Ω–Ω—ã—Ö
     */
    public function testFromArrayMinimal(): void
    {
        $data = [
            'message_id' => 123,
            'date' => 1672531200,
            'chat' => [
                'id' => 999,
                'type' => 'private',
                'first_name' => 'John'
            ]
        ];

        $dto = MessageDto::fromArray($data);

        $this->assertEquals(123, $dto->messageId);
        $this->assertEquals(1672531200, $dto->date);

        $this->assertInstanceOf(ChatDto::class, $dto->chat);
        $this->assertEquals(999, $dto->chat->id);
        $this->assertEquals('private', $dto->chat->type);

        $this->assertNull($dto->text);
        $this->assertNull($dto->from);
        $this->assertNull($dto->replyToMessage);
    }

    /**
     * –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è DTO —Å –ø–æ–ª–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º –¥–∞–Ω–Ω—ã—Ö (Text, User, Entities)
     */
    public function testFromArrayFullText(): void
    {
        $data = [
            'message_id' => 456,
            'date' => 1672531500,
            'chat' => ['id' => 100, 'type' => 'group', 'title' => 'My Group'],
            'from' => [
                'id' => 555,
                'is_bot' => false,
                'first_name' => 'Alice',
                'username' => 'alice_wonder'
            ],
            'text' => '/start',
            'entities' => [
                ['type' => 'bot_command', 'offset' => 0, 'length' => 6]
            ]
        ];

        $dto = MessageDto::fromArray($data);

        $this->assertInstanceOf(UserDto::class, $dto->from);
        $this->assertEquals(555, $dto->from->id);
        $this->assertEquals('alice_wonder', $dto->from->username);

        $this->assertEquals('/start', $dto->text);
        $this->assertIsArray($dto->entities);
        $this->assertEquals('bot_command', $dto->entities[0]['type']);
    }

    /**
     * –¢–µ—Å—Ç —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–π –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ (–æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ - reply_to_message)
     */
    public function testReplyToMessageRecursion(): void
    {
        $data = [
            'message_id' => 200,
            'date' => 1672532000,
            'chat' => ['id' => 1, 'type' => 'private'],
            'text' => 'This is a reply',
            'reply_to_message' => [
                'message_id' => 199,
                'date' => 1672531900,
                'chat' => ['id' => 1, 'type' => 'private'],
                'text' => 'Original message',
                'from' => ['id' => 2, 'is_bot' => false, 'first_name' => 'Bob']
            ]
        ];

        $dto = MessageDto::fromArray($data);

        $this->assertTrue($dto->isReply());
        $this->assertInstanceOf(MessageDto::class, $dto->replyToMessage);

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        $reply = $dto->replyToMessage;
        $this->assertEquals(199, $reply->messageId);
        $this->assertEquals('Original message', $reply->text);
        $this->assertEquals(2, $reply->from->id);

// –£ —Ä–æ–¥–∏—Ç–µ–ª—è –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–≤–µ—Ç–∞ (–≤ –¥–∞–Ω–Ω–æ–º —Ç–µ—Å—Ç–µ)
        $this->assertFalse($reply->isReply());
        $this->assertNull($reply->replyToMessage);
    }

    /**
     * –¢–µ—Å—Ç —Ö–µ–ª–ø–µ—Ä–∞ getEffectiveText (text –∏–ª–∏ caption)
     */
    public function testGetEffectiveText(): void
    {
// 1. –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
        $msgWithText = MessageDto::fromArray([
            'message_id' => 1, 'date' => 0, 'chat' => ['id' => 1, 'type' => 'a'],
            'text' => 'Just text'
        ]);
        $this->assertEquals('Just text', $msgWithText->getEffectiveText());

// 2. –¢–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å—å (caption)
        $msgWithCaption = MessageDto::fromArray([
            'message_id' => 2, 'date' => 0, 'chat' => ['id' => 1, 'type' => 'a'],
            'caption' => 'Photo caption',
            'photo' => []
        ]);
        $this->assertEquals('Photo caption', $msgWithCaption->getEffectiveText());

// 3. –ù–∏—á–µ–≥–æ
        $msgEmpty = MessageDto::fromArray([
            'message_id' => 3, 'date' => 0, 'chat' => ['id' => 1, 'type' => 'a'],
            'sticker' => []
        ]);
        $this->assertNull($msgEmpty->getEffectiveText());
    }

    /**
     * –¢–µ—Å—Ç –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞ (–º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ UserDto)
     */
    public function testNewChatMembers(): void
    {
        $data = [
            'message_id' => 300,
            'date' => 0,
            'chat' => ['id' => 500, 'type' => 'group'],
            'new_chat_members' => [
                ['id' => 10, 'is_bot' => false, 'first_name' => 'User1'],
                ['id' => 11, 'is_bot' => true, 'first_name' => 'Bot2']
            ]
        ];

        $dto = MessageDto::fromArray($data);

        $this->assertIsArray($dto->newChatMembers);
        $this->assertCount(2, $dto->newChatMembers);
        $this->assertInstanceOf(UserDto::class, $dto->newChatMembers[0]);
        $this->assertInstanceOf(UserDto::class, $dto->newChatMembers[1]);

        $this->assertEquals(10, $dto->newChatMembers[0]->id);
        $this->assertEquals(11, $dto->newChatMembers[1]->id);
        $this->assertTrue($dto->newChatMembers[1]->isBot);
    }

    /**
     * –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —ç–º–æ–¥–∑–∏ –∏–∑ –∫—É–±–∏–∫–∞ (Dice)
     */
    public function testDiceExtraction(): void
    {
        $data = [
            'message_id' => 400,
            'date' => 0,
            'chat' => ['id' => 1, 'type' => 'p'],
            'dice' => ['emoji' => 'üé≤', 'value' => 6]
        ];

        $dto = MessageDto::fromArray($data);

        $this->assertEquals('üé≤', $dto->getDiceEmoji());
        $this->assertEquals(6, $dto->dice['value']);
    }
}


===
File: Tests/Unit/ActionTest.php
===
<?php
declare(strict_types=1);

namespace Tests\Unit;

use PHPUnit\Framework\TestCase;
use ZenithGram\ZenithGram\Action;
use ZenithGram\ZenithGram\Enums\MessageParseMode;

class ActionTest extends TestCase
{
    /**
     * –¢–µ—Å—Ç –±–∞–∑–æ–≤—ã—Ö —Å–≤–æ–π—Å—Ç–≤: ID –∏ —É—Å–ª–æ–≤–∏–µ
     */
    public function testConstructorAndGetters(): void
    {
        $action = new Action('test_id', '/start');

        $this->assertEquals('test_id', $action->getId());
        $this->assertEquals('/start', $action->getCondition());
    }

    /**
     * –¢–µ—Å—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ (func)
     */
    public function testFuncHandler(): void
    {
        $action = new Action('id', 'cond');
        $callback = function() { return 'hello'; };

        $action->func($callback);

        $handler = $action->getHandler();
        $this->assertIsCallable($handler);
        $this->assertEquals('hello', $handler());
    }

    /**
     * –¢–µ—Å—Ç –ª–æ–≥–∏–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø–∞ (Access / NoAccess)
     */
    public function testAccessLogic(): void
    {
        $action = new Action('id', 'cond');
        $handler = function() {};

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö ID
        $action->access([123, 456], $handler);

        $this->assertEquals([123, 456], $action->getAccessIds());
        $this->assertSame($handler, $action->getAccessHandler());

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö ID
        $action->noAccess(777); // –ü–µ—Ä–µ–¥–∞–µ–º –æ–¥–Ω–æ —á–∏—Å–ª–æ –≤–º–µ—Å—Ç–æ –º–∞—Å—Å–∏–≤–∞
        $this->assertEquals([777], $action->getNoAccessIds());
    }

    /**
     * –¢–µ—Å—Ç —Ä–∞–±–æ—Ç—ã MessageBuilderTrait –≤–Ω—É—Ç—Ä–∏ Action.
     * –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤ messageData.
     */
    public function testMessageBuilderTraitIntegration(): void
    {
        $action = new Action('id', 'cond');

        $action->text('Hello')
            ->parseMode(MessageParseMode::HTML)
            ->reply(12345);

        $data = $action->getMessageData();

        $this->assertEquals('Hello', $data['text']);
        $this->assertEquals('HTML', $data['parse_mode']);
        $this->assertEquals(12345, $data['reply_to_message_id']);
    }

    /**
     * –¢–µ—Å—Ç –º–µ—Ç–æ–¥–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è.
     * –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–º–µ–Ω—É messageDataAction (0 - send, 1 - editText, 2 - editCaption, 3 - editMedia)
     */
    public function testEditActions(): void
    {
        $action = new Action('id', 'cond');

// –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 0 (–æ—Ç–ø—Ä–∞–≤–∫–∞)
        $this->assertEquals(0, $action->getMessageDataAction());

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        $action->editText('new text');
        $this->assertEquals(1, $action->getMessageDataAction());
        $this->assertEquals('new text', $action->getMessageData()['text']);

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏
        $action->editCaption('new caption');
        $this->assertEquals(2, $action->getMessageDataAction());

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞
        $action->editMedia();
        $this->assertEquals(3, $action->getMessageDataAction());
    }

    /**
     * –¢–µ—Å—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –∏ query (–≤—Å–ø–ª—ã–≤–∞—à–∫–∏)
     */
    public function testRedirectAndQuery(): void
    {
        $action = new Action('id', 'cond');

        $action->redirect('target_route_id')
            ->query('Processing...');

        $this->assertEquals('target_route_id', $action->redirect_to);
        $this->assertEquals('Processing...', $action->getQueryText());
    }

    /**
     * –¢–µ—Å—Ç middleware
     */
    public function testMiddleware(): void
    {
        $action = new Action('id', 'cond');
        $middleware = function($tg, $next) { $next(); };

        $action->middleware($middleware);

        $this->assertNotNull($action->middleware_handler);
        $this->assertInstanceOf(\Closure::class, $action->middleware_handler);
    }
}


===
File: Tests/Unit/FileTest.php
===
<?php
declare(strict_types=1);

namespace Tests\Unit;

use PHPUnit\Framework\TestCase;
use ZenithGram\ZenithGram\File;
use ZenithGram\ZenithGram\Interfaces\ApiClientInterface;

class FileTest extends TestCase
{
    /**
     * –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–µ—Ç–æ–¥–∞ getFileId.
     * –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ ID –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π.
     */
    public function testGetFileIdFromDifferentTypes(): void
    {
// 1. –§–æ—Ç–æ (–¥–æ–ª–∂–µ–Ω –≤–∑—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç - —Å–∞–º–æ–µ –ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)
        $photoContext = [
            'message' => [
                'photo' => [
                    ['file_id' => 'small_id', 'file_size' => 100],
                    ['file_id' => 'medium_id', 'file_size' => 500],
                    ['file_id' => 'large_id', 'file_size' => 1000],
                ]
            ]
        ];
        $this->assertEquals('large_id', File::getFileId($photoContext));

// 2. –î–æ–∫—É–º–µ–Ω—Ç
        $docContext = [
            'message' => [
                'document' => ['file_id' => 'doc_123']
            ]
        ];
        $this->assertEquals('doc_123', File::getFileId($docContext));

// 3. –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        $voiceContext = [
            'message' => [
                'voice' => ['file_id' => 'voice_777']
            ]
        ];
        $this->assertEquals('voice_777', File::getFileId($voiceContext));

// 4. –ü–æ–∏—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞
        $mixedContext = [
            'message' => [
                'photo' => [['file_id' => 'p1']],
                'video' => ['file_id' => 'v1']
            ]
        ];
        $this->assertEquals('v1', File::getFileId($mixedContext, 'video'));
    }

    /**
     * –¢–µ—Å—Ç —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ –≤ —Ä–∞–∑–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö.
     */
    public function testGetFileSizeConversion(): void
    {
        $apiMock = $this->createMock(ApiClientInterface::class);

// –ú–æ–∫–∞–µ–º –æ—Ç–≤–µ—Ç getFile –æ—Ç Telegram API
        $apiMock->method('callAPI')
            ->with('getFile', ['file_id' => 'test_file'])
            ->willReturn([
                'result' => [
                    'file_id' => 'test_file',
                    'file_size' => 1048576, // –†–æ–≤–Ω–æ 1 –ú–ë –≤ –±–∞–π—Ç–∞—Ö
                    'file_path' => 'docs/file.pdf'
                ]
            ]);

        $file = new File('test_file', $apiMock);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–π—Ç–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        $this->assertEquals(1048576, $file->getFileSize());

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ö–∏–ª–æ–±–∞–π—Ç–∞—Ö
        $this->assertEquals(1024, $file->getFileSize('KB'));

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ú–µ–≥–∞–±–∞–π—Ç–∞—Ö
        $this->assertEquals(1, $file->getFileSize('MB'));
    }

    /**
     * –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ URL –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É.
     */
    public function testGetFilePath(): void
    {
        $apiMock = $this->createMock(ApiClientInterface::class);

// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–æ–∫ API –∫–ª–∏–µ–Ω—Ç–∞
        $apiMock->method('getApiFileUrl')
            ->willReturn('https://api.telegram.org/file/bot123:TOKEN/');

        $apiMock->method('callAPI')
            ->willReturn([
                'result' => ['file_path' => 'photos/image_0.jpg']
            ]);

        $file = new File('some_id', $apiMock);

        $expectedUrl = 'https://api.telegram.org/file/bot123:TOKEN/photos/image_0.jpg';
        $this->assertEquals($expectedUrl, $file->getFilePath());
    }

    /**
     * –¢–µ—Å—Ç –≤—ã–±—Ä–æ—Å–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–º —Ä–∞–∑–º–µ—Ä–µ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Telegram API –¥–ª—è –±–æ—Ç–æ–≤ - 20–ú–ë)
     */
    public function testSaveThrowsExceptionOnLargeFile(): void
    {
        $apiMock = $this->createMock(ApiClientInterface::class);

        $apiMock->method('callAPI')
            ->willReturn([
                'result' => [
                    'file_size' => 25 * 1024 * 1024 // 25 MB
                ]
            ]);

        $file = new File('big_file', $apiMock);

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 20 –ú–ë');

        $file->save('/tmp/test');
    }
}


===
File: Tests/Unit/PaginationTest.php
===
<?php
declare(strict_types=1);

namespace Tests\Unit;

use PHPUnit\Framework\TestCase;
use ZenithGram\ZenithGram\Pagination;
use ZenithGram\ZenithGram\Enums\PaginationMode;
use ZenithGram\ZenithGram\Enums\PaginationLayout;
use ZenithGram\ZenithGram\Enums\PaginationNumberStyle;

class PaginationTest extends TestCase
{
    /**
     * –•–µ–ª–ø–µ—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫
     */
    private function generateItems(int $count): array
    {
        $items = [];
        for ($i = 1; $i <= $count; $i++) {
            $items[] = ['text' => "Item $i", 'callback_data' => "btn_$i"];
        }

        return $items;
    }

    public function testTotalPageCalculation(): void
    {
        $p = new Pagination();

        $p->setItems($this->generateItems(10))->setPerPage(5);
        $this->assertEquals(2, $p->getTotalPage());

        $p->setItems($this->generateItems(11));
        $this->assertEquals(3, $p->getTotalPage());

        $p->setItems([]);
        $this->assertEquals(0, $p->getTotalPage());
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤—ã–≤–æ–¥—è—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
     */
    public function testSlicingLogic(): void
    {
        $items = $this->generateItems(10);
        $p = new Pagination();
        $p
            ->setItems($items)
            ->setPerPage(2)
            ->setPage(2)
            ->setPrefix('p_');

        $result = $p->create();

        $this->assertEquals('Item 3', $result[0][0]['text']);
        $this->assertEquals('Item 4', $result[1][0]['text']);
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ –∫–æ–ª–æ–Ω–∫–∏
     */
    public function testColumns(): void
    {
        $p = new Pagination();
        $p
            ->setItems($this->generateItems(4))
            ->setPerPage(4)
            ->setColumns(2)
            ->setPrefix('p_');

        $keyboard = $p->create();

        $this->assertCount(2, $keyboard[0]);
        $this->assertEquals('Item 1', $keyboard[0][0]['text']);
        $this->assertEquals('Item 2', $keyboard[0][1]['text']);
    }

    /**
     * –¢–µ—Å—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É —Å—Ç—Ä–µ–ª–æ–∫ (Arrows Mode)
     */
    public function testArrowNavigationVisibility(): void
    {
        $items = $this->generateItems(30);
        $p = new Pagination();
        $p->setItems($items)->setPerPage(10)->setPrefix('p_');

        $p->setPage(1);
        $kbd1 = $p->create();
        $navRow1 = end($kbd1);

        $this->assertCount(1, $navRow1);
        $this->assertEquals('>', $navRow1[0]['text']);

        $p->setPage(2);
        $kbd2 = $p->create();
        $navRow2 = end($kbd2);

        $this->assertCount(2, $navRow2);
        $this->assertEquals('<', $navRow2[0]['text']);
        $this->assertEquals('>', $navRow2[1]['text']);

        $p->setPage(3);
        $kbd3 = $p->create();
        $navRow3 = end($kbd3);

        $this->assertCount(1, $navRow3);
        $this->assertEquals('<', $navRow3[0]['text']);
    }

    /**
     * –¢–µ—Å—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤–æ–π —Ä–µ–∂–∏–º (Numbers Mode)
     */
    public function testNumbersMode(): void
    {
        $p = new Pagination();
        $p
            ->setItems($this->generateItems(50))
            ->setPerPage(10)
            ->setPage(3)
            ->setPrefix('page_')
            ->setMode(PaginationMode::NUMBERS)
            ->setActivePageFormat('- %s -');

        $kbd = $p->create();
        $navRow = end($kbd);

        $this->assertCount(5, $navRow);

        $this->assertEquals('page_1', $navRow[0]['callback_data']);

        $this->assertEquals('- 3 -', $navRow[2]['text']);
    }

    /**
     * –¢–µ—Å—Ç–∏—Ä—É–µ–º –ª–µ–π–∞—É—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (SPLIT)
     * –ö–Ω–æ–ø–∫–∏ "–í –Ω–∞—á–∞–ª–æ/–í –∫–æ–Ω–µ—Ü" –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç–¥–µ–ª–µ–Ω—ã –æ—Ç "–ù–∞–∑–∞–¥/–í–ø–µ—Ä–µ–¥"
     */
    public function testNavigationLayoutSplit(): void
    {
        $p = new Pagination();
        $p
            ->setItems($this->generateItems(100))
            ->setPerPage(10)
            ->setPage(5) // –°–µ—Ä–µ–¥–∏–Ω–∞
            ->setPrefix('p_')
            ->setSideSigns('First', 'Last')
            ->setNavigationLayout(PaginationLayout::SPLIT);

        $kbd = $p->create();

        $lastRow = array_pop($kbd);
        $prevRow = array_pop($kbd);

        $this->assertCount(2, $lastRow);
        $this->assertEquals('First', $lastRow[0]['text']);

        $this->assertCount(2, $prevRow);
        $this->assertEquals('<', $prevRow[0]['text']);
    }

    /**
     * –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (Return Button)
     */
    public function testReturnButton(): void
    {
        $p = new Pagination();
        $p
            ->setItems($this->generateItems(5))
            ->setPerPage(5) // 1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞
            ->setPrefix('p_')
            ->addReturnBtn('Back Menu', 'menu_cb');

        $kbd = $p->create();

        $lastRow = end($kbd);

        $this->assertEquals('Back Menu', $lastRow[0]['text']);
        $this->assertEquals('menu_cb', $lastRow[0]['callback_data']);
    }

    /**
     * –¢–µ—Å—Ç–∏—Ä—É–µ–º header buttons
     */
    public function testHeaderButtons(): void
    {
        $p = new Pagination();
        $header = [['text' => 'Top', 'callback_data' => 'top']];

        $p
            ->setItems($this->generateItems(1))
            ->setPrefix('p_')
            ->addHeaderBtn($header);

        $kbd = $p->create();

        $this->assertEquals($header, $kbd[0]);
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∞—Å—Å –Ω–µ –¥–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
     */
    public function testValidationExceptions(): void
    {
        $p = new Pagination();

        try {
            $p->setPerPage(0);
            $this->fail('–û–∂–∏–¥–∞–ª–æ—Å—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ PerPage=0');
        } catch (\LogicException $e) {
            $this->assertTrue(true);
        }

        try {
            $p->setPage(-1);
            $this->fail('–û–∂–∏–¥–∞–ª–æ—Å—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ Page=-1');
        } catch (\LogicException $e) {
            $this->assertTrue(true);
        }

        try {
            $p->setColumns(0);
            $this->fail('–û–∂–∏–¥–∞–ª–æ—Å—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ Columns=0');
        } catch (\LogicException $e) {
            $this->assertTrue(true);
        }

        try {
            $p->setPrefix('');
            $this->fail('–û–∂–∏–¥–∞–ª–æ—Å—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –ø—É—Å—Ç–æ–º –ø—Ä–µ—Ñ–∏–∫—Å–µ');
        } catch (\LogicException $e) {
            $this->assertTrue(true);
        }
    }

    public function testNumbersSlidingWindow(): void
    {
        $p = new Pagination();
        $p
            ->setItems($this->generateItems(100))
            ->setPerPage(10)
            ->setPrefix('p_')
            ->setMode(PaginationMode::NUMBERS)
            ->setMaxPageBtn(5);

        // 1. –ù–∞—á–∞–ª–æ
        $p->setPage(1);
        $res1 = $p->create();
        $row1 = end($res1);
        $this->assertEquals('1', $row1[0]['text']);
        $this->assertEquals('5', $row1[4]['text']);

        // 2. –°–µ—Ä–µ–¥–∏–Ω–∞
        $p->setPage(5);
        $res2 = $p->create();
        $row2 = end($res2);
        $this->assertEquals('3', $row2[0]['text']);
        $this->assertEquals('7', $row2[4]['text']);
        $this->assertEquals('5', $row2[2]['text']);

        // 3. –ö–æ–Ω–µ—Ü
        $p->setPage(10);
        $res3 = $p->create();
        $row3 = end($res3);
        $this->assertEquals('6', $row3[0]['text']);
        $this->assertEquals('10', $row3[4]['text']);
    }

    public function testMultiDigitEmoji(): void
    {
        $p = new Pagination();
        $p
            ->setItems($this->generateItems(100))
            ->setPerPage(10)
            ->setPage(10)
            ->setPrefix('p_')
            ->setMode(PaginationMode::NUMBERS)
            ->setNumberStyle(PaginationNumberStyle::EMOJI);

        $result = $p->create();
        $navRow = end($result);

        $lastBtn = end($navRow);

        // 1 -> 1Ô∏è‚É£, 0 -> 0Ô∏è‚É£.  10 -> 1Ô∏è‚É£0Ô∏è‚É£
        $this->assertEquals('1Ô∏è‚É£0Ô∏è‚É£', $lastBtn['text']);
    }

    public function testSmartLayout(): void
    {
        $p = new Pagination();
        $p
            ->setItems($this->generateItems(50))
            ->setPerPage(10)
            ->setPage(2)
            ->setPrefix('p_')
            ->setNavigationLayout(PaginationLayout::SMART);

        $kbd1 = $p->create();
        $navRow1 = end($kbd1);
        $this->assertCount(2, $navRow1);

        $p->setSideSigns('<<', '>>');
        $kbd2 = $p->create();

        $lastRow = array_pop($kbd2);
        $penultRow = array_pop($kbd2);

        $this->assertCount(2, $penultRow, 'Inner buttons count');
        $this->assertCount(2, $lastRow, 'Outer buttons count');
    }

    public function testActivePageFormatLeftRight(): void
    {
        $p = new Pagination();
        $p
            ->setItems($this->generateItems(30))
            ->setPerPage(10)
            ->setPage(1)
            ->setPrefix('p_')
            ->setMode(PaginationMode::NUMBERS)
            ->setActivePageFormat('>> ', ' <<');

        $result = $p->create();
        $navRow = end($result);

        $this->assertEquals('>> 1 <<', $navRow[0]['text']);
        $this->assertEquals('2', $navRow[1]['text']);
    }
}

===
File: Tests/Unit/ButtonTest.php
===
<?php
declare(strict_types=1);

namespace Tests\Unit;

use PHPUnit\Framework\TestCase;
use ZenithGram\ZenithGram\Button;

class ButtonTest extends TestCase
{
    /**
     * –¢–µ—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å Callback Data (Inline)
     */
    public function testCallbackButton(): void
    {
        $btn = Button::cb('Click Me', 'action_123');

        $this->assertEquals([
            'text' => 'Click Me',
            'callback_data' => 'action_123'
        ], $btn);
    }

    /**
     * –¢–µ—Å—Ç –∫–Ω–æ–ø–∫–∏-—Å—Å—ã–ª–∫–∏ (Inline)
     */
    public function testUrlButton(): void
    {
        $btn = Button::url('Google', 'https://google.com');

        $this->assertEquals([
            'text' => 'Google',
            'url' => 'https://google.com'
        ], $btn);
    }

    /**
     * –¢–µ—Å—Ç –∫–Ω–æ–ø–∫–∏ WebApp (Inline)
     */
    public function testWebAppButton(): void
    {
        $btn = Button::webApp('Open App', 'https://myapp.com');

        $this->assertEquals([
            'text' => 'Open App',
            'web_app' => ['url' => 'https://myapp.com']
        ], $btn);
    }

    /**
     * –¢–µ—Å—Ç –æ–±—ã—á–Ω–æ–π —Ç–µ–∫—Å—Ç–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏ (Reply)
     */
    public function testTextButton(): void
    {
        $btn = Button::text('Menu');

        $this->assertEquals(['text' => 'Menu'], $btn);
    }

    /**
     * –¢–µ—Å—Ç –∫–Ω–æ–ø–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ (Reply)
     */
    public function testContactButton(): void
    {
        $btn = Button::contact('Send Phone');

        $this->assertEquals([
            'text' => 'Send Phone',
            'request_contact' => true
        ], $btn);
    }

    /**
     * –¢–µ—Å—Ç –∫–Ω–æ–ø–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ (Reply)
     */
    public function testLocationButton(): void
    {
        $btn = Button::location('Send Location');

        $this->assertEquals([
            'text' => 'Send Location',
            'request_location' => true
        ], $btn);
    }
}


===
File: Tests/Unit/InlineTest.php
===
<?php
declare(strict_types=1);

namespace Tests\Unit;

use PHPUnit\Framework\TestCase;
use ZenithGram\ZenithGram\Enums\InlineType;
use ZenithGram\ZenithGram\Enums\MessageParseMode;
use ZenithGram\ZenithGram\Inline;

class InlineTest extends TestCase
{
    /**
     * –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–≥–æ —Ç–∏–ø–∞ Article.
     * –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É input_message_content.
     */
    public function testCreateArticleBuilder(): void
    {
        $inline = new Inline(InlineType::Article);

        $result = $inline
            ->id('101')
            ->title('Test Title')
            ->description('Test Description')
            ->text('<b>Hello</b>')
            ->parseMode(MessageParseMode::HTML)
            ->create();

        $this->assertEquals('article', $result['type']);
        $this->assertEquals('101', $result['id']);
        $this->assertEquals('Test Title', $result['title']);
        $this->assertEquals('Test Description', $result['description']);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–ª–æ–∂–µ–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ–æ–±—â–µ–Ω–∏—è
        $this->assertArrayHasKey('input_message_content', $result);
        $this->assertEquals('<b>Hello</b>', $result['input_message_content']['message_text']);
        $this->assertEquals('HTML', $result['input_message_content']['parse_mode']);
    }

    /**
     * –¢–µ—Å—Ç Photo —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º URL.
     * –õ–æ–≥–∏–∫–∞ –∫–ª–∞—Å—Å–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –∫–ª—é—á 'photo_url'.
     */
    public function testCreatePhotoWithUrl(): void
    {
        $inline = new Inline(InlineType::Photo);

        $result = $inline
            ->id('photo_1')
            ->fileUrl('https://example.com/image.jpg')
            ->thumb('https://example.com/thumb.jpg')
            ->text('Caption text') // –î–ª—è —Ñ–æ—Ç–æ text —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è caption
            ->create();

        $this->assertEquals('photo', $result['type']);
        $this->assertEquals('https://example.com/image.jpg', $result['photo_url']);
        $this->assertEquals('https://example.com/thumb.jpg', $result['thumbnail_url']);
        $this->assertEquals('Caption text', $result['caption']);

        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ ID —Ñ–∞–π–ª–∞ –Ω–µ –ø–æ–ø–∞–ª –≤ –º–∞—Å—Å–∏–≤
        $this->assertArrayNotHasKey('photo_file_id', $result);
    }

    /**
     * –¢–µ—Å—Ç Photo —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º File ID.
     * –õ–æ–≥–∏–∫–∞ –∫–ª–∞—Å—Å–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –∫–ª—é—á 'photo_file_id'.
     */
    public function testCreatePhotoWithFileId(): void
    {
        $inline = new Inline(InlineType::Photo);

        $result = $inline
            ->id('photo_2')
            ->fileId('AgACAgIA...')
            ->create();

        $this->assertEquals('photo', $result['type']);
        $this->assertEquals('AgACAgIA...', $result['photo_file_id']);

        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ URL –Ω–µ –ø–æ–ø–∞–ª –≤ –º–∞—Å—Å–∏–≤
        $this->assertArrayNotHasKey('photo_url', $result);
    }

    /**
     * –¢–µ—Å—Ç Video –∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.
     * –ü—Ä–æ–≤–µ—Ä—è–µ–º mime_type –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
     */
    public function testCreateVideoDefaults(): void
    {
        $inline = new Inline(InlineType::Video);

        $result = $inline
            ->id('vid_1')
            ->fileUrl('https://example.com/video.mp4')
            ->title('Video Title')
            ->create();

        $this->assertEquals('video', $result['type']);
        // –í –∫–æ–¥–µ Inline.php –ø—Ä–æ–ø–∏—Å–∞–Ω–æ: $this->mimeType === '' ? 'video/mp4' : ...
        $this->assertEquals('video/mp4', $result['mime_type']);
    }

    /**
     * –¢–µ—Å—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.
     * –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–∞—Å—Å–∏–≤ –∫–Ω–æ–ø–æ–∫ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –≤ ['inline_keyboard' => ...]
     */
    public function testKeyboardStructure(): void
    {
        $buttons = [
            [['text' => 'btn1', 'callback_data' => '1']],
        ];

        $inline = new Inline(InlineType::Article);
        $result = $inline
            ->text('Menu')
            ->kbd($buttons)
            ->create();

        $this->assertArrayHasKey('reply_markup', $result);
        $this->assertEquals($buttons, $result['reply_markup']['inline_keyboard']);
    }

    /**
     * –¢–µ—Å—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.
     * –ü—Ä–æ–≤–µ—Ä—è–µ–º merge –º–∞—Å—Å–∏–≤–æ–≤.
     */
    public function testAdditionalParams(): void
    {
        $inline = new Inline(InlineType::Article);

        $result = $inline
            ->text('Text')
            ->params(['custom_field' => 123, 'reply_width' => 50])
            ->create();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ø–∞–ª–∏ –≤ input_message_content (–¥–ª—è Article)
        // –í–Ω–∏–º–∞–Ω–∏–µ: –≤ –∫–æ–¥–µ Inline.php –¥–ª—è Article params_additionally –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫ message,
        // –∞ –ø–æ—Ç–æ–º message –∫–ª–∞–¥–µ—Ç—Å—è –≤ input_message_content.
        $this->assertEquals(123, $result['input_message_content']['custom_field']);
        $this->assertEquals(50, $result['input_message_content']['reply_width']);
    }

    /**
     * –¢–µ—Å—Ç Location.
     */
    public function testLocation(): void
    {
        $inline = new Inline(InlineType::Location);

        $result = $inline
            ->coordinates(55.75, 37.61)
            ->title('Moscow')
            ->create();

        $this->assertEquals('location', $result['type']);
        $this->assertEquals(55.75, $result['latitude']);
        $this->assertEquals(37.61, $result['longitude']);
    }
    public function testCreateGif(): void
    {
        $inline = new Inline(InlineType::Gif);
        $result = $inline->id('gif_1')->fileId('123')->create();

        $this->assertEquals('gif', $result['type']);
        $this->assertEquals('123', $result['gif_file_id']);
    }

    public function testCreateMpeg4Gif(): void
    {
        $inline = new Inline(InlineType::Mpeg4Gif);
        $result = $inline->id('mpeg_1')->fileUrl('http://url.com/a.mp4')->create();

        $this->assertEquals('mpeg4_gif', $result['type']);
        $this->assertEquals('http://url.com/a.mp4', $result['mpeg4_url']);
    }

    public function testCreateAudio(): void
    {
        $inline = new Inline(InlineType::Audio);
        $result = $inline->id('audio_1')->fileId('123')->create();

        $this->assertEquals('audio', $result['type']);
        $this->assertEquals('123', $result['audio_file_id']);
    }

    public function testCreateVoice(): void
    {
        $inline = new Inline(InlineType::Voice);
        $result = $inline->id('voice_1')->fileId('123')->create();

        $this->assertEquals('voice', $result['type']);
        $this->assertEquals('123', $result['voice_file_id']);
    }

    public function testCreateDocument(): void
    {
        $inline = new Inline(InlineType::Document);
        $result = $inline->id('doc_1')->fileId('123')->mimeType('application/pdf')->create();

        $this->assertEquals('document', $result['type']);
        $this->assertEquals('123', $result['document_file_id']);
        $this->assertEquals('application/pdf', $result['mime_type']);
    }

    public function testCreateVenue(): void
    {
        $inline = new Inline(InlineType::Venue);
        $result = $inline
            ->coordinates(50.0, 50.0)
            ->title('Home')
            ->address('Baker St')
            ->create();

        $this->assertEquals('venue', $result['type']);
        $this->assertEquals(50.0, $result['latitude']);
        $this->assertEquals('Home', $result['title']);
        $this->assertEquals('Baker St', $result['address']);
    }
}